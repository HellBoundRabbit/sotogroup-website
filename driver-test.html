<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Portal - SOTO Routes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, deleteDoc, doc, query, orderBy, setDoc, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkXzYFC1jQcA6yw6qY1Ao3luEYU4Rd0yA",
            authDomain: "soto-routes.firebaseapp.com",
            projectId: "soto-routes",
            storageBucket: "soto-routes.firebasestorage.app",
            messagingSenderId: "440989695549",
            appId: "1:440989695549:web:0bce8b92a46f7f79953454",
            measurementId: "G-4E3G40QQ9L"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.firestore = db;
        window.auth = auth;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseGetDoc = getDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseDoc = doc;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseSetDoc = setDoc;
        window.firebaseWhere = where;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        
        console.log('Firebase initialized successfully!');
    </script>
    <script>
        tailwind.config = {
            plugins: {
                forms: {},
                containerQueries: {}
            }
        }
    </script>
    <style type="text/tailwindcss">
        :root {
            --primary-color: #0d7ff2;
            --success-color: #22c55e;
        }
    </style>
</head>
<body class="bg-[#111418] text-white" style='font-family: Inter, "Noto Sans", sans-serif;'>
    <div class="relative flex h-auto min-h-screen w-full flex-col dark group/design-root overflow-x-hidden">
        <div class="flex h-full grow flex-col">
            <!-- Header -->
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#283039] px-6 py-3">
                <div class="flex items-center gap-4">
                    <div class="size-8 text-white">
                        <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13.8261 17.4264C16.7203 18.1174 20.2244 18.5217 24 18.5217C27.7756 18.5217 31.2797 18.1174 34.1739 17.4264C36.9144 16.7722 39.9967 15.2331 41.3563 14.1648L24.8486 40.6391C24.4571 41.267 23.5429 41.267 23.1514 40.6391L6.64374 14.1648C8.00331 15.2331 11.0856 16.7722 13.8261 17.4264Z" fill="currentColor"></path>
                            <path clip-rule="evenodd" d="M39.998 12.236C39.9944 12.2537 39.9875 12.2845 39.9748 12.3294C39.9436 12.4399 39.8949 12.5741 39.8346 12.7175C39.8168 12.7597 39.7989 12.8007 39.7813 12.8398C38.5103 13.7113 35.9788 14.9393 33.7095 15.4811C30.9875 16.131 27.6413 16.5217 24 16.5217C20.3587 16.5217 17.0125 16.131 14.2905 15.4811C12.0012 14.9346 9.44505 13.6897 8.18538 12.8168C8.17384 12.7925 8.16216 12.767 8.15052 12.7408C8.09919 12.6249 8.05721 12.5114 8.02977 12.411C8.00356 12.3152 8.00039 12.2667 8.00004 12.2612C8.00004 12.261 8 12.2607 8.00004 12.2612C8.00004 12.2359 8.0104 11.9233 8.68485 11.3686C9.34546 10.8254 10.4222 10.2469 11.9291 9.72276C14.9242 8.68098 19.1919 8 24 8C28.8081 8 33.0758 8.68098 36.0709 9.72276C37.5778 10.2469 38.6545 10.8254 39.3151 11.3686C39.9006 11.8501 39.9857 12.1489 39.998 12.236ZM4.95178 15.2312L21.4543 41.6973C22.6288 43.5809 25.3712 43.5809 26.5457 41.6973L43.0534 15.223C43.0709 15.1948 43.0878 15.1662 43.104 15.1371L41.3563 14.1648C43.104 15.1371 43.1038 15.1374 43.104 15.1371L43.1051 15.135L43.1065 15.1325L43.1101 15.1261L43.1199 15.1082C43.1276 15.094 43.1377 15.0754 43.1497 15.0527C43.1738 15.0075 43.2062 14.9455 43.244 14.8701C43.319 14.7208 43.4196 14.511 43.5217 14.2683C43.6901 13.8679 44 13.0689 44 12.2609C44 10.5573 43.003 9.22254 41.8558 8.2791C40.6947 7.32427 39.1354 6.55361 37.385 5.94477C33.8654 4.72057 29.133 4 24 4C18.867 4 14.1346 4.72057 10.615 5.94478C8.86463 6.55361 7.30529 7.32428 6.14419 8.27911C4.99695 9.22255 3.99999 10.5573 3.99999 12.2609C3.99999 13.1275 4.29264 13.9078 4.49321 14.3607C4.60375 14.6102 4.71348 14.8196 4.79687 14.9689C4.83898 15.0444 4.87547 15.1065 4.9035 15.1529C4.91754 15.1762 4.92954 15.1957 4.93916 15.2111L4.94662 15.223L4.95178 15.2312ZM35.9868 18.996L24 38.22L12.0131 18.996C12.4661 19.1391 12.9179 19.2658 13.3617 19.3718C16.4281 20.1039 20.0901 20.5217 24 20.5217C27.9099 20.5217 31.5719 20.1039 34.6383 19.3718C35.082 19.2658 35.5339 19.1391 35.9868 18.996Z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold">Driver Portal</h2>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Profile Button -->
                    <div class="relative">
                        <button id="profileBtn" class="flex items-center gap-2 bg-[#283039] hover:bg-[#3a444e] text-white px-3 py-2 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span id="driverName">Driver</span>
                        </button>
                        
                        <!-- Profile Dropdown -->
                        <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-[#1a1f24] border border-[#283039] rounded-lg shadow-lg hidden z-50">
                            <div class="py-1">
                                <button onclick="showChangePassword()" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[#283039] transition-colors">
                                    Change Password
                                </button>
                                <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-[#283039] transition-colors">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 px-6 py-8">
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold mb-2">Set Your Availability</h1>
                        <p class="text-gray-400">Mark days you're unavailable for work</p>
                    </div>

                    <!-- Week Selection -->
                    <div class="bg-[#1a1f24] rounded-lg border border-[#283039] p-6 mb-6">
                        <h2 class="text-xl font-semibold mb-4">Choose Week</h2>
                        <div class="flex items-center gap-4">
                            <select id="weekSelect" class="bg-[#283039] border border-[#3a444e] text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Select a week...</option>
                            </select>
                        </div>
                        
                        <!-- Booked Days Off (moved under week title) -->
                        <div class="mt-4 pt-4 border-t border-[#283039]">
                            <h3 class="text-sm font-medium text-gray-300 mb-2">Your Booked Days Off</h3>
                            <div id="bookedDaysOff" class="text-sm">
                                <p class="text-gray-500">No days off booked yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Day Selection -->
                    <div id="daySelection" class="bg-[#1a1f24] rounded-lg border border-[#283039] p-6 mb-6 hidden">
                        <h2 class="text-xl font-semibold mb-4">Mark Days Off</h2>
                        <p class="text-gray-400 mb-4">Click to mark a day as unavailable (red), click again to unmark</p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <button class="day-btn bg-[#283039] hover:bg-[#3a444e] text-white px-6 py-4 rounded-lg transition-colors border-2 border-transparent" data-day="monday">
                                Monday
                            </button>
                            <button class="day-btn bg-[#283039] hover:bg-[#3a444e] text-white px-6 py-4 rounded-lg transition-colors border-2 border-transparent" data-day="tuesday">
                                Tuesday
                            </button>
                            <button class="day-btn bg-[#283039] hover:bg-[#3a444e] text-white px-6 py-4 rounded-lg transition-colors border-2 border-transparent" data-day="wednesday">
                                Wednesday
                            </button>
                            <button class="day-btn bg-[#283039] hover:bg-[#3a444e] text-white px-6 py-4 rounded-lg transition-colors border-2 border-transparent" data-day="thursday">
                                Thursday
                            </button>
                            <button class="day-btn bg-[#283039] hover:bg-[#3a444e] text-white px-6 py-4 rounded-lg transition-colors border-2 border-transparent" data-day="friday">
                                Friday
                            </button>
                        </div>
                        
                        <div class="mt-6 flex justify-center">
                            <button id="saveAvailabilityBtn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg transition-colors font-medium">
                                Save Availability
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-[#1a1f24] rounded-lg border border-[#283039] p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Change Password</h3>
                <button onclick="hideChangePassword()" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label for="currentPassword" class="block text-sm font-medium text-gray-300 mb-2">Current Password</label>
                    <input 
                        type="password" 
                        id="currentPassword" 
                        required 
                        class="w-full px-3 py-2 bg-[#283039] border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter current password"
                    >
                </div>
                
                <div>
                    <label for="newPassword" class="block text-sm font-medium text-gray-300 mb-2">New Password</label>
                    <input 
                        type="password" 
                        id="newPassword" 
                        required 
                        class="w-full px-3 py-2 bg-[#283039] border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter new password"
                    >
                </div>
                
                <div>
                    <label for="confirmPassword" class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        required 
                        class="w-full px-3 py-2 bg-[#283039] border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Confirm new password"
                    >
                </div>

                <button 
                    type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors"
                >
                    Change Password
                </button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let selectedWeek = null;
        let dayStates = {}; // Track day button states: null, 'unavailable'
        let bookedDaysOff = []; // Store booked days off

        // Wait for Firebase to be ready
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firestore && window.auth) {
                        console.log('Firebase is ready!');
                        resolve(true);
                    } else {
                        console.log('Waiting for Firebase...');
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Check driver authentication
        function checkDriverAuth() {
            const storedUser = localStorage.getItem('soto_user_identity');
            if (!storedUser) {
                window.location.href = '/pages/soto-routes-login.html';
                return false;
            }
            
            const userData = JSON.parse(storedUser);
            if (userData.role !== 'driver') {
                window.location.href = '/pages/soto-routes-login.html';
                return false;
            }
            
            return userData;
        }

        // Load driver information
        function loadDriverInfo(userData) {
            currentUser = userData;
            document.getElementById('driverName').textContent = userData.name || 'Driver';
            
            console.log('Driver info loaded:', currentUser);
            console.log('User data received:', userData);
        }

        // Generate week options (auto-generated on page load)
        function generateWeeks() {
            const weekSelect = document.getElementById('weekSelect');
            weekSelect.innerHTML = '<option value="">Select a week...</option>';
            
            const today = new Date();
            
            // Generate 12 weeks starting from current week
            for (let i = 0; i < 12; i++) {
                const weekDate = new Date(today);
                weekDate.setDate(today.getDate() + (i * 7));
                
                const weekNumber = getWeekNumber(weekDate);
                const year = weekDate.getFullYear();
                const weekStart = getWeekStart(weekDate);
                const weekEnd = getWeekEnd(weekDate);
                
                const option = document.createElement('option');
                option.value = `${year}-W${weekNumber.toString().padStart(2, '0')}`;
                option.textContent = `Week ${weekNumber}, ${year} (${formatDate(weekStart)} - ${formatDate(weekEnd)})`;
                
                if (i === 0) {
                    option.textContent += ' (Current Week)';
                }
                
                weekSelect.appendChild(option);
            }
        }

        // Display booked days off
        function displayBookedDaysOff() {
            const bookedDaysOffContainer = document.getElementById('bookedDaysOff');
            
            if (bookedDaysOff.length === 0) {
                bookedDaysOffContainer.innerHTML = '<p class="text-gray-500">No days off booked yet</p>';
                return;
            }
            
            // Group days off by week and sort them
            const groupedByWeek = {};
            bookedDaysOff.forEach(dayOff => {
                if (!groupedByWeek[dayOff.week]) {
                    groupedByWeek[dayOff.week] = [];
                }
                groupedByWeek[dayOff.week].push(dayOff);
            });
            
            bookedDaysOffContainer.innerHTML = '';
            
            Object.keys(groupedByWeek).forEach(week => {
                const weekDays = groupedByWeek[week].sort((a, b) => {
                    const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                    return dayOrder.indexOf(a.day.toLowerCase()) - dayOrder.indexOf(b.day.toLowerCase());
                });
                
                // Group consecutive days
                const consecutiveGroups = [];
                let currentGroup = [weekDays[0]];
                
                for (let i = 1; i < weekDays.length; i++) {
                    const currentDay = weekDays[i].day.toLowerCase();
                    const prevDay = weekDays[i-1].day.toLowerCase();
                    const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                    
                    const currentIndex = dayOrder.indexOf(currentDay);
                    const prevIndex = dayOrder.indexOf(prevDay);
                    
                    if (currentIndex === prevIndex + 1) {
                        // Consecutive day
                        currentGroup.push(weekDays[i]);
                    } else {
                        // Not consecutive, start new group
                        consecutiveGroups.push(currentGroup);
                        currentGroup = [weekDays[i]];
                    }
                }
                consecutiveGroups.push(currentGroup);
                
                // Create display for each group
                consecutiveGroups.forEach(group => {
                    const groupElement = document.createElement('div');
                    groupElement.className = 'flex items-center justify-between bg-red-900 bg-opacity-20 border border-red-700 rounded px-2 py-1 mb-1';
                    
                    let displayText = '';
                    if (group.length === 1) {
                        displayText = `${group[0].day} (${formatDateFromString(group[0].date)})`;
                    } else {
                        const firstDay = group[0].day;
                        const lastDay = group[group.length - 1].day;
                        displayText = `${firstDay} â†’ ${lastDay} (${formatDateFromString(group[0].date)} - ${formatDateFromString(group[group.length - 1].date)})`;
                    }
                    
                    groupElement.innerHTML = `
                        <span class="text-red-200 text-xs">${displayText}</span>
                        <button onclick="removeDayOffGroup([${group.map(d => `'${d.id}'`).join(',')}])" class="text-red-400 hover:text-red-300 ml-2">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    `;
                    bookedDaysOffContainer.appendChild(groupElement);
                });
            });
        }

        // Format date from Firebase date string (YYYY-MM-DD)
        function formatDateFromString(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });
        }

        // Remove day off
        function removeDayOff(dayOffId) {
            bookedDaysOff = bookedDaysOff.filter(dayOff => dayOff.id !== dayOffId);
            displayBookedDaysOff();
        }

        // Convert week and day to actual date - USE THE SAME LOGIC AS WEEK GENERATION
        function getDateFromWeekAndDay(weekString, dayName) {
            const [year, weekNum] = weekString.split('-W');
            const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            const dayIndex = dayOrder.indexOf(dayName.toLowerCase());
            
            // Use the EXACT same logic as the week generation
            // Find a date that would generate this week number
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // If it's the same year, use today as reference
            if (parseInt(year) === currentYear) {
                const currentWeek = getWeekNumber(today);
                const weekDiff = parseInt(weekNum) - currentWeek;
                
                // Calculate the target date
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + (weekDiff * 7));
                
                // Get the Monday of that week
                const weekStart = getWeekStart(targetDate);
                
                // Add the day offset
                const finalDate = new Date(weekStart);
                finalDate.setDate(weekStart.getDate() + dayIndex);
                
                console.log(`Week calculation: ${weekString} ${dayName} -> ${finalDate.toISOString().split('T')[0]}`);
                return finalDate;
            } else {
                // For different years, use January 1st as reference
                const jan1 = new Date(year, 0, 1);
                const jan1Week = getWeekNumber(jan1);
                const weekDiff = parseInt(weekNum) - jan1Week;
                
                const targetDate = new Date(jan1);
                targetDate.setDate(jan1.getDate() + (weekDiff * 7));
                
                const weekStart = getWeekStart(targetDate);
                const finalDate = new Date(weekStart);
                finalDate.setDate(weekStart.getDate() + dayIndex);
                
                console.log(`Week calculation: ${weekString} ${dayName} -> ${finalDate.toISOString().split('T')[0]}`);
                return finalDate;
            }
        }

        // Convert actual date back to week and day (for loading existing data)
        function getWeekAndDayFromDate(date) {
            // Use the EXACT same logic as the week generation
            const weekNum = getWeekNumber(date);
            const year = date.getFullYear();
            
            // Get day name (only Monday-Friday)
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const dayIndex = date.getDay() === 0 ? 6 : date.getDay() - 1; // Convert Sunday=0 to Sunday=6
            const dayName = dayNames[dayIndex] || 'Monday'; // Default to Monday if not a weekday
            
            const result = {
                week: `${year}-W${weekNum.toString().padStart(2, '0')}`,
                day: dayName
            };
            
            console.log(`Date conversion: ${date.toISOString().split('T')[0]} -> ${result.week} ${result.day}`);
            
            return result;
        }

        // Load booked days off from Firebase Calendar collection
        async function loadBookedDaysOff() {
            try {
                await waitForFirebase();
                
                console.log('Loading days off for driver:', currentUser.uid);
                console.log('Driver name:', currentUser.name);
                
                // First, let's check all calendar documents to see what's there
                const allCalendarQuery = window.firebaseQuery(window.firebaseCollection(window.firestore, 'calendar'));
                const allCalendarSnapshot = await window.firebaseGetDocs(allCalendarQuery);
                
                console.log('Total calendar documents found:', allCalendarSnapshot.size);
                
                allCalendarSnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('Calendar document:', doc.id, data);
                    
                    // Check if this driver is in the driversOff array
                    const driverInDoc = data.driversOff?.find(driver => driver.driverId === currentUser.uid);
                    if (driverInDoc) {
                        console.log('Found driver in document:', doc.id, driverInDoc);
                    }
                });
                
                // Since array-contains doesn't work reliably with objects, let's process all documents
                // and filter manually (we already have allCalendarSnapshot from above)
                console.log('Processing all calendar documents to find driver...');
                
                bookedDaysOff = [];
                
                allCalendarSnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('Processing document:', doc.id, data);
                    
                    const driverOffData = data.driversOff.find(driver => driver.driverId === currentUser.uid);
                    
                    if (driverOffData) {
                        console.log('Found driver data:', driverOffData);
                        
                        // Convert date back to week and day format
                        const date = new Date(data.date);
                        const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
                        
                        // Only include Monday-Friday (1-5)
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                            const weekAndDay = getWeekAndDayFromDate(date);
                            
                            console.log('Converted date:', data.date, 'to week/day:', weekAndDay);
                            
                            bookedDaysOff.push({
                                id: `${weekAndDay.week}-${weekAndDay.day.toLowerCase()}`,
                                day: weekAndDay.day,
                                week: weekAndDay.week,
                                date: data.date,
                                driverId: currentUser.uid,
                                driverName: currentUser.name,
                                savedAt: data.lastUpdated,
                                firebaseId: doc.id
                            });
                        } else {
                            console.log('Skipping weekend date:', data.date);
                        }
                    }
                });
                
                console.log('Final booked days off array:', bookedDaysOff);
                console.log('Loaded', bookedDaysOff.length, 'days off from calendar');
                displayBookedDaysOff();
                
                // Update day buttons to show red for already booked days
                updateDayButtonsForCurrentWeek();
                
            } catch (error) {
                console.error('Error loading booked days off:', error);
                alert('Error loading booked days off: ' + error.message);
            }
        }

        // Remove day off
        async function removeDayOff(dayOffId) {
            try {
                await waitForFirebase();
                
                const dayOff = bookedDaysOff.find(d => d.id === dayOffId);
                if (!dayOff) return;
                
                // Get the calendar document for this date
                const calendarDoc = await window.firebaseGetDoc(window.firebaseDoc(window.firestore, "calendar", dayOff.date));
                
                if (calendarDoc.exists()) {
                    const data = calendarDoc.data();
                    const driversOff = data.driversOff.filter(driver => driver.driverId !== currentUser.uid);
                    
                    if (driversOff.length === 0) {
                        // No more drivers off on this day, delete the calendar document
                        await window.firebaseDeleteDoc(window.firebaseDoc(window.firestore, "calendar", dayOff.date));
                    } else {
                        // Update the calendar document with remaining drivers
                        await window.firebaseSetDoc(window.firebaseDoc(window.firestore, "calendar", dayOff.date), {
                            ...data,
                            driversOff: driversOff,
                            lastUpdated: new Date()
                        });
                    }
                }
                
                // Remove from local array
                bookedDaysOff = bookedDaysOff.filter(d => d.id !== dayOffId);
                displayBookedDaysOff();
                
            } catch (error) {
                console.error('Error removing day off:', error);
                alert('Error removing day off. Please try again.');
            }
        }

        // Remove day off group
        async function removeDayOffGroup(dayOffIds) {
            try {
                await waitForFirebase();
                
                for (const dayOffId of dayOffIds) {
                    const dayOff = bookedDaysOff.find(d => d.id === dayOffId);
                    if (!dayOff) continue;
                    
                    // Get the calendar document for this date
                    const calendarDoc = await window.firebaseGetDoc(window.firebaseDoc(window.firestore, "calendar", dayOff.date));
                    
                    if (calendarDoc.exists()) {
                        const data = calendarDoc.data();
                        const driversOff = data.driversOff.filter(driver => driver.driverId !== currentUser.uid);
                        
                        if (driversOff.length === 0) {
                            // No more drivers off on this day, delete the calendar document
                            await window.firebaseDeleteDoc(window.firebaseDoc(window.firestore, "calendar", dayOff.date));
                        } else {
                            // Update the calendar document with remaining drivers
                            await window.firebaseSetDoc(window.firebaseDoc(window.firestore, "calendar", dayOff.date), {
                                ...data,
                                driversOff: driversOff,
                                lastUpdated: new Date()
                            });
                        }
                    }
                }
                
                // Remove from local array
                bookedDaysOff = bookedDaysOff.filter(dayOff => !dayOffIds.includes(dayOff.id));
                displayBookedDaysOff();
                
            } catch (error) {
                console.error('Error removing day off group:', error);
                alert('Error removing day off group. Please try again.');
            }
        }

        // Get week number (ISO week calculation)
        function getWeekNumber(date) {
            const year = date.getFullYear();
            
            // Use the same approach as the date conversion
            // Week 1 is the first week that contains at least 4 days of the new year
            const jan4 = new Date(year, 0, 4); // January 4th is always in week 1
            
            // Find the Monday of week 1
            const dayOfWeek = jan4.getDay();
            const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            const week1Monday = new Date(jan4);
            week1Monday.setDate(jan4.getDate() - daysToMonday);
            
            // Calculate week number
            const daysDiff = Math.floor((date - week1Monday) / (1000 * 60 * 60 * 24));
            const weekNum = Math.floor(daysDiff / 7) + 1;
            
            return weekNum;
        }

        // Get week start (Monday) - ISO week
        function getWeekStart(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const weekStart = new Date(date);
            weekStart.setDate(diff);
            return weekStart;
        }

        // Get week end (Sunday) - ISO week
        function getWeekEnd(date) {
            const weekStart = getWeekStart(new Date(date));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return weekEnd;
        }

        // Format date
        function formatDate(date) {
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit' });
        }

        // Handle week selection
        function handleWeekSelection() {
            const weekSelect = document.getElementById('weekSelect');
            const daySelection = document.getElementById('daySelection');
            
            if (weekSelect.value) {
                selectedWeek = weekSelect.value;
                daySelection.classList.remove('hidden');
                resetDayStates();
                
                // Update day buttons to show already booked days as red
                updateDayButtonsForCurrentWeek();
            } else {
                daySelection.classList.add('hidden');
                selectedWeek = null;
            }
        }

        // Reset day states
        function resetDayStates() {
            dayStates = {};
            const dayButtons = document.querySelectorAll('.day-btn');
            dayButtons.forEach(btn => {
                // Don't reset if the day is already booked off
                const day = btn.dataset.day;
                const selectedWeek = document.getElementById('weekSelect').value;
                const dayId = `${selectedWeek}-${day.toLowerCase()}`;
                const isAlreadyBooked = bookedDaysOff.some(dayOff => dayOff.id === dayId);
                
                if (!isAlreadyBooked) {
                    btn.className = 'day-btn bg-[#283039] hover:bg-[#3a444e] text-white px-6 py-4 rounded-lg transition-colors border-2 border-transparent';
                }
            });
        }

        // Handle day button clicks (only OFF/neutral)
        function handleDayClick(event) {
            const day = event.target.dataset.day;
            const selectedWeek = document.getElementById('weekSelect').value;
            const dayId = `${selectedWeek}-${day.toLowerCase()}`;
            
            // Check if this day is already booked off (should not be clickable)
            const isAlreadyBooked = bookedDaysOff.some(dayOff => dayOff.id === dayId);
            
            if (isAlreadyBooked) {
                // Day is already booked off, don't allow changes
                return;
            }
            
            if (!dayStates[day]) {
                // First click: Unavailable (red)
                dayStates[day] = 'unavailable';
                event.target.className = 'day-btn bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-lg transition-colors border-2 border-red-400';
            } else {
                // Second click: Reset to neutral
                dayStates[day] = null;
                event.target.className = 'day-btn bg-[#283039] hover:bg-[#3a444e] text-white px-6 py-4 rounded-lg transition-colors border-2 border-transparent';
            }
        }

        // Update day buttons to show red for already booked days in current week
        function updateDayButtonsForCurrentWeek() {
            const selectedWeek = document.getElementById('weekSelect').value;
            if (!selectedWeek) return;
            
            const dayButtons = document.querySelectorAll('.day-btn');
            
            dayButtons.forEach(button => {
                const day = button.dataset.day;
                const dayId = `${selectedWeek}-${day.toLowerCase()}`;
                
                // Check if this day is already booked off
                const isAlreadyBooked = bookedDaysOff.some(dayOff => dayOff.id === dayId);
                
                if (isAlreadyBooked) {
                    // Day is already booked off - make it red and non-clickable
                    dayStates[day] = 'unavailable';
                    button.className = 'day-btn bg-red-600 text-white px-6 py-4 rounded-lg transition-colors border-2 border-red-400 cursor-not-allowed opacity-75';
                    button.title = 'Already booked off - cannot change';
                } else {
                    // Day is available - reset to normal state
                    dayStates[day] = null;
                    button.className = 'day-btn bg-[#283039] hover:bg-[#3a444e] text-white px-6 py-4 rounded-lg transition-colors border-2 border-transparent';
                    button.title = '';
                }
            });
        }

        // Save availability
        async function saveAvailability() {
            if (!selectedWeek) {
                alert('Please select a week first.');
                return;
            }

            try {
                await waitForFirebase();

                // Add unavailable days to booked days off
                const newDaysOff = [];
                Object.keys(dayStates).forEach(day => {
                    if (dayStates[day] === 'unavailable') {
                        const dayOffId = `${selectedWeek}-${day}`;
                        const existingDayOff = bookedDaysOff.find(d => d.id === dayOffId);
                        
                        if (!existingDayOff) {
                            const dayOffData = {
                                id: dayOffId,
                                day: day.charAt(0).toUpperCase() + day.slice(1),
                                week: selectedWeek,
                                driverId: currentUser.uid,
                                driverName: currentUser.name,
                                savedAt: new Date()
                            };
                            
                            newDaysOff.push(dayOffData);
                            bookedDaysOff.push(dayOffData);
                        }
                    }
                });

                // Save to Firebase - Calendar collection approach
                if (newDaysOff.length > 0) {
                    console.log('Saving new days off:', newDaysOff);
                    
                    for (const dayOff of newDaysOff) {
                        // Convert week and day to actual date
                        const actualDate = getDateFromWeekAndDay(dayOff.week, dayOff.day);
                        const dayOfWeek = actualDate.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
                        
                        // Only save Monday-Friday (1-5)
                        if (dayOfWeek < 1 || dayOfWeek > 5) {
                            console.log(`Skipping weekend day: ${dayOff.week} ${dayOff.day}`);
                            continue;
                        }
                        
                        const dateString = actualDate.toISOString().split('T')[0]; // YYYY-MM-DD
                        
                        console.log(`Converting ${dayOff.week} ${dayOff.day} to date: ${dateString}`);
                        
                        // Check if calendar document exists for this date
                        const calendarDoc = await window.firebaseGetDoc(window.firebaseDoc(window.firestore, "calendar", dateString));
                        
                        if (calendarDoc.exists()) {
                            console.log('Calendar document exists for', dateString);
                            // Document exists, add driver to existing driversOff array
                            const existingData = calendarDoc.data();
                            const driversOff = existingData.driversOff || [];
                            
                            console.log('Existing drivers off:', driversOff);
                            
                            // Check if driver is already in the list
                            const driverExists = driversOff.some(driver => driver.driverId === currentUser.uid);
                            
                            if (!driverExists) {
                                driversOff.push({
                                    driverId: currentUser.uid,
                                    driverName: currentUser.name
                                });
                                
                                console.log('Adding driver to existing document:', driversOff);
                                
                                // Update the calendar document
                                await window.firebaseSetDoc(window.firebaseDoc(window.firestore, "calendar", dateString), {
                                    ...existingData,
                                    driversOff: driversOff,
                                    lastUpdated: new Date()
                                });
                            } else {
                                console.log('Driver already exists in document');
                            }
                        } else {
                            console.log('Creating new calendar document for', dateString);
                            // Document doesn't exist, create new one
                            const newDocData = {
                                date: dateString,
                                dayName: dayOff.day,
                                week: dayOff.week,
                                driversOff: [{
                                    driverId: currentUser.uid,
                                    driverName: currentUser.name
                                }],
                                officeId: currentUser.officeId,
                                lastUpdated: new Date()
                            };
                            
                            console.log('New document data:', newDocData);
                            
                            await window.firebaseSetDoc(window.firebaseDoc(window.firestore, "calendar", dateString), newDocData);
                        }
                    }
                }

                const availability = {
                    week: selectedWeek,
                    days: dayStates,
                    driverId: currentUser.uid,
                    driverName: currentUser.name,
                    savedAt: new Date()
                };

                console.log('Saving availability:', availability);
                console.log('Booked days off:', bookedDaysOff);
                
                // Show success message
                alert('Days off saved successfully to Firebase!');
                
                // Reload the booked days off to get the latest data from Firebase
                await loadBookedDaysOff();
                
                // Reset form
                document.getElementById('weekSelect').value = '';
                document.getElementById('daySelection').classList.add('hidden');
                selectedWeek = null;
                resetDayStates();

            } catch (error) {
                console.error('Error saving days off:', error);
                alert('Error saving days off. Please try again.');
            }
        }

        // Profile dropdown functions
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('hidden');
        }

        function showChangePassword() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
            document.getElementById('profileDropdown').classList.add('hidden');
        }

        function hideChangePassword() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordForm').reset();
        }

        // Change password
        function handleChangePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long.');
                return;
            }
            
            // In a real app, this would update the password in Firebase
            console.log('Changing password for user:', currentUser.uid);
            alert('Password changed successfully!');
            
            hideChangePassword();
        }


        // Logout function
        function logout() {
            localStorage.removeItem('soto_user_identity');
            window.location.href = '/pages/soto-routes-login.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            const userData = checkDriverAuth();
            if (userData) {
                loadDriverInfo(userData);
                
                // Load booked days off from Firebase
                await loadBookedDaysOff();
            }

            // Auto-generate weeks on page load
            generateWeeks();

            // Event listeners
            document.getElementById('profileBtn').addEventListener('click', toggleProfileDropdown);
            document.getElementById('weekSelect').addEventListener('change', handleWeekSelection);
            document.getElementById('saveAvailabilityBtn').addEventListener('click', saveAvailability);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);

            // Day button event listeners
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', handleDayClick);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const profileBtn = document.getElementById('profileBtn');
                const dropdown = document.getElementById('profileDropdown');
                
                if (!profileBtn.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>