<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses - SOTO Routes</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/logos/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/logos/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/logos/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/logos/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            plugins: {
                forms: {},
                containerQueries: {}
            }
        }
    </script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, where, updateDoc, doc, deleteDoc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkXzYFC1jQcA6yw6qY1Ao3luEYU4Rd0yA",
            authDomain: "soto-routes.firebaseapp.com",
            projectId: "soto-routes",
            storageBucket: "soto-routes.firebasestorage.app",
            messagingSenderId: "440989695549",
            appId: "1:440989695549:web:0bce8b92a46f7f79953454",
            measurementId: "G-4E3G40QQ9L"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseLimit = limit;
        window.firebaseWhere = where;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDoc = doc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.serverTimestamp = serverTimestamp;
        
        // Make individual functions globally accessible
        window.query = query;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.where = where;
        window.orderBy = orderBy;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.signOut = signOut;
        
        // Make auth object globally accessible
        window.auth = auth;
        
        console.log('Firebase initialized successfully!');
        
        // Initialize the app after Firebase is ready
        initializeExpensesApp();
    </script>
    <style>
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }
        
        .license-plate {
            background: #FFD500;
            color: #000;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 2px;
            padding: 6px 12px;
            border-radius: 4px;
            border: 2px solid #000;
            display: inline-block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        @keyframes flash {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .flash-red {
            animation: flash 1s infinite;
        }
    </style>
</head>
<body class="bg-[#111418] text-white" style='font-family: Inter, "Noto Sans", sans-serif;'>
<div class="relative flex h-auto min-h-screen w-full flex-col dark group/design-root overflow-x-hidden">
<div class="flex h-full grow flex-col">

<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#283039] px-6 py-3">
<div class="flex items-center gap-4">
<div class="size-8 text-[var(--primary-color)]">
<svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M13.8261 17.4264C16.7203 18.1174 20.2244 18.5217 24 18.5217C27.7756 18.5217 31.2797 18.1174 34.1739 17.4264C36.9144 16.7722 39.9967 15.2331 41.3563 14.1648L24.8486 40.6391C24.4571 41.267 23.5429 41.267 23.1514 40.6391L6.64374 14.1648C8.00331 15.2331 11.0856 16.7722 13.8261 17.4264Z" fill="currentColor"></path>
<path clip-rule="evenodd" d="M39.998 12.236C39.9944 12.2537 39.9875 12.2845 39.9748 12.3294C39.9436 12.4399 39.8949 12.5741 39.8346 12.7175C39.8168 12.7597 39.7989 12.8007 39.7813 12.8398C38.5103 13.7113 35.9788 14.9393 33.7095 15.4811C30.9875 16.131 27.6413 16.5217 24 16.5217C20.3587 16.5217 17.0125 16.131 14.2905 15.4811C12.0012 14.9346 9.44505 13.6897 8.18538 12.8168C8.17384 12.7925 8.16216 12.767 8.15052 12.7408C8.09919 12.6249 8.05721 12.5114 8.02977 12.411C8.00356 12.3152 8.00039 12.2667 8.00004 12.2612C8.00004 12.261 8 12.2607 8.00004 12.2612C8.00004 12.2359 8.0104 11.9233 8.68485 11.3686C9.34546 10.8254 10.4222 10.2469 11.9291 9.72276C14.9242 8.68098 19.1919 8 24 8C28.8081 8 33.0758 8.68098 36.0709 9.72276C37.5778 10.2469 38.6545 10.8254 39.3151 11.3686C39.9006 11.8501 39.9857 12.1489 39.998 12.236ZM4.95178 15.2312L21.4543 41.6973C22.6288 43.5809 25.3712 43.5809 26.5457 41.6973L43.0534 15.223C43.0709 15.1948 43.0878 15.1662 43.104 15.1371L41.3563 14.1648C43.104 15.1371 43.1038 15.1374 43.104 15.1371L43.1051 15.135L43.1065 15.1325L43.1101 15.1261L43.1199 15.1082C43.1276 15.094 43.1377 15.0754 43.1497 15.0527C43.1738 15.0075 43.2062 14.9455 43.244 14.8701C43.319 14.7208 43.4196 14.511 43.5217 14.2683C43.6901 13.8679 44 13.0689 44 12.2609C44 10.5573 43.003 9.22254 41.8558 8.2791C40.6947 7.32427 39.1354 6.55361 37.385 5.94477C33.8654 4.72057 29.133 4 24 4C18.867 4 14.1346 4.72057 10.615 5.94478C8.86463 6.55361 7.30529 7.32428 6.14419 8.27911C4.99695 9.22255 3.99999 10.5573 3.99999 12.2609C3.99999 13.1275 4.29264 13.9078 4.49321 14.3607C4.60375 14.6102 4.71348 14.8196 4.79687 14.9689C4.83898 15.0444 4.87547 15.1065 4.9035 15.1529C4.91754 15.1762 4.92954 15.1957 4.93916 15.2111L4.94662 15.223L4.95178 15.2312ZM35.9868 18.996L24 38.22L12.0131 18.996C12.4661 19.1391 12.9179 19.2658 13.3617 19.3718C16.4281 20.1039 20.0901 20.5217 24 20.5217C27.9099 20.5217 31.5719 20.1039 34.6383 19.3718C35.082 19.2658 35.5339 19.1391 35.9868 18.996Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-xl font-bold">SOTO Routes</h2>
</div>
<nav class="flex flex-1 justify-center gap-2">
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/soto-lp.html">Routes</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/optimisation.html">Optimisation</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/drivers.html">Drivers</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/availability.html">Availability</a>
<a class="bg-[#283039] text-white text-sm font-medium rounded-md px-4 py-2" href="/pages/expenses.html">Expenses</a>
</nav>
<div class="flex items-center gap-4">
<button class="flex items-center justify-center rounded-full h-10 w-10 bg-[#283039] hover:bg-[#3a444e] transition-colors" onclick="showNotifications()">
<span class="material-symbols-outlined text-xl">notifications</span>
</button>
<button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm" onclick="logout()">
Logout
</button>
<div class="relative">
    <button onclick="toggleProfileDropdown()" class="flex items-center justify-center rounded-full size-10 bg-black overflow-hidden hover:ring-2 hover:ring-blue-500 transition-all cursor-pointer">
        <img src="/assets/logos/c-logo.svg" alt="C Logo" class="w-full h-full object-cover">
    </button>
    <!-- Profile Dropdown -->
    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[#1a1f24] border border-[#283039] rounded-lg shadow-lg z-50">
        <button onclick="showChangePassword()" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[#283039] transition-colors rounded-t-lg">
            <span class="material-symbols-outlined inline-block align-middle text-base mr-2">lock</span>
            Change Password
        </button>
        <button onclick="viewUsage()" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[#283039] transition-colors rounded-b-lg">
            <span class="material-symbols-outlined inline-block align-middle text-base mr-2">calendar_month</span>
            View Usage
        </button>
    </div>
</div>
</div>
</header>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="flex items-center gap-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <span class="text-gray-400">Loading...</span>
        </div>
    </div>


    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- Page Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold mb-2">Expense Management</h1>
            <p class="text-gray-400">Review and manage driver expense submissions</p>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-800 mb-6">
            <div class="flex gap-8">
                <button onclick="switchTab('pending')" id="tab-pending" class="tab-active py-3 px-1 font-semibold transition-colors">
                    Pending <span id="pending-count" class="ml-2 px-2 py-0.5 bg-orange-500 text-white text-xs rounded-full">0</span>
                </button>
                <button onclick="switchTab('validated')" id="tab-validated" class="py-3 px-1 text-gray-400 hover:text-white font-semibold transition-colors">
                    Validated <span id="validated-count" class="ml-2 px-2 py-0.5 bg-blue-500 text-white text-xs rounded-full">0</span>
                </button>
                <button onclick="switchTab('paid')" id="tab-paid" class="py-3 px-1 text-gray-400 hover:text-white font-semibold transition-colors">
                    Paid <span id="paid-count" class="ml-2 px-2 py-0.5 bg-green-500 text-white text-xs rounded-full">0</span>
                </button>
                <button onclick="switchTab('returned')" id="tab-returned" class="py-3 px-1 text-gray-400 hover:text-white font-semibold transition-colors">
                    Returned <span id="returned-count" class="ml-2 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">0</span>
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="content-pending" class="tab-content">
            <div id="pending-list" class="space-y-3"></div>
            <div id="pending-empty" class="hidden text-center py-16 text-gray-500">
                <span class="material-symbols-outlined text-6xl mb-4">check_circle</span>
                <p class="text-xl">No pending expenses</p>
            </div>
        </div>

        <div id="content-validated" class="tab-content hidden">
            <div id="validated-list" class="space-y-3"></div>
            <div id="validated-empty" class="hidden text-center py-16 text-gray-500">
                <span class="material-symbols-outlined text-6xl mb-4">task_alt</span>
                <p class="text-xl">No validated expenses</p>
            </div>
        </div>

        <div id="content-paid" class="tab-content hidden">
            <div id="paid-list" class="space-y-3"></div>
            <div id="paid-empty" class="hidden text-center py-16 text-gray-500">
                <span class="material-symbols-outlined text-6xl mb-4">payments</span>
                <p class="text-xl">No paid expenses</p>
            </div>
        </div>

        <div id="content-returned" class="tab-content hidden">
            <div id="returned-list" class="space-y-3"></div>
            <div id="returned-empty" class="hidden text-center py-16 text-gray-500">
                <span class="material-symbols-outlined text-6xl mb-4">undo</span>
                <p class="text-xl">No returned expenses</p>
            </div>
        </div>

    </div>

    <!-- Batch Detail Modal -->
    <div id="batchModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-[#1a1f24] rounded-lg w-full max-w-4xl">
                
                <!-- Modal Header -->
                <div class="border-b border-gray-800 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold">Expense Batch Details</h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="p-6">
                    
                    <!-- Batch Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-[#283039] rounded-lg p-4">
                            <label class="text-sm text-gray-400 block mb-1">Driver</label>
                            <p id="modal-driver" class="text-lg font-semibold"></p>
                        </div>
                        <div class="bg-[#283039] rounded-lg p-4">
                            <label class="text-sm text-gray-400 block mb-1">Registration</label>
                            <div id="modal-reg" class="license-plate text-lg"></div>
                        </div>
                        <div class="bg-[#283039] rounded-lg p-4">
                            <label class="text-sm text-gray-400 block mb-1">Total Amount</label>
                            <p id="modal-total" class="text-lg font-semibold text-green-500"></p>
                        </div>
                        <div class="bg-[#283039] rounded-lg p-4">
                            <label class="text-sm text-gray-400 block mb-1">Submitted</label>
                            <p id="modal-date" class="text-lg"></p>
                        </div>
                    </div>

                    <!-- Return Notes (if applicable) -->
                    <div id="modal-return-notes" class="hidden bg-red-900 bg-opacity-20 border border-red-500 rounded-lg p-4 mb-6">
                        <label class="text-sm text-red-400 block mb-2">Return Reason</label>
                        <p id="modal-return-text" class="text-white"></p>
                    </div>

                    <!-- Expenses List -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3">Expenses</h3>
                        <div id="modal-expenses" class="space-y-2"></div>
                    </div>

                    <!-- Actions -->
                    <div id="modal-actions" class="flex gap-3">
                        <!-- Actions will be added based on status -->
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Return Modal -->
    <div id="returnModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50">
        <div class="min-h-screen px-4 py-8 flex items-center justify-center">
            <div class="bg-[#1a1f24] rounded-lg w-full max-w-lg">
                <div class="border-b border-gray-800 px-6 py-4">
                    <h2 class="text-xl font-semibold">Return Expense Batch</h2>
                </div>
                <div class="p-6">
                    <label class="text-sm text-gray-400 block mb-2">Reason for Return</label>
                    <textarea 
                        id="returnReason" 
                        rows="4" 
                        class="w-full bg-[#283039] text-white px-4 py-3 rounded-lg border border-gray-700 focus:border-red-500 focus:outline-none"
                        placeholder="Explain why this batch is being returned..."
                    ></textarea>
                    <div class="flex gap-3 mt-4">
                        <button onclick="closeReturnModal()" class="flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            Cancel
                        </button>
                        <button onclick="confirmReturn()" class="flex-1 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                            Return Batch
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Viewer Modal -->
    <div id="photoViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50">
        <div class="w-full h-full flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-3 bg-black bg-opacity-50">
                <button onclick="closePhotoViewer()" class="text-white hover:text-gray-300 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h3 class="text-white font-semibold">View Photos</h3>
                <div class="w-8"></div>
            </div>
            
            <!-- Photo Grid -->
            <div id="photoViewerGrid" class="flex-1 overflow-y-auto p-4">
                <!-- Photos will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allBatches = [];
        let currentBatch = null;
        let activeTab = 'pending';

        // Initialize function
        function initializeExpensesApp() {
            console.log('Initializing app...');
            
            // Use localStorage instead of Firebase Auth for faster loading
            try {
                const storedUser = localStorage.getItem('soto_user_identity');
                if (!storedUser) {
                    console.log('No user identity found, redirecting to login');
                    window.location.href = '/pages/soto-routes-login.html';
                    return;
                }

                const userData = JSON.parse(storedUser);
                currentUser = { uid: userData.uid, ...userData };
                console.log('Current user:', currentUser);
                
                // Only office and admin can access
                if (currentUser.role !== 'office' && currentUser.role !== 'admin') {
                    alert('Access denied. This page is for office staff only.');
                    window.location.href = '/pages/soto-routes-login.html';
                    return;
                }

                console.log('Loading expense batches...');
                loadAllBatches().then(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    console.log('Loading complete!');
                });
                
            } catch (error) {
                console.error('Error loading user data:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                alert('Error loading user data: ' + error.message);
            }
        }

        // Load all expense batches
        async function loadAllBatches() {
            try {
                console.log('Loading expense batches for officeId:', currentUser.officeId);
                
                // Load batches and expenses in parallel (fixes N+1 query problem)
                const [batchesSnapshot, expensesSnapshot] = await Promise.all([
                    window.getDocs(window.query(
                        window.collection(window.db, 'expenseBatches'),
                        window.where('officeId', '==', currentUser.officeId)
                    )),
                    window.getDocs(window.query(
                        window.collection(window.db, 'expenses'),
                        window.where('officeId', '==', currentUser.officeId)
                    ))
                ]);
                
                console.log('Found batches:', batchesSnapshot.docs.length);
                console.log('Found expenses:', expensesSnapshot.docs.length);
                
                allBatches = [];

                // Group expenses by batchId for efficient lookup
                const expensesByBatch = {};
                expensesSnapshot.docs.forEach(expDoc => {
                    const expData = { id: expDoc.id, ...expDoc.data() };
                    const batchId = expData.batchId;
                    if (batchId) {
                        if (!expensesByBatch[batchId]) {
                            expensesByBatch[batchId] = [];
                        }
                        expensesByBatch[batchId].push(expData);
                    }
                });

                // Process batches and attach their expenses
                batchesSnapshot.docs.forEach(doc => {
                    const batchData = { id: doc.id, ...doc.data() };
                    batchData.expenses = expensesByBatch[doc.id] || [];
                    allBatches.push(batchData);
                });

                // Sort by updatedAt descending (client-side)
                allBatches.sort((a, b) => {
                    const aTime = a.updatedAt?.toDate ? a.updatedAt.toDate().getTime() : 0;
                    const bTime = b.updatedAt?.toDate ? b.updatedAt.toDate().getTime() : 0;
                    return bTime - aTime; // Descending order
                });

                console.log('Total batches loaded:', allBatches.length);
                updateCounts();
                displayBatches();
            } catch (error) {
                console.error('Error loading batches:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                alert('Error loading expense batches: ' + error.message);
            }
        }

        // Update counts
        function updateCounts() {
            const pending = allBatches.filter(b => b.status === 'pending').length;
            const validated = allBatches.filter(b => b.status === 'validated').length;
            const paid = allBatches.filter(b => b.status === 'paid').length;
            const returned = allBatches.filter(b => b.status === 'returned').length;

            document.getElementById('pending-count').textContent = pending;
            document.getElementById('validated-count').textContent = validated;
            document.getElementById('paid-count').textContent = paid;
            document.getElementById('returned-count').textContent = returned;
        }

        // Switch tab
        function switchTab(tab) {
            activeTab = tab;
            
            // Update tab styles
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active', 'text-blue-500');
                btn.classList.add('text-gray-400');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active', 'text-blue-500');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-400');

            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');

            displayBatches();
        }

        // Calculate working hours between two dates (8am-5pm Mon-Fri only)
        function calculateWorkingHours(startDate, endDate) {
            let currentDate = new Date(startDate);
            let workingHours = 0;
            
            while (currentDate < endDate) {
                const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const hour = currentDate.getHours();
                
                // Check if it's a weekday (Monday = 1 to Friday = 5)
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    // Check if it's within working hours (8am to 5pm)
                    if (hour >= 8 && hour < 17) {
                        workingHours += 1;
                    }
                }
                
                // Move to next hour
                currentDate.setHours(currentDate.getHours() + 1);
            }
            
            return workingHours;
        }
        
        // Get timer color based on working hours
        function getTimerColor(hours) {
            if (hours <= 6) return 'text-green-500';
            if (hours <= 18) return 'text-orange-500';
            return 'text-red-500';
        }
        
        // Get timer class based on working hours (for flashing)
        function getTimerClass(hours) {
            if (hours > 24) return 'text-red-500 flash-red';
            return '';
        }
        
        // Display batches
        function displayBatches() {
            let filtered = allBatches.filter(b => b.status === activeTab);
            
            // Sort pending by oldest to newest
            if (activeTab === 'pending') {
                filtered.sort((a, b) => {
                    const aTime = a.submittedAt?.toDate ? a.submittedAt.toDate().getTime() : 0;
                    const bTime = b.submittedAt?.toDate ? b.submittedAt.toDate().getTime() : 0;
                    return aTime - bTime; // Ascending order (oldest first)
                });
            }
            
            const list = document.getElementById(`${activeTab}-list`);
            const empty = document.getElementById(`${activeTab}-empty`);

            if (filtered.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                list.innerHTML = filtered.map(batch => {
                    const date = batch.submittedAt?.toDate ? batch.submittedAt.toDate() : new Date();
                    
                    // Calculate working hours for pending expenses
                    let timerHTML = '';
                    if (activeTab === 'pending') {
                        const workingHours = calculateWorkingHours(date, new Date());
                        const color = getTimerColor(workingHours);
                        const flashClass = getTimerClass(workingHours);
                        timerHTML = `<div class="text-xs ${color} ${flashClass} font-semibold mt-1">${workingHours}h</div>`;
                    }
                    
                    return `
                        <div onclick="openBatchDetail('${batch.id}')" class="bg-[#1a1f24] border border-gray-800 hover:border-gray-700 rounded-lg p-4 cursor-pointer transition-colors">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <p class="font-semibold text-lg mb-1">${batch.driverName || 'Unknown Driver'}</p>
                                    <p class="text-sm text-gray-400">${batch.driverEmail || ''}</p>
                                    ${timerHTML}
                                </div>
                                <div class="license-plate">${batch.registration}</div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400 text-sm">${batch.expenses?.length || 0} expense${batch.expenses?.length !== 1 ? 's' : ''} • ${date.toLocaleDateString()}</span>
                                <span class="text-green-500 font-semibold text-xl">£${batch.totalAmount?.toFixed(2) || '0.00'}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Open batch detail
        function openBatchDetail(batchId) {
            currentBatch = allBatches.find(b => b.id === batchId);
            if (!currentBatch) return;

            console.log('Opening batch:', currentBatch);
            console.log('Driver name:', currentBatch.driverName);
            console.log('Expenses:', currentBatch.expenses);

            const date = currentBatch.submittedAt?.toDate ? currentBatch.submittedAt.toDate() : new Date();
            
            document.getElementById('modal-driver').textContent = currentBatch.driverName || 'Unknown Driver';
            document.getElementById('modal-reg').textContent = currentBatch.registration;
            document.getElementById('modal-total').textContent = `£${currentBatch.totalAmount?.toFixed(2) || '0.00'}`;
            document.getElementById('modal-date').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

            // Show return notes if returned
            if (currentBatch.status === 'returned' && currentBatch.returnNotes) {
                document.getElementById('modal-return-notes').classList.remove('hidden');
                document.getElementById('modal-return-text').textContent = currentBatch.returnNotes;
            } else {
                document.getElementById('modal-return-notes').classList.add('hidden');
            }

            // Display expenses
            const categoryEmojis = {
                fuel: '⛽',
                parking: '🅿️',
                toll: '🛣️',
                food: '🍔',
                maintenance: '🔧',
                other: '📝'
            };

            document.getElementById('modal-expenses').innerHTML = currentBatch.expenses.map(exp => `
                <div class="bg-[#283039] rounded-lg p-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${categoryEmojis[exp.category] || '📝'}</span>
                        <div>
                            <div class="font-medium capitalize">${exp.category}</div>
                            ${exp.photos && exp.photos.length > 0 ? `
                                <button onclick="viewExpensePhotos(${currentBatch.expenses.indexOf(exp)})" class="text-xs text-blue-400 hover:text-blue-300 transition-colors flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">photo_camera</span>
                                    ${exp.photos.length} photo${exp.photos.length !== 1 ? 's' : ''}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <span class="font-semibold text-green-500">£${parseFloat(exp.amount).toFixed(2)}</span>
                </div>
            `).join('');

            // Show appropriate actions
            const actions = document.getElementById('modal-actions');
            if (currentBatch.status === 'pending') {
                actions.innerHTML = `
                    <button onclick="returnBatch()" class="flex-1 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition-colors">
                        <span class="material-symbols-outlined text-sm">undo</span>
                        Return for Review
                    </button>
                    <button onclick="validateBatch()" class="flex-1 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors">
                        <span class="material-symbols-outlined text-sm">check_circle</span>
                        Validate
                    </button>
                `;
            } else if (currentBatch.status === 'validated') {
                actions.innerHTML = `
                    <button onclick="markAsPaid()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors">
                        <span class="material-symbols-outlined text-sm">payments</span>
                        Mark as Paid
                    </button>
                `;
            } else {
                actions.innerHTML = '';
            }

            document.getElementById('batchModal').classList.remove('hidden');
        }

        // Validate batch
        async function validateBatch() {
            if (!confirm('Validate this expense batch?')) return;

            try {
                await window.updateDoc(window.doc(window.db, 'expenseBatches', currentBatch.id), {
                    status: 'validated',
                    validatedAt: window.serverTimestamp(),
                    validatedBy: currentUser.uid,
                    updatedAt: window.serverTimestamp()
                });

                alert('Batch validated successfully');
                closeModal();
                await loadAllBatches();
            } catch (error) {
                console.error('Error validating batch:', error);
                alert('Error validating batch. Please try again.');
            }
        }

        // Return batch
        function returnBatch() {
            document.getElementById('returnModal').classList.remove('hidden');
        }

        // Confirm return
        async function confirmReturn() {
            const reason = document.getElementById('returnReason').value.trim();
            if (!reason) {
                alert('Please provide a reason for returning this batch');
                return;
            }

            try {
                await window.updateDoc(window.doc(window.db, 'expenseBatches', currentBatch.id), {
                    status: 'returned',
                    returnNotes: reason,
                    returnedAt: window.serverTimestamp(),
                    returnedBy: currentUser.uid,
                    updatedAt: window.serverTimestamp()
                });

                alert('Batch returned to driver');
                closeReturnModal();
                closeModal();
                await loadAllBatches();
            } catch (error) {
                console.error('Error returning batch:', error);
                alert('Error returning batch. Please try again.');
            }
        }

        // Mark as paid
        async function markAsPaid() {
            if (!confirm('Mark this batch as paid?')) return;

            try {
                await window.updateDoc(window.doc(window.db, 'expenseBatches', currentBatch.id), {
                    status: 'paid',
                    paidAt: window.serverTimestamp(),
                    paidBy: currentUser.uid,
                    updatedAt: window.serverTimestamp()
                });

                alert('Batch marked as paid');
                closeModal();
                await loadAllBatches();
            } catch (error) {
                console.error('Error marking as paid:', error);
                alert('Error updating batch. Please try again.');
            }
        }

        // View photos for an expense
        async function viewExpensePhotos(expenseIndex) {
            const expense = currentBatch.expenses[expenseIndex];
            if (!expense || !expense.photos || expense.photos.length === 0) {
                return;
            }

            const grid = document.getElementById('photoViewerGrid');
            
            // Photos are URLs (from Firebase Storage)
            grid.innerHTML = expense.photos.map((url, index) => `
                <div class="mb-4">
                    <img src="${url}" class="w-full rounded-lg" alt="Expense photo ${index + 1}" loading="lazy">
                </div>
            `).join('');

            document.getElementById('photoViewerModal').classList.remove('hidden');
        }

        // Close photo viewer
        function closePhotoViewer() {
            document.getElementById('photoViewerModal').classList.add('hidden');
            document.getElementById('photoViewerGrid').innerHTML = '';
        }

        // Close modals
        function closeModal() {
            document.getElementById('batchModal').classList.add('hidden');
            currentBatch = null;
        }

        function closeReturnModal() {
            document.getElementById('returnModal').classList.add('hidden');
            document.getElementById('returnReason').value = '';
        }

        // Logout
        async function logout() {
            try {
                // Clear stored user identity
                localStorage.removeItem('soto_user_identity');
                
                // Sign out from Firebase
                await window.signOut(window.auth);
                
                console.log('User logged out successfully');
                
                // Redirect to login page
                window.location.href = '/pages/soto-routes-login.html';
            } catch (error) {
                console.error('Logout error:', error);
                // Even if logout fails, clear localStorage and redirect
                localStorage.removeItem('soto_user_identity');
                window.location.href = '/pages/soto-routes-login.html';
            }
        }

        // Helper functions for navigation
        function showNotifications() {
            // TODO: Implement notifications
            console.log('Notifications clicked');
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('hidden');
        }

        function showChangePassword() {
            // TODO: Implement change password
            console.log('Change password clicked');
        }

        function viewUsage() {
            if (currentUser && currentUser.officeId) {
                window.location.href = `/pages/office-calendar.html?officeId=${currentUser.officeId}`;
            } else {
                alert('Unable to determine office ID');
            }
        }
    </script>
</div>
</div>
</body>
</html>

