<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Account - Driver Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="/assets/js/tailwind-runtime.js"></script>
    <script src="../js/ui-dialogs.js"></script>
    <script src="/js/session-manager.js"></script>
    <style>
        body {
            font-family: Inter, "Noto Sans", sans-serif;
        }
        .glass-card {
            background: rgba(26, 31, 36, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .touch-target { min-height: 44px; min-width: 44px; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner-border animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <p class="text-gray-400">Loading...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="min-h-screen flex flex-col px-6 py-8">
        <!-- Header -->
        <div class="mb-8">
            <button onclick="window.location.href='/pages/driver-portal.html'" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
                <span class="material-symbols-outlined">arrow_back</span>
                <span>Back</span>
            </button>
            <h1 class="text-3xl font-bold mb-2 text-white">Account</h1>
            <p class="text-gray-400 text-sm" id="userEmail"></p>
        </div>

        <!-- Account Options -->
        <div class="flex-1 max-w-md mx-auto w-full space-y-4">
            <!-- Change Password Card -->
            <div class="glass-card rounded-2xl p-6 cursor-pointer hover:border-orange-500/50 transition-all duration-300 group" onclick="showChangePassword()">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-orange-600 to-orange-700 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                        <span class="material-symbols-outlined text-3xl text-white">lock</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-white mb-1">Change Password</h3>
                        <p class="text-sm text-gray-400">Update your account password</p>
                    </div>
                    <span class="material-symbols-outlined text-gray-500 group-hover:text-orange-500 transition-colors">arrow_forward_ios</span>
                </div>
            </div>

            <!-- Logout Card -->
            <div class="glass-card rounded-2xl p-6 cursor-pointer hover:border-red-500/50 transition-all duration-300 group" onclick="logout()">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-red-600 to-red-700 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                        <span class="material-symbols-outlined text-3xl text-white">logout</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-white mb-1">Logout</h3>
                        <p class="text-sm text-gray-400">Sign out of your account</p>
                    </div>
                    <span class="material-symbols-outlined text-gray-500 group-hover:text-red-500 transition-colors">arrow_forward_ios</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">Change Password</h2>
                <button onclick="hideChangePassword()" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
                <div class="space-y-4">
                    <div>
                        <label for="currentPassword" class="block text-sm font-medium text-gray-300 mb-2">Current Password</label>
                        <input 
                            type="password" 
                            id="currentPassword" 
                            required
                            class="w-full px-4 py-3 bg-[#1a1f24] border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 transition-colors"
                            placeholder="Enter current password"
                        />
                    </div>

                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-300 mb-2">New Password</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            required
                            minlength="6"
                            class="w-full px-4 py-3 bg-[#1a1f24] border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 transition-colors"
                            placeholder="Enter new password (min. 6 characters)"
                        />
                    </div>

                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            required
                            minlength="6"
                            class="w-full px-4 py-3 bg-[#1a1f24] border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 transition-colors"
                            placeholder="Confirm new password"
                        />
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button 
                        type="button"
                        onclick="hideChangePassword()"
                        class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors font-medium"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        id="changePasswordBtn"
                        class="flex-1 px-4 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors font-medium"
                    >
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCkXzYFC1jQcA6yw6qY1Ao3luEYU4Rd0yA",
            authDomain: "soto-routes.firebaseapp.com",
            projectId: "soto-routes",
            storageBucket: "soto-routes.firebasestorage.app",
            messagingSenderId: "440989695549",
            appId: "1:440989695549:web:0bce8b92a46f7f79953454",
            measurementId: "G-4E3G40QQ9L"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.signOut = signOut;
        window.updatePassword = updatePassword;
        window.reauthenticateWithCredential = reauthenticateWithCredential;
        window.EmailAuthProvider = EmailAuthProvider;
        window.getDoc = getDoc;
        window.doc = doc;
        
        initializeAccountPage();
    </script>
    <script>
        let currentUser = null;
        const notifyError = (message, title = 'Error') => uiDialogs.showAlert({ title, message, tone: 'danger' });
        const notifyWarning = (message, title = 'Heads Up') => uiDialogs.showAlert({ title, message, tone: 'warning' });
        const notifySuccess = (message, title = 'Success') => uiDialogs.showAlert({ title, message, tone: 'success' });
        const notifyInfo = (message, title = 'Notice') => uiDialogs.showAlert({ title, message, tone: 'info' });

        const showConfirmation = async (options) => {
            return new Promise((resolve) => {
                const confirmed = confirm(options.message);
                resolve(confirmed);
            });
        };

        async function initializeAccountPage() {
            try {
                const session = await window.sotoSession.bootstrap(['driver']);
                if (!session) {
                    window.location.href = '/pages/soto-routes-login.html';
                    return;
                }

                currentUser = { uid: session.uid, ...session };
                
                try {
                    const userDoc = await window.getDoc(window.doc(window.db, 'users', currentUser.uid));
                    if (!userDoc.exists()) {
                        window.location.href = '/pages/soto-routes-login.html';
                        return;
                    }

                    currentUser = { ...currentUser, ...userDoc.data() };
                    
                    if (currentUser.role !== 'driver') {
                        notifyWarning('This page is for drivers only.', 'Access Denied');
                        window.location.href = '/pages/soto-lp.html';
                        return;
                    }

                    document.getElementById('userEmail').textContent = currentUser.email || 'No email';
                    document.getElementById('loadingOverlay').style.display = 'none';
                } catch (error) {
                    console.error('Error loading user data:', error);
                    notifyError('Error loading user data. Please try again.');
                }
            } catch (error) {
                console.error('Failed to establish driver session:', error);
                window.location.href = '/pages/soto-routes-login.html';
            }
        }

        function showChangePassword() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
            document.getElementById('currentPassword').focus();
        }

        function hideChangePassword() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordForm').reset();
        }

        async function handleChangePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                notifyWarning('New passwords do not match.', 'Password Mismatch');
                return;
            }
            
            if (newPassword.length < 6) {
                notifyWarning('New password must be at least 6 characters long.', 'Weak Password');
                return;
            }
            
            const btn = document.getElementById('changePasswordBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Changing...';
            
            try {
                const user = window.auth.currentUser;
                if (!user || !user.email) {
                    notifyError('No user is currently signed in.', 'Authentication Required');
                    return;
                }
                
                // Re-authenticate user with current password
                const credential = window.EmailAuthProvider.credential(user.email, currentPassword);
                await window.reauthenticateWithCredential(user, credential);
                
                // Update password
                await window.updatePassword(user, newPassword);
                
                notifySuccess('Password changed successfully!', 'Password Updated');
                hideChangePassword();
                
            } catch (error) {
                console.error('Error changing password:', error);
                
                if (error.code === 'auth/wrong-password') {
                    notifyError('Current password is incorrect.', 'Incorrect Password');
                } else if (error.code === 'auth/weak-password') {
                    notifyWarning('New password is too weak. Please choose a stronger password.', 'Weak Password');
                } else if (error.code === 'auth/requires-recent-login') {
                    notifyWarning('Please log out and log back in, then try changing your password again.', 'Re-authentication Required');
                } else {
                    notifyError('Failed to change password. Please try again.', 'Error');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function logout() {
            const confirmed = await showConfirmation({
                title: 'Logout',
                message: 'Are you sure you want to logout?',
                confirmText: 'Logout',
                cancelText: 'Cancel',
                tone: 'warning'
            });
            if (!confirmed) {
                return;
            }

            try {
                await window.signOut(window.auth);
            } catch (error) {
                console.warn('Firebase sign out failed:', error);
            } finally {
                window.sotoSession?.clearSession();
                window.location.href = '/pages/soto-routes-login.html';
            }
        }
    </script>
</body>
</html>

