<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="icon" type="image/png" sizes="32x32" href="/assets/logos/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/logos/favicon-16.png">
    <link rel="icon" type="image/svg+xml" href="/assets/logos/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/assets/logos/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/logos/apple-touch-icon.png">
<link rel="stylesheet" href="/assets/css/responsive-nav.css">
<title>Driver Management - SOTO Routes</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="/assets/js/tailwind-runtime.js?plugins=forms,container-queries"></script>
<script src="/js/mobile-nav.js"></script>
<script src="/js/session-manager.js"></script>
<script src="../js/ui-dialogs.js"></script>
<script src="/js/settings.js"></script>
<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, getDoc, deleteDoc, doc, query, orderBy, setDoc, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCkXzYFC1jQcA6yw6qY1Ao3luEYU4Rd0yA",
        authDomain: "soto-routes.firebaseapp.com",
        projectId: "soto-routes",
        storageBucket: "soto-routes.firebasestorage.app",
        messagingSenderId: "440989695549",
        appId: "1:440989695549:web:0bce8b92a46f7f79953454",
        measurementId: "G-4E3G40QQ9L"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const functions = getFunctions(app);
    
    // Make Firebase available globally
    window.firebaseApp = app;
    window.firestore = db;
    window.auth = auth;
    window.firebaseCollection = collection;
    window.firebaseAddDoc = addDoc;
    window.firebaseGetDocs = getDocs;
    window.firebaseGetDoc = getDoc;
    window.firebaseDeleteDoc = deleteDoc;
    window.firebaseDoc = doc;
    window.firebaseQuery = query;
    window.firebaseOrderBy = orderBy;
    window.firebaseSetDoc = setDoc;
    window.firebaseWhere = where;
    window.firebase = {
        functions,
        httpsCallable
    };
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.sendPasswordResetEmail = sendPasswordResetEmail;
    
    console.log('Firebase initialized successfully!');
    
</script>
<script>
async function checkAuthentication() {
    try {
        const session = await window.sotoSession.bootstrap(['office', 'admin']);
        return session;
    } catch (error) {
        console.error('Authentication check failed:', error);
        return null;
    }
}

async function waitForFirebaseReady(maxAttempts = 20, delayMs = 150) {
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
        if (window.firestore && window.firebaseCollection) {
            console.log('Firebase is ready!');
            return true;
        }
        console.log(`Firebase not ready yet, attempt ${attempt + 1}/${maxAttempts}`);
        await new Promise((resolve) => setTimeout(resolve, delayMs));
    }
    console.error('Firebase failed to initialize after maximum attempts');
    return false;
}

const callableCache = {};
let currentSession = null;

function getCallable(name) {
    if (!callableCache[name]) {
        callableCache[name] = window.firebase.httpsCallable(window.firebase.functions, name);
    }
    return callableCache[name];
}

async function initializeDriversApp() {
    console.log('Initializing drivers app...');

    const userIdentity = await checkAuthentication();
    if (!userIdentity) {
        return;
    }

    currentSession = window.currentUserIdentity || userIdentity;

    const firebaseReady = await waitForFirebaseReady();
    if (!firebaseReady) {
        console.error('Failed to initialize Firebase');
        return;
    }

    await loadOfficeLogo(userIdentity.officeId);

    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.opacity = '0';
        loadingOverlay.style.transition = 'opacity 0.3s ease-out';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 300);
    }

    console.log('Firebase initialization complete');

    initializeDrivers();
    await initializeNotifications();
}

if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initializeDriversApp();
} else {
    document.addEventListener('DOMContentLoaded', initializeDriversApp);
}

// Initialize drivers functionality
function initializeDrivers() {
    // Load drivers when page is ready
    fetchAndDisplayDrivers();
}
</script>
<style type="tailwindcss">
      :root {
        --primary-color: #0d7ff2;
        --success-color: #22c55e;
      }
      .glow {
        box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4);
      }
    </style>
    <style>
        /* Loading spinner */
        .spinner-wrapper {
            width: 64px;
            height: 64px;
            position: relative;
        }
        .spinner {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            animation: spinning82341 1.7s linear infinite;
            filter: blur(1px);
        }
        .spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-image: linear-gradient(rgb(186, 66, 255) 35%, rgb(0, 225, 255));
            box-shadow: 0px -5px 20px 0px rgb(186, 66, 255), 0px 5px 20px 0px rgb(0, 225, 255);
        }
        .spinner1 {
            background-color: rgb(36, 36, 36);
            width: 52px;
            height: 52px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        @keyframes spinning82341 {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-[#111418] text-white" style='font-family: Inter, "Noto Sans", sans-serif;'>
<div class="relative flex h-auto min-h-screen w-full flex-col dark group/design-root overflow-x-hidden">
<div class="flex h-full grow flex-col">
<header class="relative flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#283039] px-6 py-3" data-soto-nav>
<div class="flex items-center gap-4">
<div class="size-8 text-[var(--primary-color)]">
<svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M13.8261 17.4264C16.7203 18.1174 20.2244 18.5217 24 18.5217C27.7756 18.5217 31.2797 18.1174 34.1739 17.4264C36.9144 16.7722 39.9967 15.2331 41.3563 14.1648L24.8486 40.6391C24.4571 41.267 23.5429 41.267 23.1514 40.6391L6.64374 14.1648C8.00331 15.2331 11.0856 16.7722 13.8261 17.4264Z" fill="currentColor"></path>
<path clip-rule="evenodd" d="M39.998 12.236C39.9944 12.2537 39.9875 12.2845 39.9748 12.3294C39.9436 12.4399 39.8949 12.5741 39.8346 12.7175C39.8168 12.7597 39.7989 12.8007 39.7813 12.8398C38.5103 13.7113 35.9788 14.9393 33.7095 15.4811C30.9875 16.131 27.6413 16.5217 24 16.5217C20.3587 16.5217 17.0125 16.131 14.2905 15.4811C12.0012 14.9346 9.44505 13.6897 8.18538 12.8168C8.17384 12.7925 8.16216 12.767 8.15052 12.7408C8.09919 12.6249 8.05721 12.5114 8.02977 12.411C8.00356 12.3152 8.00039 12.2667 8.00004 12.2612C8.00004 12.261 8 12.2607 8.00004 12.2612C8.00004 12.2359 8.0104 11.9233 8.68485 11.3686C9.34546 10.8254 10.4222 10.2469 11.9291 9.72276C14.9242 8.68098 19.1919 8 24 8C28.8081 8 33.0758 8.68098 36.0709 9.72276C37.5778 10.2469 38.6545 10.8254 39.3151 11.3686C39.9006 11.8501 39.9857 12.1489 39.998 12.236ZM4.95178 15.2312L21.4543 41.6973C22.6288 43.5809 25.3712 43.5809 26.5457 41.6973L43.0534 15.223C43.0709 15.1948 43.0878 15.1662 43.104 15.1371L41.3563 14.1648C43.104 15.1371 43.1038 15.1374 43.104 15.1371L43.1051 15.135L43.1065 15.1325L43.1101 15.1261L43.1199 15.1082C43.1276 15.094 43.1377 15.0754 43.1497 15.0527C43.1738 15.0075 43.2062 14.9455 43.244 14.8701C43.319 14.7208 43.4196 14.511 43.5217 14.2683C43.6901 13.8679 44 13.0689 44 12.2609C44 10.5573 43.003 9.22254 41.8558 8.2791C40.6947 7.32427 39.1354 6.55361 37.385 5.94477C33.8654 4.72057 29.133 4 24 4C18.867 4 14.1346 4.72057 10.615 5.94478C8.86463 6.55361 7.30529 7.32428 6.14419 8.27911C4.99695 9.22255 3.99999 10.5573 3.99999 12.2609C3.99999 13.1275 4.29264 13.9078 4.49321 14.3607C4.60375 14.6102 4.71348 14.8196 4.79687 14.9689C4.83898 15.0444 4.87547 15.1065 4.9035 15.1529C4.91754 15.1762 4.92954 15.1957 4.93916 15.2111L4.94662 15.223L4.95178 15.2312ZM35.9868 18.996L24 38.22L12.0131 18.996C12.4661 19.1391 12.9179 19.2658 13.3617 19.3718C16.4281 20.1039 20.0901 20.5217 24 20.5217C27.9099 20.5217 31.5719 20.1039 34.6383 19.3718C35.082 19.2658 35.5339 19.1391 35.9868 18.996Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-xl font-bold">SOTO Routes</h2>
</div>
<nav class="flex flex-1 justify-center gap-2" data-soto-nav-links>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/soto-lp.html">Routes</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/optimisation.html">Optimisation</a>
<a class="bg-[#283039] text-white text-sm font-medium rounded-md px-4 py-2" href="#">Drivers</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/availability.html">Availability</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/expenses.html">Expenses</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/wait-times.html">Wait Times</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/messages.html">Messages</a>
</nav>
<div class="flex items-center gap-4">
    <button type="button" class="mobile-nav-toggle" data-soto-nav-toggle aria-label="Toggle navigation" aria-expanded="false">
        <span class="material-symbols-outlined text-xl">menu</span>
    </button>
                <div class="relative">
                    <button class="flex items-center justify-center rounded-full h-10 w-10 bg-[#283039] hover:bg-[#3a444e] transition-colors relative" onclick="showNotifications()">
                        <span class="material-symbols-outlined text-xl">notifications</span>
                        <!-- Notification Badge -->
                        <span class="notification-badge absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold hidden">0</span>
                    </button>
                    <!-- Notifications Dropdown -->
                    <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-[#1a1f24] border border-[#283039] rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto">
                        <div class="px-4 py-3 border-b border-[#283039]">
                            <h3 class="text-white font-semibold text-sm">Notifications</h3>
                        </div>
                        <div id="notificationsList" class="max-h-64 overflow-y-auto">
                            <!-- Notifications will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="relative">
                    <button onclick="toggleProfileDropdown()" class="flex items-center justify-center rounded-full size-10 bg-black overflow-hidden hover:ring-2 hover:ring-blue-500 transition-all cursor-pointer">
                        <img id="officeLogoImg" src="/assets/logos/favicon.svg" alt="Office Logo" class="w-full h-full object-cover" onerror="this.src='/assets/logos/favicon.svg'">
                    </button>
                    <!-- Profile Dropdown -->
                    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[#1a1f24] border border-[#283039] rounded-lg shadow-lg z-50">
                        <button onclick="showSettings()" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[#283039] transition-colors rounded-t-lg">
                            <span class="material-symbols-outlined inline-block align-middle text-base mr-2">settings</span>
                            Settings
                        </button>
                        <button onclick="showChangePassword()" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[#283039] transition-colors">
                            <span class="material-symbols-outlined inline-block align-middle text-base mr-2">lock</span>
                            Change Password
                        </button>
                        <button onclick="viewUsage()" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[#283039] transition-colors">
                            <span class="material-symbols-outlined inline-block align-middle text-base mr-2">calendar_month</span>
                            View Usage
                        </button>
                        <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-[#283039] transition-colors rounded-b-lg">
                            <span class="material-symbols-outlined inline-block align-middle text-base mr-2">logout</span>
                            Logout
                        </button>
                    </div>
                </div>
</div>
</header>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-[#0f1419] bg-opacity-95 flex items-center justify-center z-50">
    <div class="text-center">
        <div class="spinner-wrapper mx-auto mb-4">
            <div class="spinner"></div>
            <div class="spinner1"></div>
        </div>
        <p class="text-white text-lg font-semibold">Loading Drivers...</p>
        <p class="text-gray-400 text-sm mt-1">Please wait</p>
    </div>
</div>

<main class="flex-1 px-6 py-4">
<div class="max-w-6xl mx-auto">
<div class="flex justify-between items-center mb-4">
<h1 class="text-2xl font-bold tracking-tight">Manage Drivers</h1>
<button id="add-driver-btn" class="flex items-center justify-center gap-2 min-w-[100px] h-8 px-4 rounded-md bg-[var(--primary-color)] text-white text-sm font-bold hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" onclick="openAddDriverModal()">
<span class="material-symbols-outlined text-sm">add</span>
<span>Add Driver</span>
</button>
</div>

<!-- Search Bar -->
<div class="bg-[#1a1f24] rounded-lg p-4 mb-4">
<div class="relative flex items-center gap-4">
<input type="text" id="search-drivers" placeholder="Search drivers by name or postcode..." 
class="form-input w-full rounded-md bg-[#283039] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-8 placeholder:text-[#6b7f99] px-3 py-2 text-sm resize-none">
<span class="material-symbols-outlined text-[#6b7f99] text-sm">search</span>
</div>
</div>

<!-- Drivers List -->
<div id="drivers-container" class="grid grid-cols-3 gap-4">
<!-- Drivers will be dynamically loaded here -->
</div>

<!-- Loading State -->
<div id="loading-state" class="text-center py-8 text-[#9cabba]">
<span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span>
<p>Loading drivers...</p>
</div>

<!-- Empty State -->
<div id="empty-state" class="text-center py-12 text-[#9cabba] hidden">
<span class="material-symbols-outlined text-6xl mb-4">person_off</span>
<h3 class="text-xl font-semibold mb-2">No drivers found</h3>
<p>Add your first driver to get started</p>
</div>
</div>
</main>
</div>
</div>

<!-- Choice Modal: Single or Multiple -->
<div id="choice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-[#1a1f24] rounded-lg p-6 w-full max-w-md mx-4 border border-[#283039]">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">Add Drivers</h2>
<button onclick="closeChoiceModal()" class="text-[#9cabba] hover:text-white transition-colors">
<span class="material-symbols-outlined">close</span>
</button>
</div>
<p class="text-sm text-[#9cabba] mb-6">Would you like to add a single driver or multiple drivers at once?</p>
<div class="flex gap-4">
<button onclick="openSingleDriverModal()" class="flex-1 h-12 px-4 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold transition-colors">
<span class="material-symbols-outlined text-sm align-middle">person</span>
Single Driver
</button>
<button onclick="openMultipleDriverModal()" class="flex-1 h-12 px-4 rounded-md bg-green-600 hover:bg-green-700 text-white text-sm font-bold transition-colors">
<span class="material-symbols-outlined text-sm align-middle">group</span>
Multiple Drivers
</button>
</div>
</div>
</div>

<!-- Add Single Driver Modal -->
<div id="add-driver-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-[#1a1f24] rounded-lg p-6 w-full max-w-md mx-4 border border-[#283039]">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">Add New Driver</h2>
<button onclick="closeAddDriverModal()" class="text-[#9cabba] hover:text-white transition-colors">
<span class="material-symbols-outlined">close</span>
</button>
</div>
<form id="add-driver-form" class="space-y-4">
<div>
<label for="firstName" class="block text-sm font-medium text-[#9cabba] mb-1">First Name</label>
<input type="text" id="firstName" required
class="form-input w-full rounded-md bg-[#283039] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-10 px-3 py-2 text-sm">
</div>
<div>
<label for="lastName" class="block text-sm font-medium text-[#9cabba] mb-1">Last Name</label>
<input type="text" id="lastName" required
class="form-input w-full rounded-md bg-[#283039] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-10 px-3 py-2 text-sm">
</div>
<div>
<label for="homePostcode" class="block text-sm font-medium text-[#9cabba] mb-1">Home Postcode</label>
<input type="text" id="homePostcode" required
class="form-input w-full rounded-md bg-[#283039] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-10 px-3 py-2 text-sm">
</div>
<div>
<label for="email" class="block text-sm font-medium text-[#9cabba] mb-1">Email Address</label>
<input type="email" id="email" required
class="form-input w-full rounded-md bg-[#283039] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-10 px-3 py-2 text-sm">
</div>
<button type="submit" class="w-full h-10 px-4 rounded-md bg-[var(--success-color)] text-white text-sm font-bold hover:opacity-90 transition-opacity">
Add Driver
</button>
</form>
</div>
</div>

<!-- Add Multiple Drivers Modal -->
<div id="add-multiple-drivers-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden overflow-y-auto">
<div class="bg-[#1a1f24] rounded-lg p-6 w-full max-w-4xl mx-4 my-8 border border-[#283039]">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">Add Multiple Drivers</h2>
<button onclick="closeMultipleDriverModal()" class="text-[#9cabba] hover:text-white transition-colors">
<span class="material-symbols-outlined">close</span>
</button>
</div>

<!-- Driver Forms Container -->
<div id="multiple-drivers-container" class="space-y-4 mb-4 max-h-[60vh] overflow-y-auto pr-2">
<!-- Driver forms will be added here -->
</div>

<!-- Add Another Driver Button -->
<button onclick="addAnotherDriverForm()" class="w-full h-10 px-4 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold transition-colors mb-4">
<span class="material-symbols-outlined text-sm align-middle">add</span>
Add Another Driver
</button>

<!-- Submit All Drivers -->
<button onclick="submitMultipleDrivers()" class="w-full h-10 px-4 rounded-md bg-green-600 hover:bg-green-700 text-white text-sm font-bold transition-colors">
Create All Drivers
</button>
</div>
</div>

<!-- Temporary Passwords Display Modal -->
<div id="temp-passwords-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
<div class="bg-[#1a1f24] rounded-lg p-6 w-full max-w-2xl mx-4 border border-[#283039]">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">Driver Login Credentials</h2>
<button onclick="closeTempPasswordsModal()" class="text-[#9cabba] hover:text-white transition-colors">
<span class="material-symbols-outlined">close</span>
</button>
</div>
<p class="text-sm text-[#9cabba] mb-4">All drivers have been created successfully! Here are their temporary login codes (valid for 24 hours):</p>
<div id="temp-passwords-list" class="bg-[#283039] rounded-lg p-4 mb-4 max-h-[60vh] overflow-y-auto">
<!-- Temporary passwords will be displayed here -->
</div>
<div class="flex gap-4">
<button onclick="copyAllPasswords()" class="flex-1 h-10 px-4 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold transition-colors">
<span class="material-symbols-outlined text-sm align-middle">content_copy</span>
Copy All
</button>
<button onclick="closeTempPasswordsModal()" class="flex-1 h-10 px-4 rounded-md bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold transition-colors">
Close
</button>
</div>
</div>
</div>

<script>
let allDrivers = []; // Store all drivers for filtering

// DOM Elements
const driversContainer = document.getElementById('drivers-container');
const loadingState = document.getElementById('loading-state');
const emptyState = document.getElementById('empty-state');
const addDriverBtn = document.getElementById('add-driver-btn');
const addDriverModal = document.getElementById('add-driver-modal');
const addDriverForm = document.getElementById('add-driver-form');
const searchDriversInput = document.getElementById('search-drivers');

// Event Listeners
addDriverBtn.addEventListener('click', openAddDriverModal);
addDriverForm.addEventListener('submit', addDriver);
searchDriversInput.addEventListener('input', (e) => filterDrivers(e.target.value));

// Notification helpers
const notifyError = (message, title = 'Error') => uiDialogs.showAlert({ title, message, tone: 'danger' });
const notifyWarning = (message, title = 'Heads Up') => uiDialogs.showAlert({ title, message, tone: 'warning' });
const notifySuccess = (message, title = 'Success') => uiDialogs.showAlert({ title, message, tone: 'success' });
const notifyInfo = (message, title = 'Notice') => uiDialogs.showAlert({ title, message, tone: 'info' });

// Load office logo from Firebase
async function loadOfficeLogo(officeId) {
    if (!officeId) {
        console.log('No officeId provided, skipping logo load');
        return;
    }
    
    console.log('Loading office logo for officeId:', officeId);
    
    try {
        // Wait for Firebase to be ready with retries
        let attempts = 0;
        while (attempts < 20 && (!window.firestore || !window.firebaseGetDoc || !window.firebaseDoc)) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }
        
        if (!window.firestore || !window.firebaseGetDoc || !window.firebaseDoc) {
            console.error('Firebase not ready after waiting');
            return;
        }
        
        console.log('Fetching office document...');
        const officeDoc = await window.firebaseGetDoc(window.firebaseDoc(window.firestore, 'offices', officeId));
        
        if (!officeDoc.exists()) {
            console.log('Office document does not exist');
            return;
        }
        
        const officeData = officeDoc.data();
        console.log('Office data:', officeData);
        console.log('Office logoUrl:', officeData.logoUrl);
        
        const logoImg = document.getElementById('officeLogoImg');
        if (!logoImg) {
            console.error('Logo image element not found');
            return;
        }
        
        if (officeData.logoUrl) {
            console.log('Setting logo image source to:', officeData.logoUrl);
            logoImg.src = officeData.logoUrl;
            // Force reload if image is cached
            logoImg.onload = function() {
                console.log('Logo image loaded successfully');
            };
            logoImg.onerror = function() {
                console.error('Error loading logo image, falling back to default');
                logoImg.src = '/assets/logos/favicon.svg';
            };
        } else {
            console.log('No logoUrl in office data, keeping default logo');
        }
    } catch (error) {
        console.error('Error loading office logo:', error);
        // Fallback to default logo (already set in HTML)
    }
}

// Firebase Functions
async function fetchAndDisplayDrivers() {
if (!currentSession) {
return;
}

loadingState.classList.remove('hidden');
driversContainer.classList.add('hidden');
emptyState.classList.add('hidden');

try {
const listDriversFn = getCallable('listDrivers');
const response = await listDriversFn({
    officeId: currentSession?.officeId || null
});
const drivers = response?.data?.drivers || [];
allDrivers = drivers.map((driver) => ({
    ...driver,
    id: driver.id || driver.uid
}));
// Sort drivers alphabetically by firstName, then lastName
allDrivers.sort((a, b) => {
    const firstNameA = (a.firstName || '').toLowerCase().trim();
    const firstNameB = (b.firstName || '').toLowerCase().trim();
    const lastNameA = (a.lastName || '').toLowerCase().trim();
    const lastNameB = (b.lastName || '').toLowerCase().trim();
    
    // First compare by firstName
    const firstNameCompare = firstNameA.localeCompare(firstNameB);
    if (firstNameCompare !== 0) {
        return firstNameCompare;
    }
    
    // If firstNames are equal, compare by lastName
    return lastNameA.localeCompare(lastNameB);
});

renderDrivers(allDrivers);

if (allDrivers.length === 0) {
emptyState.classList.remove('hidden');
}
} catch (error) {
console.error('Error fetching drivers:', error);
    notifyError('Error fetching drivers: ' + error.message);
emptyState.classList.remove('hidden');
} finally {
loadingState.classList.add('hidden');
}
}

async function addDriver(event) {
event.preventDefault();

const firstName = document.getElementById('firstName').value.trim();
const lastName = document.getElementById('lastName').value.trim();
const homePostcode = document.getElementById('homePostcode').value.trim();
const email = document.getElementById('email').value.trim();
const carryover = 0;
const carryoverPostcode = '';

if (!firstName || !lastName || !homePostcode || !email) {
    notifyWarning('Please fill in all required fields (First Name, Last Name, Home Postcode, Email).', 'Missing Information');
return;
}

try {
const createDriverFn = getCallable('createDriver');
const response = await createDriverFn({
firstName,
lastName,
email,
homePostcode
});

const tempPassword = response?.data?.temporaryPassword;

let successMessage = 'Driver added successfully!';
if (tempPassword) {
successMessage += `\n\nTemporary login password: ${tempPassword}\n\nPlease share it securely with the driver.`;
}

notifySuccess(successMessage, 'Driver Created');
addDriverForm.reset();
closeAddDriverModal();
await fetchAndDisplayDrivers(); // Refresh the list
} catch (error) {
console.error('Error adding driver:', error);
// Check various error codes that might indicate duplicate
if (error.code === 'already-exists' || 
    error.code === 'auth/email-already-in-use' ||
    (error.message && error.message.toLowerCase().includes('already exists')) ||
    (error.message && error.message.toLowerCase().includes('email already in use'))) {
        notifyError('A driver with this email address already exists. The previous driver may not have been fully deleted from Firebase Authentication. Please check the cloud function deleteDriver to ensure it removes the Firebase Auth user.', 'Duplicate Driver');
        console.warn('Driver creation failed - email already exists:', email);
        console.warn('This indicates the Firebase Auth user still exists even though the driver document may be deleted.');
} else if (error.code === 'invalid-argument') {
        notifyWarning(error.message || 'Invalid driver details provided.', 'Invalid Data');
} else if (error.code === 'invalid-email') {
        notifyWarning('Invalid email address format.', 'Invalid Email');
} else {
        notifyError('Error adding driver: ' + error.message);
}
}
}

async function deleteDriver(driverId) {
const confirmed = await showConfirmation({
title: 'Delete Driver',
message: 'Are you sure you want to delete this driver? This will permanently remove their account and all associated data, including calendar entries.',
confirmText: 'Delete Driver',
cancelText: 'Cancel',
tone: 'danger'
});
if (!confirmed) {
return;
}

// Find and disable the delete button for this driver
let deleteButton = null;
let buttonOriginalHTML = '';
try {
    deleteButton = document.querySelector(`button[onclick="deleteDriver('${driverId}')"]`);
    if (deleteButton) {
        buttonOriginalHTML = deleteButton.innerHTML;
        deleteButton.disabled = true;
        deleteButton.innerHTML = '<span class="material-symbols-outlined text-xs animate-spin">hourglass_empty</span>';
        deleteButton.classList.add('opacity-50', 'cursor-not-allowed');
    }
} catch (e) {
    console.warn('Could not find delete button:', e);
}

// Show deleting message
notifyInfo('Deleting driver...', 'Please wait');

try {
const deleteDriverFn = getCallable('deleteDriver');
const result = await deleteDriverFn({ driverId });

console.log('Driver deletion result:', result);

// Verify deletion was successful
if (result?.data?.success === false) {
    throw new Error(result.data.error || 'Deletion may have failed. Please check if driver was fully removed.');
}

notifySuccess('Driver deleted successfully! All data, login access, and calendar entries have been removed.', 'Driver Deleted');
await fetchAndDisplayDrivers(); // Refresh the list

// Note: If you still get "already exists" when adding the driver again,
// it means the Firebase Authentication user wasn't deleted properly.
// Check the deleteDriver cloud function to ensure it deletes the Auth user.
} catch (error) {
console.error('Error deleting driver:', error);
console.error('Delete driver error details:', {
    code: error.code,
    message: error.message,
    details: error.details
});

// More specific error message
let errorMessage = 'Error deleting driver: ' + error.message;
if (error.code === 'not-found') {
    errorMessage = 'Driver not found. They may have already been deleted.';
} else if (error.message && error.message.includes('permission')) {
    errorMessage = 'Permission denied. You may not have permission to delete drivers.';
}

notifyError(errorMessage);
} finally {
// Re-enable button if it still exists (in case deletion succeeded and list refreshed)
if (deleteButton && buttonOriginalHTML) {
    deleteButton.disabled = false;
    deleteButton.innerHTML = buttonOriginalHTML;
    deleteButton.classList.remove('opacity-50', 'cursor-not-allowed');
}
}
}

// UI Functions
function openAddDriverModal() {
// Show the choice modal instead
document.getElementById('choice-modal').classList.remove('hidden');
}

function closeChoiceModal() {
document.getElementById('choice-modal').classList.add('hidden');
}

function openSingleDriverModal() {
closeChoiceModal();
addDriverModal.classList.remove('hidden');
}

function closeAddDriverModal() {
addDriverModal.classList.add('hidden');
addDriverForm.reset();
}

// Multiple Drivers Functions
let multipleDriverCounter = 0;
let multipleDriversData = [];

function openMultipleDriverModal() {
closeChoiceModal();
multipleDriverCounter = 0;
multipleDriversData = [];
document.getElementById('multiple-drivers-container').innerHTML = '';
// Add first driver form
addAnotherDriverForm();
addAnotherDriverForm(); // Add 2 forms by default
document.getElementById('add-multiple-drivers-modal').classList.remove('hidden');
}

function closeMultipleDriverModal() {
document.getElementById('add-multiple-drivers-modal').classList.add('hidden');
multipleDriverCounter = 0;
multipleDriversData = [];
}

function addAnotherDriverForm() {
multipleDriverCounter++;
const container = document.getElementById('multiple-drivers-container');
const formId = `driver-form-${multipleDriverCounter}`;
const driverNumber = multipleDriverCounter;

const formHTML = `
<div id="${formId}" class="bg-[#283039] rounded-lg p-4 border border-[#3a444e] relative">
<div class="flex justify-between items-center mb-3">
<h3 class="text-sm font-bold text-white">Driver ${driverNumber}</h3>
<button onclick="removeDriverForm('${formId}')" class="text-red-400 hover:text-red-300 transition-colors">
<span class="material-symbols-outlined text-sm">close</span>
</button>
</div>
<div class="grid grid-cols-2 gap-3">
<div>
<label class="block text-xs font-medium text-[#9cabba] mb-1">First Name</label>
<input type="text" data-field="firstName" data-form="${formId}" required
class="form-input w-full rounded-md bg-[#1a1f24] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-8 px-2 py-1 text-xs">
</div>
<div>
<label class="block text-xs font-medium text-[#9cabba] mb-1">Last Name</label>
<input type="text" data-field="lastName" data-form="${formId}" required
class="form-input w-full rounded-md bg-[#1a1f24] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-8 px-2 py-1 text-xs">
</div>
<div>
<label class="block text-xs font-medium text-[#9cabba] mb-1">Home Postcode</label>
<input type="text" data-field="homePostcode" data-form="${formId}" required
class="form-input w-full rounded-md bg-[#1a1f24] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-8 px-2 py-1 text-xs">
</div>
<div>
<label class="block text-xs font-medium text-[#9cabba] mb-1">Email Address</label>
<input type="email" data-field="email" data-form="${formId}" required
class="form-input w-full rounded-md bg-[#1a1f24] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-8 px-2 py-1 text-xs">
</div>
</div>
</div>
`;

container.insertAdjacentHTML('beforeend', formHTML);
}

function removeDriverForm(formId) {
const formElement = document.getElementById(formId);
if (formElement) {
formElement.remove();
}
// Renumber remaining forms
const container = document.getElementById('multiple-drivers-container');
const remainingForms = container.querySelectorAll('[id^="driver-form-"]');
remainingForms.forEach((form, index) => {
const header = form.querySelector('h3');
if (header) {
header.textContent = `Driver ${index + 1}`;
}
});
}

async function submitMultipleDrivers() {
const container = document.getElementById('multiple-drivers-container');
const forms = container.querySelectorAll('[id^="driver-form-"]');
  
if (forms.length === 0) {
    notifyWarning('Please add at least one driver before submitting.', 'No Drivers Added');
return;
}

// Collect all driver data
const driversToAdd = [];
for (const form of forms) {
const formId = form.id;
const firstName = document.querySelector(`[data-field="firstName"][data-form="${formId}"]`).value.trim();
const lastName = document.querySelector(`[data-field="lastName"][data-form="${formId}"]`).value.trim();
const homePostcode = document.querySelector(`[data-field="homePostcode"][data-form="${formId}"]`).value.trim();
const email = document.querySelector(`[data-field="email"][data-form="${formId}"]`).value.trim();
const carryover = 0;
const carryoverPostcode = '';

if (!firstName || !lastName || !homePostcode || !email) {
    notifyWarning('Please fill in all required fields for all drivers.', 'Missing Information');
return;
}

driversToAdd.push({
firstName,
lastName,
homePostcode,
email,
carryover,
carryoverPostcode
});
}

const createdDrivers = [];
let hasErrors = false;

const createDriverFn = getCallable('createDriver');

for (const driver of driversToAdd) {
try {
const response = await createDriverFn({
firstName: driver.firstName,
lastName: driver.lastName,
email: driver.email,
homePostcode: driver.homePostcode,
carryover: driver.carryover,
carryoverPostcode: driver.carryoverPostcode
});

const tempPassword = response?.data?.temporaryPassword || '';

createdDrivers.push({
name: `${driver.firstName} ${driver.lastName}`,
email: driver.email,
temporaryPassword: tempPassword
});

console.log(`âœ… Created driver: ${driver.firstName} ${driver.lastName}`);
} catch (error) {
console.error(`Error creating driver ${driver.firstName} ${driver.lastName}:`, error);
hasErrors = true;
if (error.code === 'already-exists') {
        notifyWarning(`Email ${driver.email} is already in use. Skipping this driver.`, 'Duplicate Email');
} else {
        notifyError(`Error creating driver ${driver.firstName} ${driver.lastName}: ${error.message}`);
}
}
}

// Close the multiple drivers modal
closeMultipleDriverModal();

// Show temporary passwords modal if any drivers were created
const driversWithPasswords = createdDrivers.filter(d => d.temporaryPassword);
if (driversWithPasswords.length > 0) {
showTempPasswordsModal(driversWithPasswords);
}

// Refresh the drivers list
await fetchAndDisplayDrivers();
}

function showTempPasswordsModal(drivers) {
const passwordsList = document.getElementById('temp-passwords-list');
let html = '<div class="space-y-3">';
  
drivers.forEach((driver, index) => {
html += `
<div class="bg-[#1a1f24] rounded-lg p-3 border border-[#3a444e]">
<div class="flex justify-between items-start mb-2">
<div>
<h4 class="font-semibold text-sm text-white">${driver.name}</h4>
<p class="text-xs text-[#9cabba]">${driver.email}</p>
</div>
<span class="text-xs text-[#6b7f99] bg-[#283039] px-2 py-1 rounded">#${index + 1}</span>
</div>
<div class="flex items-center justify-between bg-[#283039] rounded px-3 py-2">
<code class="text-green-400 font-mono text-lg font-bold">${driver.temporaryPassword}</code>
<button onclick="copyToClipboard('${driver.temporaryPassword}')" class="text-blue-400 hover:text-blue-300 transition-colors">
<span class="material-symbols-outlined text-sm">content_copy</span>
</button>
</div>
</div>
`;
});

html += '</div>';
passwordsList.innerHTML = html;

// Store passwords for copy all function
window.currentDriverPasswords = drivers;

document.getElementById('temp-passwords-modal').classList.remove('hidden');
}

function closeTempPasswordsModal() {
document.getElementById('temp-passwords-modal').classList.add('hidden');
}

function copyToClipboard(text) {
navigator.clipboard.writeText(text).then(() => {
// Show brief success message
const event = new CustomEvent('show-toast', { detail: { message: 'Copied to clipboard!' } });
window.dispatchEvent(event);
}).catch(err => {
console.error('Failed to copy:', err);
});
}

function copyAllPasswords() {
if (!window.currentDriverPasswords || window.currentDriverPasswords.length === 0) {
return;
}

let text = 'SOTO Routes - Driver Login Credentials\n';
text += '=' .repeat(50) + '\n\n';
  
window.currentDriverPasswords.forEach((driver, index) => {
text += `Driver ${index + 1}: ${driver.name}\n`;
text += `Email: ${driver.email}\n`;
text += `Temporary Password: ${driver.temporaryPassword}\n`;
text += `Valid for: 24 hours\n`;
text += '-'.repeat(50) + '\n\n';
});

navigator.clipboard.writeText(text).then(() => {
    notifySuccess('All credentials copied to clipboard!', 'Copied');
}).catch(err => {
console.error('Failed to copy:', err);
    notifyError('Failed to copy to clipboard.');
});
}

function renderDrivers(driversToRender) {
if (driversToRender.length === 0) {
emptyState.classList.remove('hidden');
driversContainer.classList.add('hidden');
return;
}

emptyState.classList.add('hidden');
driversContainer.classList.remove('hidden');

driversContainer.innerHTML = driversToRender.map(driver => `
<div class="bg-[#1a1f24] rounded-lg p-2 border border-[#283039] hover:border-[#3a444e] transition-colors">
<div class="flex items-center justify-between">
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-[#283039] rounded-full flex items-center justify-center">
<span class="material-symbols-outlined text-[#9cabba] text-xs">person</span>
</div>
<div>
<h3 class="font-semibold text-xs">${driver.firstName || ''} ${driver.lastName || ''}</h3>
<p class="text-xs text-[#9cabba]">${driver.homePostcode || 'N/A'}</p>
<p class="text-xs text-[#9cabba]">${driver.email || 'N/A'}</p>
${driver.carryover === 1 ? `<p class="text-xs text-[var(--warning-color)]">${driver.carryoverPostcode || 'N/A'}</p>` : ''}
</div>
</div>
<button onclick="deleteDriver('${driver.id}')" class="p-1 text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded-md transition-colors">
<span class="material-symbols-outlined text-xs">delete</span>
</button>
</div>
</div>
`).join('');
}

// Filter drivers
function filterDrivers(searchTerm) {
if (!searchTerm.trim()) {
renderDrivers(allDrivers);
return;
}
const lowerCaseSearchTerm = searchTerm.toLowerCase();
const filteredDrivers = allDrivers.filter(driver => 
(driver.firstName && driver.firstName.toLowerCase().includes(lowerCaseSearchTerm)) ||
(driver.lastName && driver.lastName.toLowerCase().includes(lowerCaseSearchTerm)) ||
(driver.homePostcode && driver.homePostcode.toLowerCase().includes(lowerCaseSearchTerm)) ||
(driver.email && driver.email.toLowerCase().includes(lowerCaseSearchTerm)) ||
(driver.carryoverPostcode && driver.carryoverPostcode.toLowerCase().includes(lowerCaseSearchTerm))
);
renderDrivers(filteredDrivers);
}

// Navigation functions
// Check for expenses over 24 working hours old
async function checkOldExpenses(officeId) {
    try {
        const batchesQuery = window.firebaseQuery(
            window.firebaseCollection(window.firestore, 'expenseBatches'),
            window.firebaseWhere('officeId', '==', officeId)
        );
        
        const batchesSnapshot = await window.firebaseGetDocs(batchesQuery);
        const now = new Date();
        let oldExpenseCount = 0;
        
        batchesSnapshot.docs.forEach(doc => {
            const batch = doc.data();
            if (batch.status === 'pending' || batch.status === 'validated') {
                const submittedAt = batch.submittedAt?.toDate ? batch.submittedAt.toDate() : new Date(batch.submittedAt);
                if (submittedAt) {
                    const workingHours = calculateWorkingHours(submittedAt, now);
                    if (workingHours > 24) {
                        oldExpenseCount++;
                    }
                }
            }
        });
        
        return oldExpenseCount;
    } catch (error) {
        console.error('Error checking old expenses:', error);
        return 0;
    }
}

// Calculate working hours between two dates (8am-5pm Mon-Fri only)
function calculateWorkingHours(startDate, endDate) {
    let currentDate = new Date(startDate);
    let workingHours = 0;
    
    while (currentDate < endDate) {
        const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const hour = currentDate.getHours();
        
        // Check if it's a weekday (Monday = 1 to Friday = 5)
        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
            // Check if it's within working hours (8am to 5pm)
            if (hour >= 8 && hour < 17) {
                workingHours += 1;
            }
        }
        
        // Move to next hour
        currentDate.setHours(currentDate.getHours() + 1);
    }
    
    return workingHours;
}

// Update notification count across all office pages
async function updateNotificationCount() {
    try {
        if (!currentSession || !currentSession.officeId) return;
        
        const officeId = currentSession.officeId;
        
        // Get all availability change notifications for this office that haven't been seen
        const notificationsQuery = window.firebaseQuery(
            window.firebaseCollection(window.firestore, 'availabilityNotifications'),
            window.firebaseWhere('officeId', '==', officeId)
        );
        
        const notificationsSnapshot = await window.firebaseGetDocs(notificationsQuery);
        
        // Count unique drivers with unread changes
        const driverChanges = {};
        // Filter to only unseen notifications and convert dates
        const allNotifications = notificationsSnapshot.docs
            .map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt)
                };
            })
            .filter(notification => notification.seen !== true) // Only include unseen notifications
            .sort((a, b) => b.createdAt - a.createdAt); // Sort by date (most recent first)
        
        // Group by driver and only count the most recent batch (within 1 hour of latest)
        allNotifications.forEach(notification => {
            const driverId = notification.driverId;

            if (!driverChanges[driverId]) {
                // This is the first (most recent) unseen notification for this driver
                driverChanges[driverId] = {
                    driverId: driverId,
                    driverName: notification.driverName,
                    daysOff: 0,
                    daysAvailable: 0,
                    notifications: [notification],
                    latestDate: notification.createdAt,
                    earliestDate: notification.createdAt
                };

                // Count this first notification
                if (notification.changeType === 'unavailable') {
                    driverChanges[driverId].daysOff = 1;
                } else {
                    driverChanges[driverId].daysAvailable = 1;
                }
            } else {
                // Check if this notification is within 1 hour of the latest (most recent) one
                // This ensures we only count the most recent batch, not old unseen notifications
                const timeDiffFromLatest = Math.abs(driverChanges[driverId].latestDate - notification.createdAt);
                const oneHour = 60 * 60 * 1000; // 1 hour in milliseconds

                if (timeDiffFromLatest <= oneHour) {
                    // Same batch - add to counts
                    if (notification.changeType === 'unavailable') {
                        driverChanges[driverId].daysOff++;
                    } else {
                        driverChanges[driverId].daysAvailable++;
                    }
                    driverChanges[driverId].notifications.push(notification);
                    // Update earliest date if this is older
                    if (notification.createdAt < driverChanges[driverId].earliestDate) {
                        driverChanges[driverId].earliestDate = notification.createdAt;
                    }
                    // latestDate stays as the most recent (first one we found)
                }
                // If outside the batch window (more than 1 hour from latest), ignore it
            }
        });
        
        // Count total number of drivers with changes
        const availabilityCount = Object.keys(driverChanges).length;
        
        // Check for old expenses (>24 working hours)
        const oldExpenseCount = await checkOldExpenses(officeId);
        
        // Total notification count (availability changes + old expenses)
        const unreadCount = availabilityCount + (oldExpenseCount > 0 ? 1 : 0);
        
        // Update notification badge on all pages
        updateNotificationBadge(unreadCount);
        
    } catch (error) {
        console.error('Error updating notification count:', error);
    }
}

// Update notification badge display
function updateNotificationBadge(count) {
    const badgeElements = document.querySelectorAll('.notification-badge');
    badgeElements.forEach(badge => {
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count.toString();
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    });
}

// Show notifications dropdown
async function showNotifications() {
    const dropdown = document.getElementById('notificationDropdown');
    if (!dropdown) return;
    
    // Toggle dropdown visibility
    dropdown.classList.toggle('hidden');
    
    if (!dropdown.classList.contains('hidden')) {
        // Load and display notifications
        await loadNotifications();
    }
}

// Load notifications for dropdown (aggregated by driver)
async function loadNotifications() {
    try {
        if (!currentSession || !currentSession.officeId) return;
        
        const officeId = currentSession.officeId;
        
        // Get all availability change notifications for this office
        const notificationsQuery = window.firebaseQuery(
            window.firebaseCollection(window.firestore, 'availabilityNotifications'),
            window.firebaseWhere('officeId', '==', officeId)
        );
        
        const notificationsSnapshot = await window.firebaseGetDocs(notificationsQuery);
        const notificationsList = document.getElementById('notificationsList');
        
        const oldExpenseCount = await checkOldExpenses(officeId);
        
        const driverChanges = {};
        // Filter to only unseen notifications and convert dates
        const allNotifications = notificationsSnapshot.docs
            .map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt)
                };
            })
            .filter(notification => notification.seen !== true) // Only include unseen notifications
            .sort((a, b) => b.createdAt - a.createdAt); // Sort by date (most recent first)
        
        // Group by driver and only count the most recent batch (within 1 hour of latest)
        allNotifications.forEach(notification => {
            const driverId = notification.driverId;

            if (!driverChanges[driverId]) {
                // This is the first (most recent) unseen notification for this driver
                driverChanges[driverId] = {
                    driverId: driverId,
                    driverName: notification.driverName,
                    daysOff: 0,
                    daysAvailable: 0,
                    notifications: [notification],
                    latestDate: notification.createdAt,
                    earliestDate: notification.createdAt
                };

                // Count this first notification
                if (notification.changeType === 'unavailable') {
                    driverChanges[driverId].daysOff = 1;
                } else {
                    driverChanges[driverId].daysAvailable = 1;
                }
            } else {
                // Check if this notification is within 1 hour of the latest (most recent) one
                // This ensures we only count the most recent batch, not old unseen notifications
                const timeDiffFromLatest = Math.abs(driverChanges[driverId].latestDate - notification.createdAt);
                const oneHour = 60 * 60 * 1000; // 1 hour in milliseconds

                if (timeDiffFromLatest <= oneHour) {
                    // Same batch - add to counts
                    if (notification.changeType === 'unavailable') {
                        driverChanges[driverId].daysOff++;
                    } else {
                        driverChanges[driverId].daysAvailable++;
                    }
                    driverChanges[driverId].notifications.push(notification);
                    // Update earliest date if this is older
                    if (notification.createdAt < driverChanges[driverId].earliestDate) {
                        driverChanges[driverId].earliestDate = notification.createdAt;
                    }
                    // latestDate stays as the most recent (first one we found)
                }
                // If outside the batch window (more than 1 hour from latest), ignore it
            }
        });
        
        const sortedDrivers = Object.values(driverChanges).sort((a, b) => b.latestDate - a.latestDate);
        notificationsList.innerHTML = '';
        
        if (oldExpenseCount > 0) {
            const expenseNotification = createOldExpenseNotificationElement(oldExpenseCount);
            notificationsList.appendChild(expenseNotification);
        }
        
        sortedDrivers.forEach(driverData => {
            const notificationElement = createAggregatedNotificationElement(driverData);
            notificationsList.appendChild(notificationElement);
        });
        
        if (oldExpenseCount === 0 && sortedDrivers.length === 0) {
            notificationsList.innerHTML = '<div class="px-4 py-3 text-gray-400 text-sm text-center">No notifications yet</div>';
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

// Create old expense notification element
function createOldExpenseNotificationElement(count) {
    const element = document.createElement('div');
    element.className = 'px-4 py-3 border-b border-[#283039] cursor-pointer hover:bg-[#283039] transition-colors bg-[#283039]';
    element.onclick = () => {
        document.getElementById('notificationDropdown').classList.add('hidden');
        window.location.href = '/pages/expenses.html';
    };
    
    element.innerHTML = `
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <div class="text-white text-sm font-medium">There are ${count} ${count === 1 ? 'expense' : 'expenses'} that are 24 working hours old</div>
                <div class="text-[#9cabba] text-xs mt-1">Click to view expenses</div>
            </div>
            <div class="w-2 h-2 bg-red-500 rounded-full ml-2 mt-1"></div>
        </div>
    `;
    
    return element;
}

// Create aggregated notification element
function createAggregatedNotificationElement(driverData) {
    const element = document.createElement('div');
    element.className = 'px-4 py-3 border-b border-[#283039] cursor-pointer hover:bg-[#283039] transition-colors bg-[#283039]';
    element.onclick = () => handleAggregatedNotificationClick(driverData);
    
    let message = '';
    if (driverData.daysOff > 0 && driverData.daysAvailable > 0) {
        message = `${driverData.driverName} has booked ${driverData.daysOff} ${driverData.daysOff === 1 ? 'day' : 'days'} off and changed ${driverData.daysAvailable} ${driverData.daysAvailable === 1 ? 'day' : 'days'} back to available`;
    } else if (driverData.daysOff > 0) {
        message = `${driverData.driverName} has booked ${driverData.daysOff} ${driverData.daysOff === 1 ? 'day' : 'days'} off`;
    } else if (driverData.daysAvailable > 0) {
        message = `${driverData.driverName} has changed ${driverData.daysAvailable} ${driverData.daysAvailable === 1 ? 'day' : 'days'} back to available`;
    }
    
    const timeAgo = getTimeAgo(driverData.latestDate);
    
    element.innerHTML = `
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <div class="text-white text-sm font-medium">${message}</div>
                <div class="text-[#9cabba] text-xs mt-1">${timeAgo}</div>
            </div>
            <div class="w-2 h-2 bg-blue-500 rounded-full ml-2 mt-1"></div>
        </div>
    `;
    
    return element;
}

// Handle aggregated notification click
async function handleAggregatedNotificationClick(driverData) {
    try {
        document.getElementById('notificationDropdown').classList.add('hidden');
        const dates = driverData.notifications.map(n => n.date).sort();
        const earliestDate = dates[0] ? new Date(dates[0]) : new Date();
        const year = earliestDate.getFullYear();
        const month = earliestDate.getMonth() + 1;
        window.location.href = `/pages/availability.html?year=${year}&month=${month}&showChanges=${driverData.driverId}`;
    } catch (error) {
        console.error('Error handling aggregated notification click:', error);
    }
}

// Get time ago string
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} ${diffMins === 1 ? 'minute' : 'minutes'} ago`;
    if (diffHours < 24) return `${diffHours} ${diffHours === 1 ? 'hour' : 'hours'} ago`;
    if (diffDays < 7) return `${diffDays} ${diffDays === 1 ? 'day' : 'days'} ago`;
    return date.toLocaleDateString();
}

// Get time ago string
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString();
}

// Initialize notification system
async function initializeNotifications() {
    // Update notification count on page load
    await updateNotificationCount();
    
    // Update notification count every 30 seconds for persistence
    setInterval(async () => {
        await updateNotificationCount();
    }, 30000);
    
    // Update notification count when page becomes visible
    document.addEventListener('visibilitychange', async () => {
        if (!document.hidden) {
            await updateNotificationCount();
        }
    });
    
    // Set up click outside to close dropdown
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('notificationDropdown');
        const button = event.target.closest('button[onclick="showNotifications()"]');
        
        if (!dropdown || !button) return;
        
        if (!dropdown.contains(event.target) && !button.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });
}

// Make functions globally available
window.deleteDriver = deleteDriver;
window.closeAddDriverModal = closeAddDriverModal;
window.closeChoiceModal = closeChoiceModal;
window.openSingleDriverModal = openSingleDriverModal;
window.openMultipleDriverModal = openMultipleDriverModal;
window.closeMultipleDriverModal = closeMultipleDriverModal;
window.addAnotherDriverForm = addAnotherDriverForm;
window.removeDriverForm = removeDriverForm;
window.submitMultipleDrivers = submitMultipleDrivers;
window.closeTempPasswordsModal = closeTempPasswordsModal;
window.copyToClipboard = copyToClipboard;
window.copyAllPasswords = copyAllPasswords;
window.showTempPasswordsModal = showTempPasswordsModal;

// Logout function
async function logout() {
try {
await window.signOut(window.auth);
window.sotoSession?.clearSession();
window.location.href = '/pages/soto-routes-login.html';
        
} catch (error) {
console.error('Logout error:', error);
// Even if logout fails, clear localStorage and redirect
window.sotoSession?.clearSession();
window.location.href = '/pages/soto-routes-login.html';
}
}

window.logout = logout;

// Profile dropdown functions
function toggleProfileDropdown() {
    const dropdown = document.getElementById('profileDropdown');
    dropdown.classList.toggle('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('profileDropdown');
    const profileButton = event.target.closest('button[onclick="toggleProfileDropdown()"]');
    
    if (!profileButton && !dropdown.contains(event.target)) {
        dropdown.classList.add('hidden');
    }
});

function showChangePassword() {
    document.getElementById('changePasswordModal').classList.remove('hidden');
    document.getElementById('profileDropdown').classList.add('hidden');
}

function hideChangePassword() {
    document.getElementById('changePasswordModal').classList.add('hidden');
    document.getElementById('changePasswordForm').reset();
}

// Settings functions
function showSettings() {
    const modal = document.getElementById('settingsModal');
    const dropdown = document.getElementById('profileDropdown');
    dropdown.classList.add('hidden');
    modal.classList.remove('hidden');
    
    // Load current setting value
    const useAsanaApi = window.sotoSettings?.getUseAsanaApiForRoutes() || false;
    const toggle = document.getElementById('useAsanaApiToggle');
    if (toggle) {
        toggle.checked = useAsanaApi;
    }
}

function hideSettings() {
    document.getElementById('settingsModal').classList.add('hidden');
}

function handleAsanaApiToggle(checked) {
    if (window.sotoSettings) {
        window.sotoSettings.setUseAsanaApiForRoutes(checked);
        console.log('Asana API for routes setting updated:', checked);
    }
}

// View usage calendar
function viewUsage() {
    if (currentSession && currentSession.officeId) {
        window.location.href = `/pages/office-calendar.html?officeId=${currentSession.officeId}`;
    }
}

// Handle password change
async function handleChangePassword(event) {
    event.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        notifyWarning('New passwords do not match.', 'Password Mismatch');
        return;
    }
    
    try {
        const user = window.auth.currentUser;
        if (!user) {
            notifyError('No user logged in.', 'Authentication Required');
            return;
        }
        
        // Re-authenticate user with current password
        const credential = window.EmailAuthProvider.credential(user.email, currentPassword);
        await window.reauthenticateWithCredential(user, credential);
        
        // Update password
        await window.updatePassword(user, newPassword);
        
        notifySuccess('Password changed successfully!', 'Password Updated');
        hideChangePassword();
        
    } catch (error) {
        console.error('Error changing password:', error);
        
        if (error.code === 'auth/wrong-password') {
            notifyError('Current password is incorrect.', 'Incorrect Password');
        } else if (error.code === 'auth/weak-password') {
            notifyWarning('New password is too weak. Please choose a stronger password.', 'Weak Password');
        } else if (error.code === 'auth/requires-recent-login') {
            notifyWarning('Please log out and log back in, then try changing your password again.', 'Re-authentication Required');
        } else {
            notifyError('Error changing password: ' + error.message);
        }
    }
}

// Make functions globally available
window.toggleProfileDropdown = toggleProfileDropdown;
window.showChangePassword = showChangePassword;
window.hideChangePassword = hideChangePassword;
window.viewUsage = viewUsage;
window.handleChangePassword = handleChangePassword;

// Add event listener for password form
document.addEventListener('DOMContentLoaded', function() {
    const changePasswordForm = document.getElementById('changePasswordForm');
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', handleChangePassword);
    }
});
</script>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-[#1a1f24] border border-[#283039] rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Change Password</h3>
            <button onclick="hideChangePassword()" class="text-gray-400 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        
        <form id="changePasswordForm" class="space-y-4">
            <div>
                <label for="currentPassword" class="block text-sm font-medium text-gray-300 mb-2">Current Password</label>
                <input 
                    type="password" 
                    id="currentPassword" 
                    required 
                    class="w-full px-3 py-2 bg-[#283039] border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Enter current password"
                >
            </div>
            
            <div>
                <label for="newPassword" class="block text-sm font-medium text-gray-300 mb-2">New Password</label>
                <input 
                    type="password" 
                    id="newPassword" 
                    required 
                    class="w-full px-3 py-2 bg-[#283039] border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Enter new password"
                >
            </div>
            
            <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                <input 
                    type="password" 
                    id="confirmPassword" 
                    required 
                    class="w-full px-3 py-2 bg-[#283039] border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Confirm new password"
                >
            </div>

            <button 
                type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"
            >
                Change Password
            </button>
        </form>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-[#1a1f24] border border-[#283039] rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Settings</h3>
            <button onclick="hideSettings()" class="text-gray-400 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between py-3 border-b border-[#283039]">
                <div class="flex-1">
                    <label for="useAsanaApiToggle" class="block text-sm font-medium text-white mb-1">
                        Use Asana API for route input
                    </label>
                    <p class="text-xs text-gray-400">When enabled, routes button will redirect to automatic routes page</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input 
                        type="checkbox" 
                        id="useAsanaApiToggle" 
                        class="sr-only peer"
                        onchange="handleAsanaApiToggle(this.checked)"
                    >
                    <div class="w-11 h-6 bg-[#283039] peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end">
            <button 
                onclick="hideSettings()"
                class="px-4 py-2 bg-[#283039] hover:bg-[#3a444e] text-white rounded-lg transition-colors font-medium"
            >
                Close
            </button>
        </div>
    </div>
</div>
</body>
</html>