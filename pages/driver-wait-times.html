<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wait Times - Driver Portal</title>
    <script src="/assets/js/tailwind-runtime.js"></script>
    <script src="../js/ui-dialogs.js"></script>
    <script src="/js/session-manager.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        .touch-target { min-height: 44px; min-width: 44px; }
        .license-plate {
            background: #FFD500;
            color: #000;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 2px;
            padding: 8px 16px;
            border-radius: 6px;
            border: 2px solid #000;
            text-transform: uppercase;
        }
        .category-btn {
            transition: all 0.2s ease;
        }
        .category-btn.active {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.15);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .badge-awaiting {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }
        .badge-charging {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }
        .badge-wash {
            background: rgba(249, 115, 22, 0.15);
            color: #fb923c;
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 20, 25, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp, doc, getDoc, deleteDoc, updateDoc, Timestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCkXzYFC1jQcA6yw6qY1Ao3luEYU4Rd0yA",
            authDomain: "soto-routes.firebaseapp.com",
            projectId: "soto-routes",
            storageBucket: "soto-routes.firebasestorage.app",
            messagingSenderId: "440989695549",
            appId: "1:440989695549:web:0bce8b92a46f7f79953454",
            measurementId: "G-4E3G40QQ9L"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.serverTimestamp = serverTimestamp;
        window.doc = doc;
        window.getDoc = getDoc;
        window.deleteDoc = deleteDoc;
        window.updateDoc = updateDoc;
        window.Timestamp = Timestamp;
        window.onSnapshot = onSnapshot;
        window.signOut = signOut;
        window.where = where;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;

        console.log('Firebase initialized for driver wait times.');

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDriverWaitTimesApp);
        } else {
            initializeDriverWaitTimesApp();
        }
    </script>
</head>
<body class="bg-[#0f1419] text-white min-h-screen">
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-400">Loading your wait times...</p>
        </div>
    </div>

    <div class="bg-[#1a1f24] border-b border-gray-800 sticky top-0 z-50">
        <div class="flex items-center px-4 py-3">
            <button onclick="goToPortal()" class="touch-target flex items-center text-gray-400 hover:text-white transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1 class="flex-1 text-center text-xl font-semibold">My Wait Times</h1>
            <div class="w-6"></div>
        </div>
    </div>

    <main class="container max-w-2xl mx-auto px-4 py-6 pb-24 space-y-6">
        <section id="emptyState" class="hidden text-center py-16 fade-in">
            <span class="material-symbols-outlined text-6xl text-gray-600 mb-4">pending_actions</span>
            <h2 class="text-xl font-semibold mb-2">No wait times yet</h2>
            <p class="text-gray-500 max-w-sm mx-auto">Use the button below to log your current waiting period.</p>
        </section>

        <section id="pendingSection" class="hidden space-y-3 fade-in">
            <header class="flex items-center justify-between">
                <h2 class="text-sm font-bold text-orange-400 tracking-wide">PENDING</h2>
            </header>
            <div id="pendingList" class="space-y-3"></div>
        </section>

        <section id="processedSection" class="hidden space-y-3 fade-in">
            <header class="flex items-center justify-between">
                <h2 class="text-sm font-bold text-green-400 tracking-wide">PROCESSED (LAST 3 DAYS)</h2>
            </header>
            <div id="processedList" class="space-y-3"></div>
        </section>
    </main>

    <button onclick="openWaitTimeModal()" class="fixed bottom-6 right-6 bg-green-600 hover:bg-green-700 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg transition-all transform hover:scale-110 active:scale-95 z-40">
        <span class="material-symbols-outlined text-3xl">add</span>
    </button>

    <div id="waitTimeModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 overflow-y-auto">
        <div class="min-h-screen px-4 flex items-end sm:items-center justify-center">
            <div class="bg-[#1a1f24] rounded-t-3xl sm:rounded-3xl w-full max-w-2xl transform transition-all">
                <div class="sticky top-0 bg-[#1a1f24] border-b border-gray-800 rounded-t-3xl z-10">
                    <div class="flex items-center justify-between px-6 py-4">
                        <h2 class="text-lg font-semibold">Log Wait Time</h2>
                        <button onclick="closeWaitTimeModal()" class="touch-target text-gray-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                </div>
                <form id="waitTimeForm" class="p-6 pb-8 space-y-6">
                    <div>
                        <label class="text-sm text-gray-400 mb-2 block">REGISTRATION</label>
                        <input
                            id="regInput"
                            type="text"
                            placeholder="AB12 CDE"
                            maxlength="8"
                            class="w-full bg-[#283039] text-white text-xl font-mono text-center uppercase px-4 py-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none"
                        >
                    </div>

                    <div>
                        <label class="text-sm text-gray-400 mb-3 block">WAIT TYPE</label>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <button type="button" class="category-btn border border-gray-700 rounded-xl p-4 flex flex-col items-center gap-2 hover:border-blue-500 focus:outline-none"
                                data-category="awaiting_release" onclick="selectWaitCategory('awaiting_release')">
                                <span class="text-3xl">üö¶</span>
                                <span class="text-sm font-semibold">Awaiting Release</span>
                            </button>
                            <button type="button" class="category-btn border border-gray-700 rounded-xl p-4 flex flex-col items-center gap-2 hover:border-green-500 focus:outline-none"
                                data-category="charging_vehicle" onclick="selectWaitCategory('charging_vehicle')">
                                <span class="text-3xl">üîå</span>
                                <span class="text-sm font-semibold">Charging Vehicle</span>
                            </button>
                            <button type="button" class="category-btn border border-gray-700 rounded-xl p-4 flex flex-col items-center gap-2 hover:border-orange-500 focus:outline-none"
                                data-category="car_wash" onclick="selectWaitCategory('car_wash')">
                                <span class="text-3xl">üßº</span>
                                <span class="text-sm font-semibold">Car Wash</span>
                            </button>
                        </div>
                        <p id="categoryHint" class="text-xs text-gray-500 mt-2 hidden"></p>
                    </div>

                    <div id="timeSelection" class="hidden">
                        <label class="text-sm text-gray-400 mb-3 block">WAIT DURATION</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-gray-400">Hours</span>
                                    <span class="text-xs text-gray-500">0 - 12</span>
                                </div>
                                <select id="hoursSelect" class="w-full bg-[#283039] border border-gray-700 text-white rounded-lg px-3 py-3 focus:outline-none focus:border-blue-500">
                                    <option value="0">0 hours</option>
                                    <option value="1">1 hour</option>
                                    <option value="2">2 hours</option>
                                    <option value="3">3 hours</option>
                                    <option value="4">4 hours</option>
                                    <option value="5">5 hours</option>
                                    <option value="6">6 hours</option>
                                    <option value="7">7 hours</option>
                                    <option value="8">8 hours</option>
                                    <option value="9">9 hours</option>
                                    <option value="10">10 hours</option>
                                    <option value="11">11 hours</option>
                                    <option value="12">12 hours</option>
                                </select>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-gray-400">Minutes</span>
                                    <span class="text-xs text-gray-500">15 min increments</span>
                                </div>
                                <select id="minutesSelect" class="w-full bg-[#283039] border border-gray-700 text-white rounded-lg px-3 py-3 focus:outline-none focus:border-blue-500">
                                    <option value="0">0 minutes</option>
                                    <option value="15">15 minutes</option>
                                    <option value="30">30 minutes</option>
                                    <option value="45">45 minutes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="notesSection" class="hidden">
                        <label class="text-sm text-gray-400 mb-2 block">NOTES</label>
                        <textarea
                            id="notesInput"
                            placeholder="What are the details of this delay?"
                            rows="3"
                            class="w-full bg-[#283039] text-white px-4 py-3 rounded-lg border border-gray-700 focus:border-blue-500 focus:outline-none resize-none"
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">Provide key details so the office can take action quickly.</p>
                    </div>

                    <div class="space-y-3 pt-2">
                        <button id="saveWaitTimeBtn" type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors touch-target disabled:opacity-50 disabled:cursor-not-allowed">
                            Save Wait Time
                        </button>
                        <button type="button" onclick="closeWaitTimeModal()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors touch-target">
                            Discard
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;
        const WAIT_CATEGORIES = {
            awaiting_release: {
                label: 'Awaiting Release',
                icon: 'üö¶',
                badge: 'badge-awaiting',
                hint: 'Use this when you are waiting for a vehicle to be released.'
            },
            charging_vehicle: {
                label: 'Charging Vehicle',
                icon: 'üîå',
                badge: 'badge-charging',
                hint: 'Use this when the vehicle is currently charging.'
            },
            car_wash: {
                label: 'Car Wash',
                icon: 'üßº',
                badge: 'badge-wash',
                hint: 'Use this when the vehicle is being cleaned.'
            }
        };

        let currentSession = null;
        let currentUser = null;
        let unsubscribeWaitTimes = null;
        let selectedWaitCategory = null;
        let isSaving = false;
        const WAIT_TIME_SUBMISSION_QUEUE_KEY = 'wait_time_submission_queue_v1';
        let remoteWaitTimes = [];
        let localWaitTimes = [];

        const notifyError = (message, title = 'Error') => uiDialogs.showAlert({ title, message, tone: 'danger' });
        const notifyWarning = (message, title = 'Heads Up') => uiDialogs.showAlert({ title, message, tone: 'warning' });
        const notifySuccess = (message, title = 'Success') => uiDialogs.showAlert({ title, message, tone: 'success' });
        const notifyInfo = (message, title = 'Notice') => uiDialogs.showAlert({ title, message, tone: 'info' });
        const getCurrentOfficeId = () => currentSession?.officeId || currentUser?.officeId || '';

        function loadWaitTimeQueue() {
            try {
                const raw = localStorage.getItem(WAIT_TIME_SUBMISSION_QUEUE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (error) {
                console.error('Error reading wait time submission queue:', error);
                return [];
            }
        }

        function saveWaitTimeQueue(queue) {
            try {
                localStorage.setItem(WAIT_TIME_SUBMISSION_QUEUE_KEY, JSON.stringify(queue));
            } catch (error) {
                console.error('Error saving wait time submission queue:', error);
            }
        }

        function convertQueueEntryToLocalWaitTime(entry) {
            const base = entry.data || {};
            return {
                id: entry.localId,
                registration: base.registration,
                category: base.category,
                categoryLabel: base.categoryLabel,
                hours: base.hours,
                minutes: base.minutes,
                totalMinutes: base.totalMinutes,
                notes: base.notes || '',
                driverId: base.driverId,
                driverEmail: base.driverEmail,
                driverName: base.driverName,
                officeId: base.officeId,
                processingStatus: 'pending',
                createdAt: entry.createdAt,
                updatedAt: entry.createdAt,
                isLocal: true
            };
        }

        function loadLocalWaitTimesFromQueue() {
            const queue = loadWaitTimeQueue();
            localWaitTimes = queue.map(convertQueueEntryToLocalWaitTime);
        }

        function addLocalWaitTimeEntry(queueEntry) {
            const localEntry = convertQueueEntryToLocalWaitTime(queueEntry);
            localWaitTimes.push(localEntry);
        }

        function removeLocalWaitTime(localId) {
            const index = localWaitTimes.findIndex(item => item.id === localId);
            if (index >= 0) {
                localWaitTimes.splice(index, 1);
            }
        }

        function queueWaitTimeForSync(baseData, options = {}) {
            if (!currentUser) return;

            const localId = `local-wait-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const createdAt = Date.now();
            const entry = {
                localId,
                createdAt,
                data: {
                    ...baseData,
                    driverId: currentUser.uid,
                    driverEmail: currentUser.email || '',
                    driverName: baseData.driverName,
                    officeId: currentUser.officeId || ''
                }
            };

            const queue = loadWaitTimeQueue();
            queue.push(entry);
            saveWaitTimeQueue(queue);
            addLocalWaitTimeEntry(entry);
            renderWaitTimes();

            if (!options?.silent) {
                notifyInfo('Saved offline. We will sync this wait time when you are back online.', 'Queued Offline');
            }

            if (navigator.onLine) {
                syncWaitTimeQueue({ showToast: false });
            }
        }

        async function syncWaitTimeQueue(options = {}) {
            if (!navigator.onLine || !currentUser) {
                return;
            }

            const queue = loadWaitTimeQueue();
            if (!queue.length) {
                return;
            }

            const remaining = [];
            let processedCount = 0;
            const officeId = getCurrentOfficeId();
            if (!officeId) {
                console.warn('Missing office context while syncing wait time queue.');
                return;
            }

            for (const entry of queue) {
                try {
                    const data = entry.data || {};
                    const firestoreData = {
                        driverId: currentUser.uid,
                        driverEmail: data.driverEmail || currentUser.email || '',
                        driverName: data.driverName ||
                            currentUser.name ||
                            `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() ||
                            'Driver',
                        officeId: data.officeId || officeId,
                        registration: data.registration,
                        category: data.category,
                        categoryLabel: data.categoryLabel,
                        hours: data.hours,
                        minutes: data.minutes,
                        totalMinutes: data.totalMinutes,
                        notes: data.notes || '',
                        processingStatus: 'pending',
                        createdAt: entry.createdAt ?
                            window.Timestamp.fromMillis(entry.createdAt) :
                            window.serverTimestamp(),
                        updatedAt: window.serverTimestamp()
                    };

                    await window.addDoc(window.collection(window.db, 'waitTimes'), firestoreData);
                    removeLocalWaitTime(entry.localId);
                    processedCount += 1;
                } catch (error) {
                    console.error('Error syncing queued wait time:', error);
                    remaining.push(entry);
                }
            }

            saveWaitTimeQueue(remaining);
            if (processedCount > 0) {
                renderWaitTimes();
                if (options?.showToast) {
                    notifySuccess(`${processedCount} wait time${processedCount === 1 ? '' : 's'} synced successfully.`, 'Back Online');
                }
            }
        }

        async function initializeDriverWaitTimesApp() {
            console.log('Initializing driver wait times page...');

            try {
                const session = await window.sotoSession.bootstrap(['driver']);
                if (!session) {
                    window.location.href = '/pages/soto-routes-login.html';
                    return;
                }

                currentSession = session;

                const userDoc = await window.getDoc(window.doc(window.db, 'users', session.uid));
                if (!userDoc.exists()) {
                    window.location.href = '/pages/soto-routes-login.html';
                    return;
                }

                currentUser = { uid: session.uid, ...session, ...userDoc.data() };
                if (currentUser.role !== 'driver') {
                    notifyWarning('This page is for drivers only.', 'Access Denied');
                    window.location.href = '/pages/soto-lp.html';
                    return;
                }

                loadLocalWaitTimesFromQueue();
                renderWaitTimes();
                await syncWaitTimeQueue({ showToast: false });
                window.addEventListener('online', () => syncWaitTimeQueue({ showToast: true }));

                await backfillWaitTimesOffice();

                document.getElementById('loadingOverlay').style.display = 'none';
                attachFormInteractions();
                startWaitTimesListener();
            } catch (error) {
        async function backfillWaitTimesOffice() {
            const officeId = getCurrentOfficeId();
            if (!officeId) return;

            try {
                const legacyQuery = window.query(
                    window.collection(window.db, 'waitTimes'),
                    window.where('driverId', '==', currentUser.uid)
                );
                const snapshot = await window.getDocs(legacyQuery);
                const updates = snapshot.docs
                    .filter(doc => {
                        const data = doc.data();
                        return !data.officeId;
                    })
                    .map(doc => window.updateDoc(doc.ref, { officeId }));
                if (updates.length > 0) {
                    await Promise.allSettled(updates);
                }
            } catch (error) {
                console.warn('Failed to backfill wait time office IDs:', error);
            }
        }

                console.error('Error loading driver profile:', error);
                notifyError('Unable to load your profile. Please try again.');
            }
        }

        function attachFormInteractions() {
            const form = document.getElementById('waitTimeForm');
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                saveWaitTime();
            });

            document.getElementById('regInput').addEventListener('input', (event) => {
                const cleaned = event.target.value.toUpperCase().replace(/[^A-Z0-9 ]/g, '');
                event.target.value = cleaned;
                validateWaitTimeForm();
            });

            document.getElementById('hoursSelect').addEventListener('change', validateWaitTimeForm);
            document.getElementById('minutesSelect').addEventListener('change', validateWaitTimeForm);
            document.getElementById('notesInput').addEventListener('input', validateWaitTimeForm);
        }

        function startWaitTimesListener() {
            if (unsubscribeWaitTimes) {
                unsubscribeWaitTimes();
            }

            const officeId = getCurrentOfficeId();
            if (!officeId) {
                console.warn('No office context for wait time listener.');
                return;
            }

            const waitTimesQuery = window.query(
                window.collection(window.db, 'waitTimes'),
                window.where('driverId', '==', currentUser.uid),
                window.where('officeId', '==', officeId)
            );

            unsubscribeWaitTimes = window.onSnapshot(waitTimesQuery, (snapshot) => {
                remoteWaitTimes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                snapshot.docs.forEach(async (docSnap) => {
                    const data = docSnap.data();
                    if (!data.officeId) {
                        try {
                            await window.updateDoc(docSnap.ref, { officeId });
                        } catch (error) {
                            console.warn(`Failed to backfill officeId for wait time ${docSnap.id}:`, error);
                        }
                    }
                });
                renderWaitTimes();
            }, (error) => {
                console.error('Error listening for wait times:', error);
                if (navigator.onLine) {
                    notifyError('Could not load wait times.');
                }
            });
        }

        function renderWaitTimes() {
            const waitTimes = [...localWaitTimes, ...remoteWaitTimes];
            waitTimes.sort((a, b) => {
                const aTime = toDate(a.createdAt)?.getTime() || 0;
                const bTime = toDate(b.createdAt)?.getTime() || 0;
                return bTime - aTime;
            });
            const pending = waitTimes.filter(item => (item.processingStatus || 'pending') !== 'processed');
            const processed = waitTimes.filter(item => {
                if ((item.processingStatus || 'pending') !== 'processed') return false;
                const processedAt = toDate(item.processedAt);
                if (!processedAt) return false;
                return Date.now() - processedAt.getTime() <= THREE_DAYS_MS;
            });

            document.getElementById('pendingSection').classList.toggle('hidden', pending.length === 0);
            document.getElementById('processedSection').classList.toggle('hidden', processed.length === 0);
            document.getElementById('emptyState').classList.toggle('hidden', waitTimes.length > 0);

            renderWaitTimeList(pending, 'pendingList', { allowDelete: false, showProcessedMeta: false });
            renderWaitTimeList(processed, 'processedList', { allowDelete: false, showProcessedMeta: true });
        }

        function renderWaitTimeList(items, containerId, options = {}) {
            const container = document.getElementById(containerId);
            if (!items.length) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = items.map(item => renderWaitTimeCard(item, options)).join('');
        }

        function renderWaitTimeCard(item, options) {
            const category = WAIT_CATEGORIES[item.category] || {
                label: 'Other',
                icon: '‚è±Ô∏è',
                badge: 'badge-awaiting'
            };
            const totalMinutes = typeof item.totalMinutes === 'number'
                ? item.totalMinutes
                : ((item.hours || 0) * 60) + (item.minutes || 0);
            const createdAt = toDate(item.createdAt);
            const processedAt = toDate(item.processedAt);
            const submittedText = createdAt ? `Submitted ${formatRelativeTime(createdAt)}` : 'Submission time unavailable';
            const processedText = processedAt ? `Processed ${formatRelativeTime(processedAt)}` : '';
            const processedBy = item.processedByName || item.processedBy || '';
            const processedMeta = options.showProcessedMeta && processedText ? `
                <div class="flex items-center gap-2 text-sm text-green-400">
                    <span class="material-symbols-outlined text-base">task_alt</span>
                    <span>${processedText}</span>
                </div>
                ${processedBy ? `<p class="text-xs text-gray-500">Processed by ${escapeHtml(processedBy)}</p>` : ''}
            ` : '';

            return `
                <article class="bg-[#1a1f24] border border-gray-800 rounded-2xl p-4 sm:p-5 shadow-sm">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex flex-wrap items-center gap-3">
                            <span class="license-plate">${escapeHtml(item.registration || 'UNKNOWN')}</span>
                            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${category.badge}">
                                <span>${category.icon}</span>
                                ${category.label}
                            </span>
                            ${item.isLocal ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold text-orange-300 bg-orange-500/10">
                                <span class="material-symbols-outlined text-sm">cloud_off</span>Awaiting Sync
                            </span>` : ''}
                        </div>
                    </div>
                    <div class="mt-4 flex flex-wrap items-center gap-4 text-sm text-gray-300">
                        <div class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-base text-blue-400">schedule</span>
                            <span>${formatDuration(totalMinutes)}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-base text-gray-400">today</span>
                            <span>${submittedText}</span>
                        </div>
                    </div>
                    ${item.notes ? `
                    <div class="mt-4 bg-[#1f2730] border border-[#2f3944] rounded-xl p-3 text-sm text-gray-200">
                        <p class="text-xs text-gray-400 mb-1">NOTES</p>
                        <p class="leading-relaxed">${escapeHtml(item.notes)}</p>
                    </div>
                    ` : ''}
                    ${item.originalTotalMinutes && item.originalTotalMinutes !== totalMinutes ? `
                    <div class="mt-3 bg-[#1f2730] border border-[#2f3944] rounded-xl p-3 text-sm text-gray-200">
                        <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Adjustment Summary</p>
                        <div class="flex flex-wrap gap-4">
                            <span>Original: <span class="font-semibold">${formatDuration(item.originalTotalMinutes)}</span></span>
                            <span>Updated: <span class="font-semibold">${formatDuration(totalMinutes)}</span></span>
                        </div>
                    </div>
                    ` : ''}
                    ${processedMeta ? `<div class="mt-3">${processedMeta}</div>` : ''}
                </article>
            `;
        }

        function selectWaitCategory(category) {
            selectedWaitCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            const hintEl = document.getElementById('categoryHint');
            const categoryInfo = WAIT_CATEGORIES[category];
            if (categoryInfo && categoryInfo.hint) {
                hintEl.textContent = categoryInfo.hint;
                hintEl.classList.remove('hidden');
            } else {
                hintEl.classList.add('hidden');
            }

            document.getElementById('timeSelection').classList.remove('hidden');
            document.getElementById('notesSection').classList.remove('hidden');
            validateWaitTimeForm();
        }

        async function saveWaitTime() {
            if (isSaving) {
                return;
            }

            const regInput = document.getElementById('regInput');
            const hoursSelect = document.getElementById('hoursSelect');
            const minutesSelect = document.getElementById('minutesSelect');
            const notesInput = document.getElementById('notesInput');
            const saveBtn = document.getElementById('saveWaitTimeBtn');

            const registration = normalizeRegistration(regInput.value);
            const hours = parseInt(hoursSelect.value, 10) || 0;
            const minutes = parseInt(minutesSelect.value, 10) || 0;
            const totalMinutes = (hours * 60) + minutes;
            const notes = (notesInput.value || '').trim();

            if (!registration) {
                notifyWarning('Enter the vehicle registration.');
                regInput.focus();
                return;
            }

            if (!selectedWaitCategory) {
                notifyWarning('Select a wait type before saving.');
                return;
            }

            if (totalMinutes <= 0) {
                notifyWarning('Wait time must be at least 15 minutes.');
                return;
            }

            if (!notes) {
                notifyWarning('Add details explaining the wait time.');
                notesInput.focus();
                return;
            }

            const driverName = currentUser?.name ||
                `${currentUser?.firstName || ''} ${currentUser?.lastName || ''}`.trim() ||
                'Driver';

            const baseData = {
                driverName,
                registration,
                category: selectedWaitCategory,
                categoryLabel: WAIT_CATEGORIES[selectedWaitCategory]?.label || selectedWaitCategory,
                hours,
                minutes,
                totalMinutes,
                notes
            };

            const waitTimeData = {
                driverId: currentUser.uid,
                driverEmail: currentUser.email || '',
                driverName,
                officeId: currentUser.officeId || '',
                registration,
                category: selectedWaitCategory,
                categoryLabel: WAIT_CATEGORIES[selectedWaitCategory]?.label || selectedWaitCategory,
                hours,
                minutes,
                totalMinutes,
                notes,
                processingStatus: 'pending',
                createdAt: window.serverTimestamp(),
                updatedAt: window.serverTimestamp()
            };

            isSaving = true;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                if (!navigator.onLine) {
                    queueWaitTimeForSync(baseData);
                    closeWaitTimeModal();
                    return;
                }

                await window.addDoc(window.collection(window.db, 'waitTimes'), waitTimeData);
                notifySuccess('Wait time saved.');
                closeWaitTimeModal();
            } catch (error) {
                console.error('Error saving wait time:', error);
                queueWaitTimeForSync(baseData, { silent: true });
                notifyWarning('No connection detected. Saved locally and will sync when online.', 'Saved Offline');
                closeWaitTimeModal();
            } finally {
                isSaving = false;
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Wait Time';
                validateWaitTimeForm();
            }
        }

        function openWaitTimeModal() {
            resetWaitTimeForm();
            document.getElementById('waitTimeModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('regInput').focus(), 50);
        }

        function closeWaitTimeModal() {
            document.getElementById('waitTimeModal').classList.add('hidden');
            resetWaitTimeForm();
        }

        function resetWaitTimeForm() {
            const form = document.getElementById('waitTimeForm');
            form.reset();
            selectedWaitCategory = null;
            document.getElementById('categoryHint').classList.add('hidden');
            document.getElementById('timeSelection').classList.add('hidden');
            document.getElementById('notesSection').classList.add('hidden');
            document.getElementById('notesInput').value = '';
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            isSaving = false;
            validateWaitTimeForm();
        }

        function validateWaitTimeForm() {
            const reg = normalizeRegistration(document.getElementById('regInput').value);
            const hours = parseInt(document.getElementById('hoursSelect').value, 10) || 0;
            const minutes = parseInt(document.getElementById('minutesSelect').value, 10) || 0;
            const totalMinutes = (hours * 60) + minutes;
            const notes = (document.getElementById('notesInput').value || '').trim();
            const saveBtn = document.getElementById('saveWaitTimeBtn');

            const isValid = Boolean(reg) && Boolean(selectedWaitCategory) && totalMinutes > 0 && Boolean(notes) && !isSaving;
            saveBtn.disabled = !isValid;
        }

        function formatDuration(totalMinutes) {
            const minutes = Math.max(totalMinutes || 0, 0);
            const hrs = Math.floor(minutes / 60);
            const mins = minutes % 60;
            const parts = [];
            if (hrs > 0) {
                parts.push(`${hrs}h`);
            }
            if (mins > 0) {
                parts.push(`${mins}m`);
            }
            return parts.length ? parts.join(' ') : '0m';
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now.getTime() - date.getTime();
            const diffMinutes = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMinutes < 1) return 'Just now';
            if (diffMinutes < 60) return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
            return date.toLocaleString();
        }

        function toDate(value) {
            if (!value) return null;
            if (value instanceof Date) return value;
            if (value.toDate) return value.toDate();
            if (typeof value === 'number') return new Date(value);
            if (typeof value === 'string') return new Date(value);
            return null;
        }

        function normalizeRegistration(registration) {
            return (registration || '')
                .toUpperCase()
                .replace(/[^A-Z0-9 ]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return text
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        async function logout() {
            try {
                await window.signOut(window.auth);
            } catch (error) {
                console.error('Error during sign out:', error);
            } finally {
                window.sotoSession?.clearSession();
                window.location.href = '/pages/soto-routes-login.html';
            }
        }

        function goToPortal() {
            window.location.href = '/pages/driver-portal.html';
        }
    </script>
</body>
</html>

