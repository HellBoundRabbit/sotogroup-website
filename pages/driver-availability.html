<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Availability - SOTO Routes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, where, updateDoc, doc, deleteDoc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkXzYFC1jQcA6yw6qY1Ao3luEYU4Rd0yA",
            authDomain: "soto-routes.firebaseapp.com",
            projectId: "soto-routes",
            storageBucket: "soto-routes.firebasestorage.app",
            messagingSenderId: "440989695549",
            appId: "1:440989695549:web:0bce8b92a46f7f79953454",
            measurementId: "G-4E3G40QQ9L"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseLimit = limit;
        window.firebaseWhere = where;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDoc = doc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.serverTimestamp = serverTimestamp;
        
        // Make individual functions globally accessible
        window.query = query;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.where = where;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.signOut = signOut;
        
        console.log('Firebase initialized successfully!');
        
        // Initialize the app after Firebase is ready
        initializeDriverAvailabilityApp();
    </script>
    <style>
        .touch-target { min-height: 44px; min-width: 44px; }
        
        .day-card {
            transition: all 0.2s ease;
        }
        
        .day-card.available {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
        }
        
        .day-card.unavailable {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #ef4444;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        /* Calendar days container */
        #calendarDays {
            display: contents;
        }
    </style>
</head>
<body class="bg-[#0f1419] text-white min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-400">Loading availability...</p>
        </div>
    </div>

    <!-- Top Navigation -->
    <div class="bg-[#1a1f24] border-b border-gray-800 sticky top-0 z-50">
        <div class="flex items-center justify-between px-4 py-3">
            <button onclick="window.location.href='/pages/driver-portal.html'" class="touch-target flex items-center text-gray-400 hover:text-white transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1 class="text-xl font-semibold">My Availability</h1>
            <button onclick="location.reload()" class="touch-target flex items-center text-gray-400 hover:text-white transition-colors">
                <span class="material-symbols-outlined">refresh</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container max-w-2xl mx-auto px-4 py-6">
        
        <!-- Instructions -->
        <div class="bg-blue-900 bg-opacity-20 border border-blue-500 rounded-lg p-4 mb-6">
            <div class="flex gap-3">
                <span class="material-symbols-outlined text-blue-400">info</span>
                <div class="flex-1">
                    <p class="text-sm text-blue-200">Tap a day to mark yourself as unavailable. Green days mean you're working, red days mean you're off.</p>
                </div>
            </div>
        </div>

        <!-- Month Selector -->
        <div class="bg-[#1a1f24] rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <button onclick="previousMonth()" class="touch-target p-2 hover:bg-[#283039] rounded-lg transition-colors">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <h2 id="monthYear" class="text-xl font-semibold"></h2>
                <button onclick="nextMonth()" class="touch-target p-2 hover:bg-[#283039] rounded-lg transition-colors">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
            </div>
        </div>

        <!-- Calendar -->
        <div class="grid grid-cols-5 gap-2 mb-6">
            <!-- Day headers -->
            <div class="text-center text-sm text-gray-400 font-semibold py-2">Mon</div>
            <div class="text-center text-sm text-gray-400 font-semibold py-2">Tue</div>
            <div class="text-center text-sm text-gray-400 font-semibold py-2">Wed</div>
            <div class="text-center text-sm text-gray-400 font-semibold py-2">Thu</div>
            <div class="text-center text-sm text-gray-400 font-semibold py-2">Fri</div>
            
            <!-- Calendar days will be inserted here by renderCalendar() -->
        </div>

        <!-- Legend -->
        <div class="bg-[#1a1f24] rounded-lg p-4">
            <h3 class="text-sm font-semibold mb-3 text-gray-400">LEGEND</h3>
            <div class="space-y-2">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-green-500 to-green-600 border-2 border-green-500"></div>
                    <span class="text-sm">Available / Working</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-red-500 to-red-600 border-2 border-red-500"></div>
                    <span class="text-sm">Unavailable / Day Off</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-[#283039] border-2 border-gray-700"></div>
                    <span class="text-sm">Past Day</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        let currentUser = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let availability = {}; // { 'YYYY-MM-DD': true/false }

        // Check for unread messages
        async function checkForUnreadMessages() {
            try {
                if (!currentUser || !currentUser.officeId) return false;
                
                const messagesQuery = window.query(
                    window.collection(window.db, 'messages'),
                    window.where('officeId', '==', currentUser.officeId),
                    window.where('published', '==', true)
                );
                const snapshot = await window.getDocs(messagesQuery);
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const readMessages = JSON.parse(localStorage.getItem('driver_read_messages') || '[]');
                const unreadMessages = messages.filter(msg => !readMessages.includes(msg.id));
                
                return unreadMessages.length > 0;
            } catch (error) {
                console.error('Error checking messages:', error);
                return false; // If check fails, allow access
            }
        }

        // Initialize function
        function initializeDriverAvailabilityApp() {
            console.log('Initializing driver availability app...');
            
            window.auth.onAuthStateChanged(async function(user) {
                console.log('Auth state changed:', user ? 'User logged in' : 'No user');
                
                if (!user) {
                    window.location.href = '/pages/soto-routes-login.html';
                    return;
                }

                try {
                    console.log('Loading user data for:', user.uid);
                    const userDoc = await window.getDoc(window.doc(window.db, 'users', user.uid));
                    if (!userDoc.exists()) {
                        console.log('User document not found');
                        window.location.href = '/pages/soto-routes-login.html';
                        return;
                    }

                    currentUser = { uid: user.uid, ...userDoc.data() };
                    console.log('Current user:', currentUser);
                    
                    // Only drivers can access
                    if (currentUser.role !== 'driver') {
                        alert('Access denied. This page is for drivers only.');
                        window.location.href = '/pages/soto-lp.html';
                        return;
                    }

                    // Check for unread messages
                    const hasUnreadMessages = await checkForUnreadMessages();
                    if (hasUnreadMessages) {
                        alert('There are outstanding messages that need to be read before proceeding. Please read all messages first.');
                        window.location.href = '/pages/driver-messages.html';
                        return;
                    }

                    console.log('Loading availability...');
                    await loadAvailability();
                    renderCalendar();
                    document.getElementById('loadingOverlay').style.display = 'none';
                    console.log('Loading complete!');
                } catch (error) {
                    console.error('Error loading user data:', error);
                    console.error('Error details:', error.message);
                    console.error('Error stack:', error.stack);
                    alert('Error loading user data. Please try again.');
                }
            });
        }

        // Load availability from Firebase
        async function loadAvailability() {
            try {
                // Load availability for this month and next month
                const startDate = new Date(currentYear, currentMonth, 1);
                const endDate = new Date(currentYear, currentMonth + 2, 0); // Last day of next month

                // Get all dates in range
                const dateStrings = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    dateStrings.push(d.toISOString().split('T')[0]); // YYYY-MM-DD
                }

                // Batch read all documents at once
                const docPromises = dateStrings.map(dateStr => 
                    window.getDoc(window.doc(window.db, 'calendar', dateStr))
                );
                const docSnapshots = await Promise.all(docPromises);

                // Process results
                dateStrings.forEach((dateString, index) => {
                    const doc = docSnapshots[index];
                    
                    if (doc.exists()) {
                        const data = doc.data();
                        const driversOff = data.driversOff || [];
                        
                        // Check if this driver is in the driversOff array
                        availability[dateString] = !driversOff.includes(currentUser.uid);
                    } else {
                        // No record means driver is available by default
                        availability[dateString] = true;
                    }
                });

                console.log('Loaded availability:', Object.keys(availability).length, 'dates');
            } catch (error) {
                console.error('Error loading availability:', error);
            }
        }

        // Render calendar
        function renderCalendar() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('monthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const calendarHTML = [];
            
            // Get the day of week for the first day (0=Sunday, 1=Monday, etc.)
            let firstDayOfWeek = firstDay.getDay();
            // Convert to Monday=0 format (Mon=0, Tue=1, Wed=2, Thu=3, Fri=4)
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            // Ensure it's a weekday (0-4)
            firstDayOfWeek = firstDayOfWeek > 4 ? 0 : firstDayOfWeek;
            
            // Add empty cells for days before the first weekday
            for (let i = 0; i < firstDayOfWeek; i++) {
                calendarHTML.push('<div></div>'); // Empty cell
            }
            
            // Generate calendar days (weekdays only)
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const cellDate = new Date(currentYear, currentMonth, day);
                const dayOfWeek = cellDate.getDay();
                
                // Skip weekends (Saturday = 6, Sunday = 0)
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    continue;
                }
                
                const dateString = cellDate.toISOString().split('T')[0];
                const isPast = cellDate < today;
                const isAvailable = availability[dateString] !== false;
                
                // Check if date is within 7 days (locked)
                const daysFromToday = Math.floor((cellDate - today) / (1000 * 60 * 60 * 24));
                const isLocked = daysFromToday <= 7 && daysFromToday >= 0;

                let className = 'day-card aspect-square rounded-lg border-2 flex flex-col items-center justify-center cursor-pointer transition-all relative';
                
                if (isPast) {
                    className += ' bg-[#283039] border-gray-700 cursor-not-allowed opacity-50';
                } else if (isLocked) {
                    className += isAvailable ? ' available border-yellow-500' : ' unavailable border-yellow-500';
                } else if (isAvailable) {
                    className += ' available';
                } else {
                    className += ' unavailable';
                }

                const dayNumber = cellDate.getDate();
                const clickHandler = isPast || isLocked ? '' : `onclick="toggleAvailability('${dateString}')"`;

                calendarHTML.push(`
                    <div class="${className}" ${clickHandler}>
                        <span class="text-lg font-semibold">${dayNumber}</span>
                        ${isLocked ? '<span class="material-symbols-outlined text-xs text-yellow-500 absolute top-1 right-1">lock</span>' : ''}
                    </div>
                `);
            }

            // Get the calendar grid container
            const calendarContainer = document.querySelector('.grid-cols-5');
            if (!calendarContainer) return;
            
            // Remove the old calendar days div if it exists
            const oldCalendarDays = document.getElementById('calendarDays');
            if (oldCalendarDays) {
                oldCalendarDays.remove();
            }
            
            // Create a new div for calendar days
            const calendarDaysDiv = document.createElement('div');
            calendarDaysDiv.id = 'calendarDays';
            calendarDaysDiv.className = 'contents'; // Use CSS Grid contents to make children participate in parent grid
            calendarDaysDiv.innerHTML = calendarHTML.join('');
            
            // Find where to insert it (after the day headers)
            const dayHeaders = calendarContainer.querySelectorAll('.text-center.text-sm.text-gray-400.font-semibold');
            if (dayHeaders.length > 0) {
                // Insert after the last day header
                dayHeaders[dayHeaders.length - 1].after(calendarDaysDiv);
            }
        }

        // Toggle availability for a specific day
        async function toggleAvailability(dateString) {
            const isCurrentlyAvailable = availability[dateString] !== false;
            const newAvailability = !isCurrentlyAvailable;

            try {
                // Update local state immediately for responsiveness
                availability[dateString] = newAvailability;
                renderCalendar();

                // Update Firebase
                const calendarRef = window.doc(window.db, 'calendar', dateString);
                const calendarDoc = await window.getDoc(calendarRef);

                let driversOff = [];
                if (calendarDoc.exists()) {
                    driversOff = calendarDoc.data().driversOff || [];
                }

                // Add or remove driver from driversOff array
                if (newAvailability) {
                    // Driver is now available, remove from driversOff
                    driversOff = driversOff.filter(id => id !== currentUser.uid);
                } else {
                    // Driver is now unavailable, add to driversOff
                    if (!driversOff.includes(currentUser.uid)) {
                        driversOff.push(currentUser.uid);
                    }
                }

                // Save to Firebase
                await window.setDoc(calendarRef, {
                    date: dateString,
                    driversOff: driversOff,
                    updatedAt: window.serverTimestamp()
                }, { merge: true });

                // Create notification for availability change
                await createAvailabilityChangeNotification(dateString, newAvailability);

                console.log(`Updated availability for ${dateString}:`, newAvailability);
            } catch (error) {
                console.error('Error updating availability:', error);
                // Revert local state on error
                availability[dateString] = isCurrentlyAvailable;
                renderCalendar();
                alert('Error updating availability. Please try again.');
            }
        }

        // Previous month
        async function previousMonth() {
            // Show loading overlay
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            
            await loadAvailability();
            renderCalendar();
            
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Next month
        async function nextMonth() {
            // Show loading overlay
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            
            await loadAvailability();
            renderCalendar();
            
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Go back to expenses
        function goToExpenses() {
            window.location.href = '/pages/driver-expenses.html';
        }

        // Create notification when driver changes availability
        async function createAvailabilityChangeNotification(dateString, isNowAvailable) {
            try {
                if (!currentUser || !currentUser.officeId) {
                    console.error('No user or officeId for notification');
                    return;
                }

                // Get driver information from drivers collection
                const driversQuery = window.query(
                    window.collection(window.db, 'drivers'),
                    window.where('uid', '==', currentUser.uid)
                );
                const driversSnapshot = await window.getDocs(driversQuery);
                
                let driverName = currentUser.name || `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim();
                if (driversSnapshot.docs.length > 0) {
                    const driverData = driversSnapshot.docs[0].data();
                    driverName = `${driverData.firstName || ''} ${driverData.lastName || ''}`.trim() || driverName;
                }

                // Format date for display
                const date = new Date(dateString);
                const formattedDate = date.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                // Create notification data
                const notificationData = {
                    type: 'availability_change',
                    driverId: currentUser.uid,
                    driverName: driverName,
                    date: dateString,
                    formattedDate: formattedDate,
                    officeId: currentUser.officeId,
                    createdAt: new Date(),
                    seen: false, // Track if office has seen this specific change
                    changeType: isNowAvailable ? 'available' : 'unavailable', // 'available' = changed back to working, 'unavailable' = booked off
                    message: isNowAvailable 
                        ? `${driverName} has changed ${formattedDate} back to available`
                        : `${driverName} has booked ${formattedDate} off`
                };

                // Save notification to Firebase
                await window.addDoc(window.collection(window.db, 'availabilityNotifications'), notificationData);

                console.log('âœ… Availability change notification created:', notificationData);
            } catch (error) {
                console.error('Error creating availability change notification:', error);
            }
        }
    </script>
</body>
</html>

