<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SOTO Routes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="/manifest.json">
    <title>Driver Portal | SOTO Routes</title>
    <script src="/assets/js/tailwind-runtime.js"></script>
    <script src="/js/session-manager.js"></script>
    <script src="../js/ui-dialogs.js"></script>
    <!-- Offline Storage & Upload Queue System -->
    <script src="/js/expense-offline-storage.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body {
            font-family: Inter, "Noto Sans", sans-serif;
        }
        .glass-card {
            background: rgba(26, 31, 36, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .spinner-wrapper {
            width: 56px;
            height: 56px;
            position: relative;
            margin: 0 auto;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            /* animation: spinning82341 1.7s linear infinite; */
            filter: blur(1px);
        }
        .spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-image: linear-gradient(rgb(186, 66, 255) 35%, rgb(0, 225, 255));
            box-shadow: 0px -5px 20px 0px rgb(186, 66, 255), 0px 5px 20px 0px rgb(0, 225, 255);
        }
        .spinner-red {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            /* animation: spinning82341 1.7s linear infinite; */
            filter: blur(1px);
        }
        .spinner-red::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-image: linear-gradient(rgb(255, 0, 0) 35%, rgb(255, 100, 100));
            box-shadow: 0px -5px 20px 0px rgb(255, 0, 0), 0px 5px 20px 0px rgb(255, 100, 100);
        }
        .spinner-orange {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            /* animation: spinning82341 1.7s linear infinite; */
            filter: blur(1px);
        }
        .spinner-orange::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-image: linear-gradient(rgb(255, 140, 0) 35%, rgb(255, 180, 60));
            box-shadow: 0px -5px 20px 0px rgb(255, 140, 0), 0px 5px 20px 0px rgb(255, 180, 60);
        }
        .spinner1 {
            background-color: rgb(36, 36, 36);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        .spinner-icon {
            position: relative;
            z-index: 3;
            color: white;
            font-size: 1.875rem;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            filter: none !important;
        }
        .logo-wrapper {
            width: 64px;
            height: 64px;
            position: relative;
            margin: 0 auto;
        }
        .logo-spinner {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            /* animation: spinning82341 1.7s linear infinite; */
            filter: blur(1px);
        }
        .logo-spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-image: linear-gradient(rgb(186, 66, 255) 35%, rgb(0, 225, 255));
            box-shadow: 0px -5px 20px 0px rgb(186, 66, 255), 0px 5px 20px 0px rgb(0, 225, 255);
        }
        .logo-inner {
            background-color: rgb(36, 36, 36);
            width: 52px;
            height: 52px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        .logo-svg {
            position: relative;
            z-index: 3;
            filter: none !important;
        }
        .feature-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 16px;
            transition: opacity 0.2s;
        }
        .feature-button:hover {
            opacity: 0.8;
        }
        .feature-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .home-button .feature-button {
            box-shadow: 0 0 0 2px rgb(0, 225, 255), 0 0 0 4px rgb(186, 66, 255);
            border-radius: 12px;
        }
        .account-view .portal-buttons {
            display: none;
        }
        .account-view .account-buttons {
            display: flex;
        }
        .portal-view .account-buttons {
            display: none;
        }
        .portal-view .home-button {
            display: none;
        }
        .account-view .account-button {
            display: none;
        }
        .features-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        .features-grid-single {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
        }
        @keyframes spinning82341 {
            to {
                transform: rotate(360deg);
            }
        }
        @keyframes spinning82341-counter {
            to {
                transform: rotate(-360deg);
            }
        }
    </style>
</head>
<body class="bg-black text-white" style='font-family: Inter, "Noto Sans", sans-serif;'>
    <!-- Upload Banner (shown when uploading) -->
    <div id="uploadBanner" class="hidden fixed top-0 left-0 right-0 bg-orange-600 text-white z-[100] shadow-lg">
        <div class="flex items-center justify-center gap-3 px-4 py-2">
            <span class="material-symbols-outlined animate-pulse">cloud_upload</span>
            <div class="flex flex-col items-center flex-1">
                <span id="uploadBannerText" class="font-semibold text-sm">Uploading expenses...</span>
                <span id="uploadBannerSubtitle" class="text-xs opacity-90">Uploading photos...</span>
                <!-- Progress bar -->
                <div id="uploadProgressBar" class="w-full max-w-xs mt-2 h-1.5 bg-white bg-opacity-20 rounded-full overflow-hidden">
                    <div id="uploadProgressFill" class="h-full bg-white transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner-wrapper mx-auto mb-4">
                <div class="spinner"></div>
                <div class="spinner1"></div>
            </div>
            <p class="text-gray-400">Loading...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="min-h-screen flex flex-col px-6 py-8 portal-view">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="mb-4">
                <div class="logo-wrapper">
                    <div class="logo-spinner"></div>
                    <div class="logo-inner">
                        <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 logo-svg text-white">
                            <path d="M13.8261 17.4264C16.7203 18.1174 20.2244 18.5217 24 18.5217C27.7756 18.5217 31.2797 18.1174 34.1739 17.4264C36.9144 16.7722 39.9967 15.2331 41.3563 14.1648L24.8486 40.6391C24.4571 41.267 23.5429 41.267 23.1514 40.6391L6.64374 14.1648C8.00331 15.2331 11.0856 16.7722 13.8261 17.4264Z" fill="currentColor"></path>
                            <path clip-rule="evenodd" d="M39.998 12.236C39.9944 12.2537 39.9875 12.2845 39.9748 12.3294C39.9436 12.4399 39.8949 12.5741 39.8346 12.7175C39.8168 12.7597 39.7989 12.8007 39.7813 12.8398C38.5103 13.7113 35.9788 14.9393 33.7095 15.4811C30.9875 16.131 27.6413 16.5217 24 16.5217C20.3587 16.5217 17.0125 16.131 14.2905 15.4811C12.0012 14.9346 9.44505 13.6897 8.18538 12.8168C8.17384 12.7925 8.16216 12.767 8.15052 12.7408C8.09919 12.6249 8.05721 12.5114 8.02977 12.411C8.00356 12.3152 8.00039 12.2667 8.00004 12.2612C8.00004 12.261 8 12.2607 8.00004 12.2612C8.00004 12.2359 8.0104 11.9233 8.68485 11.3686C9.34546 10.8254 10.4222 10.2469 11.9291 9.72276C14.9242 8.68098 19.1919 8 24 8C28.8081 8 33.0758 8.68098 36.0709 9.72276C37.5778 10.2469 38.6545 10.8254 39.3151 11.3686C39.9006 11.8501 39.9857 12.1489 39.998 12.236ZM4.95178 15.2312L21.4543 41.6973C22.6288 43.5809 25.3712 43.5809 26.5457 41.6973L43.0534 15.223C43.0709 15.1948 43.0878 15.1662 43.104 15.1371L41.3563 14.1648C43.104 15.1371 43.1038 15.1374 43.104 15.1371L43.1051 15.135L43.1065 15.1325L43.1101 15.1261L43.1199 15.1082C43.1276 15.094 43.1377 15.0754 43.1497 15.0527C43.1738 15.0075 43.2062 14.9455 43.244 14.8701C43.319 14.7208 43.4196 14.511 43.5217 14.2683C43.6901 13.8679 44 13.0689 44 12.2609C44 10.5573 43.003 9.22254 41.8558 8.2791C40.6947 7.32427 39.1354 6.55361 37.385 5.94477C33.8654 4.72057 29.133 4 24 4C18.867 4 14.1346 4.72057 10.615 5.94478C8.86463 6.55361 7.30529 7.32428 6.14419 8.27911C4.99695 9.22255 3.99999 10.5573 3.99999 12.2609C3.99999 13.1275 4.29264 13.9078 4.49321 14.3607C4.60375 14.6102 4.71348 14.8196 4.79687 14.9689C4.83898 15.0444 4.87547 15.1065 4.9035 15.1529C4.91754 15.1762 4.92954 15.1957 4.93916 15.2111L4.94662 15.223L4.95178 15.2312ZM35.9868 18.996L24 38.22L12.0131 18.996C12.4661 19.1391 12.9179 19.2658 13.3617 19.3718C16.4281 20.1039 20.0901 20.5217 24 20.5217C27.9099 20.5217 31.5719 20.1039 34.6383 19.3718C35.082 19.2658 35.5339 19.1391 35.9868 18.996Z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-white">Driver Portal</h1>
            <p class="text-gray-400 text-sm" id="userEmail"></p>
        </div>

        <!-- Main Options -->
        <div class="w-full max-w-md mx-auto flex-1 py-8">
            <div class="features-grid portal-buttons">
                <!-- Expenses -->
                <div id="expensesCard" class="feature-button" onclick="handleFeatureClick('/pages/driver-expenses.html')">
                    <div class="spinner-wrapper">
                        <div class="spinner"></div>
                        <div class="spinner1">
                            <span class="material-symbols-outlined spinner-icon">receipt</span>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-white">Expenses</h3>
                </div>

                <!-- Wait Times -->
                <div id="waitTimesCard" class="feature-button" onclick="handleFeatureClick('/pages/driver-wait-times.html')">
                    <div class="spinner-wrapper">
                        <div class="spinner"></div>
                        <div class="spinner1">
                            <span class="material-symbols-outlined spinner-icon">schedule</span>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-white">Wait Times</h3>
                </div>

                <!-- Messages -->
                <div id="messagesCard" class="feature-button" onclick="window.location.href='/pages/driver-messages.html'">
                    <div class="spinner-wrapper">
                        <div class="spinner"></div>
                        <div class="spinner1">
                            <span class="material-symbols-outlined spinner-icon">message</span>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-white">Messages</h3>
                </div>

                <!-- Availability -->
                <div id="availabilityCard" class="feature-button" onclick="showAvailabilityComingSoon()">
                    <div class="spinner-wrapper">
                        <div class="spinner"></div>
                        <div class="spinner1">
                            <span class="material-symbols-outlined spinner-icon">event</span>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-white">Availability</h3>
                </div>
            </div>

            <!-- Account Buttons (hidden by default) -->
            <div class="account-buttons space-y-8" style="display: none;">
                <!-- Change Password -->
                <div class="features-grid-single">
                    <div class="feature-button" onclick="showChangePassword()">
                        <div class="spinner-wrapper">
                            <div class="spinner-orange"></div>
                            <div class="spinner1">
                                <span class="material-symbols-outlined spinner-icon">lock</span>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-white">Change Password</h3>
                    </div>
                </div>

                <!-- Logout -->
                <div class="features-grid-single">
                    <div class="feature-button" onclick="logout()">
                        <div class="spinner-wrapper">
                            <div class="spinner-red"></div>
                            <div class="spinner1">
                                <span class="material-symbols-outlined spinner-icon">logout</span>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-white">Logout</h3>
                    </div>
                </div>
            </div>

            <!-- Account/Home Button -->
            <div class="features-grid-single mt-8">
                <!-- Account Button -->
                <div class="account-button">
                    <div class="feature-button" onclick="toggleAccountView()">
                        <div class="spinner-wrapper">
                            <div class="spinner-orange"></div>
                            <div class="spinner1">
                                <span class="material-symbols-outlined spinner-icon">account_circle</span>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-white">Account</h3>
                    </div>
                </div>

                <!-- Home Button (hidden by default) -->
                <div class="home-button" style="display: none;">
                    <div class="feature-button" onclick="toggleAccountView()">
                        <div class="spinner-wrapper">
                            <div class="spinner"></div>
                            <div class="spinner1">
                                <span class="material-symbols-outlined spinner-icon">home</span>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-white">Home</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-500 text-xs">
            <p>SOTO Routes © 2025</p>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">Change Password</h2>
                <button onclick="hideChangePassword()" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
                <div class="space-y-4">
                    <div>
                        <label for="currentPassword" class="block text-sm font-medium text-gray-300 mb-2">Current Password</label>
                        <input 
                            type="password" 
                            id="currentPassword" 
                            required
                            class="w-full px-4 py-3 bg-[#1a1f24] border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 transition-colors"
                            placeholder="Enter current password"
                        />
                    </div>

                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-300 mb-2">New Password</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            required
                            minlength="6"
                            class="w-full px-4 py-3 bg-[#1a1f24] border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 transition-colors"
                            placeholder="Enter new password (min. 6 characters)"
                        />
                    </div>

                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            required
                            minlength="6"
                            class="w-full px-4 py-3 bg-[#1a1f24] border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-orange-500 transition-colors"
                            placeholder="Confirm new password"
                        />
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button 
                        type="button"
                        onclick="hideChangePassword()"
                        class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors font-medium"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        id="changePasswordBtn"
                        class="flex-1 px-4 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors font-medium"
                    >
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkXzYFC1jQcA6yw6qY1Ao3luEYU4Rd0yA",
            authDomain: "soto-routes.firebaseapp.com",
            projectId: "soto-routes",
            storageBucket: "soto-routes.firebasestorage.app",
            messagingSenderId: "440989695549",
            appId: "1:440989695549:web:0bce8b92a46f7f79953454",
            measurementId: "G-4E3G40QQ9L"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.functions = functions;
        window.firebase = {
            functions,
            httpsCallable
        };
        window.getDoc = getDoc;
        window.doc = doc;
        window.signOut = signOut;
        window.updatePassword = updatePassword;
        window.reauthenticateWithCredential = reauthenticateWithCredential;
        window.EmailAuthProvider = EmailAuthProvider;
        window.collection = collection;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        
        console.log('Firebase initialized successfully!');
        
        // Initialize the app after Firebase is ready
        initializeDriverPortal();
    </script>
    <script>
        let currentSession = null;
        let currentUser = null;
        const notifyError = (message, title = 'Error') => uiDialogs.showAlert({ title, message, tone: 'danger' });
        const notifyWarning = (message, title = 'Heads Up') => uiDialogs.showAlert({ title, message, tone: 'warning' });
        const notifySuccess = (message, title = 'Success') => uiDialogs.showAlert({ title, message, tone: 'success' });
        const notifyInfo = (message, title = 'Notice') => uiDialogs.showAlert({ title, message, tone: 'info' });

        const getCurrentOfficeId = () => currentSession?.officeId || currentUser?.officeId || null;

        // Initialize function
        async function initializeDriverPortal() {
            console.log('Initializing driver portal...');
            
            try {
                const session = await window.sotoSession.bootstrap(['driver']);
                if (!session) {
                        window.location.href = '/pages/soto-routes-login.html';
                    return;
                }

                currentSession = session;
                currentUser = { uid: session.uid, ...session };
                window.currentUser = currentUser; // Set for ExpenseUploadQueue
            } catch (error) {
                console.error('Failed to establish driver session:', error);
                window.location.href = '/pages/soto-routes-login.html';
                    return;
                }

                // Register Service Worker for PWA functionality and background uploads
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/js/sw.js', { scope: '/' });
                        console.log('[SW] Service Worker registered:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                    } catch (error) {
                        console.warn('[SW] Service Worker registration failed:', error);
                    }
                }

                // Check if running as PWA and show installation prompt if needed
                checkPWAInstallation();

                // Check for pending uploads and show banner if needed
                await checkPendingUploads();
                
                // Trigger Service Worker to process any pending uploads
                if (navigator.onLine && window.expenseUploadQueue) {
                    try {
                        await window.expenseUploadQueue.getAuthTokenAndProcessQueue();
                    } catch (error) {
                        console.warn('[Driver Portal] Failed to trigger upload processing:', error);
                    }
                }
                
                // Set up periodic status updates while uploading
                if (window.uploadStatusCheckInterval) {
                    clearInterval(window.uploadStatusCheckInterval);
                }
                window.uploadStatusCheckInterval = setInterval(async () => {
                    if (window.expenseUploadQueue && typeof window.expenseUploadQueue.updateGlobalUploadStatus === 'function') {
                        await window.expenseUploadQueue.updateGlobalUploadStatus();
                    }
                }, 3000); // Check every 3 seconds

                // Listen for Service Worker messages (auth token requests)
                if ('serviceWorker' in navigator && navigator.serviceWorker) {
                    navigator.serviceWorker.addEventListener('message', async (event) => {
                        const { type } = event.data || {};
                        if (type === 'get-auth-token') {
                            try {
                                const auth = window.auth;
                                if (auth && auth.currentUser) {
                                    const authToken = await auth.currentUser.getIdToken();
                                    if (event.ports && event.ports[0]) {
                                        event.ports[0].postMessage({ authToken });
                                    }
                                }
                            } catch (error) {
                                console.warn('[Driver Portal] Failed to get auth token for Service Worker:', error);
                            }
                        } else if (type === 'upload-status-changed') {
                            // Service Worker updated upload status, check again
                            checkPendingUploads();
                        }
                    });
                }

                try {
                console.log('Loading user data for:', currentUser.uid);
                const userDoc = await window.getDoc(window.doc(window.db, 'users', currentUser.uid));
                    if (!userDoc.exists()) {
                        console.log('User document not found');
                        window.location.href = '/pages/soto-routes-login.html';
                        return;
                    }

                currentUser = { ...currentUser, ...userDoc.data() };
                    console.log('Current user:', currentUser);
                    
                    // Only drivers can access this page
                    if (currentUser.role !== 'driver') {
                        notifyWarning('This page is for drivers only.', 'Access Denied');
                        window.location.href = '/pages/soto-lp.html';
                        return;
                    }

                    // Display user email
                    document.getElementById('userEmail').textContent = currentUser.email;
                    
                    // Check for unread messages and grey out features if needed
                    await checkAndDisableFeatures();
                    
                    document.getElementById('loadingOverlay').style.display = 'none';
                    console.log('Loading complete!');
                } catch (error) {
                    console.error('Error loading user data:', error);
                    notifyError('Error loading user data. Please try again.');
                }
        }

        // Check for unread messages and disable/grey out features
        async function checkAndDisableFeatures() {
            try {
                const officeId = getCurrentOfficeId();
                if (!officeId || !currentUser?.uid) {
                    console.warn('Missing office or user context for checkAndDisableFeatures.');
                    return;
                }

                // Check office active features
                let activeFeatures = {
                    expenses: true,
                    waitTimes: true,
                    messages: true,
                    availability: true
                };

                try {
                    const officeDocRef = window.doc(window.db, 'offices', officeId);
                    const officeDoc = await window.getDoc(officeDocRef);
                    if (officeDoc.exists()) {
                        const officeData = officeDoc.data();
                        if (officeData.activeFeatures) {
                            activeFeatures = officeData.activeFeatures;
                        }
                    }
                } catch (officeError) {
                    console.warn('Could not fetch office features:', officeError);
                }

                // Disable features based on office settings
                const expensesCard = document.getElementById('expensesCard');
                const waitTimesCard = document.getElementById('waitTimesCard');
                const messagesCard = document.getElementById('messagesCard');
                const availabilityCard = document.getElementById('availabilityCard');

                if (!activeFeatures.expenses && expensesCard) {
                    expensesCard.classList.add('disabled');
                    expensesCard.onclick = () => notifyInfo('Expenses feature is currently disabled for your office.', 'Feature Disabled');
                }

                if (!activeFeatures.waitTimes && waitTimesCard) {
                    waitTimesCard.classList.add('disabled');
                    waitTimesCard.onclick = () => notifyInfo('Wait Times feature is currently disabled for your office.', 'Feature Disabled');
                }

                if (!activeFeatures.messages && messagesCard) {
                    messagesCard.classList.add('disabled');
                    messagesCard.onclick = () => notifyInfo('Messages feature is currently disabled for your office.', 'Feature Disabled');
                }

                // Note: Availability always shows coming soon message, regardless of activeFeatures setting
                // The coming soon modal will handle the message display

                // Check for unread messages
                const messagesQuery = window.query(
                    window.collection(window.db, 'messages'),
                    window.where('officeId', '==', officeId),
                    window.where('published', '==', true)
                );
                const snapshot = await window.getDocs(messagesQuery);
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Get read messages from localStorage
                let readMessages = JSON.parse(localStorage.getItem('driver_read_messages') || '[]');
                
                // Also get read messages from Firebase (for persistence across devices/sessions)
                try {
                    const userDocRef = window.doc(window.db, 'users', currentUser.uid);
                    const userDoc = await window.getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const firebaseReadMessages = userData.readMessages || [];
                        // Merge Firebase read messages with localStorage (deduplicate)
                        readMessages = [...new Set([...readMessages, ...firebaseReadMessages])];
                        // Update localStorage with merged list
                        localStorage.setItem('driver_read_messages', JSON.stringify(readMessages));
                    }
                } catch (firebaseError) {
                    console.warn('Could not fetch read messages from Firebase, using localStorage only:', firebaseError);
                }
                
                const unreadMessages = messages.filter(msg => !readMessages.includes(msg.id));
                
                // Grey out features if there are unread messages (only if messages feature is enabled)
                // Note: Availability always shows coming soon, so don't disable it based on messages
                if (unreadMessages.length > 0 && activeFeatures.messages) {
                    if (expensesCard && activeFeatures.expenses) {
                        expensesCard.classList.add('disabled');
                    }
                    // Availability shows coming soon, don't disable it
                    if (waitTimesCard && activeFeatures.waitTimes) {
                        waitTimesCard.classList.add('disabled');
                    }
                }
            } catch (error) {
                console.error('Error checking messages:', error);
            }
        }

        // Handle feature card clicks
        async function handleFeatureClick(url, alertMessage = null) {
            // If it's wait times, just show info toast
            if (alertMessage) {
                notifyInfo(alertMessage);
                return;
            }
            
            // Check for unread messages immediately (no navigation)
            try {
                const officeId = getCurrentOfficeId();
                if (!officeId || !currentUser?.uid) {
                    window.location.href = url;
                    return;
                }

                const messagesQuery = window.query(
                    window.collection(window.db, 'messages'),
                    window.where('officeId', '==', officeId),
                    window.where('published', '==', true)
                );
                const snapshot = await window.getDocs(messagesQuery);
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Get read messages from localStorage
                let readMessages = JSON.parse(localStorage.getItem('driver_read_messages') || '[]');
                
                // Also get read messages from Firebase (for persistence across devices/sessions)
                try {
                    const userDocRef = window.doc(window.db, 'users', currentUser.uid);
                    const userDoc = await window.getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const firebaseReadMessages = userData.readMessages || [];
                        // Merge Firebase read messages with localStorage (deduplicate)
                        readMessages = [...new Set([...readMessages, ...firebaseReadMessages])];
                        // Update localStorage with merged list
                        localStorage.setItem('driver_read_messages', JSON.stringify(readMessages));
                    }
                } catch (firebaseError) {
                    console.warn('Could not fetch read messages from Firebase, using localStorage only:', firebaseError);
                }
                
                const unreadMessages = messages.filter(msg => !readMessages.includes(msg.id));
                
                if (unreadMessages.length > 0) {
                    notifyInfo('There are outstanding messages that need to be read before proceeding. Please read all messages first.', 'Unread Messages');
                    window.location.href = '/pages/driver-messages.html';
                    return;
                }
                
                // No unread messages, navigate normally
                window.location.href = url;
            } catch (error) {
                console.error('Error checking messages:', error);
                // If check fails, allow navigation
                if (url) {
                    window.location.href = url;
                }
            }
        }

        // Check for pending uploads and show/hide banner
        async function checkPendingUploads() {
            try {
                if (window.expenseUploadQueue) {
                    await window.expenseUploadQueue.updateGlobalUploadStatus();
                }
            } catch (error) {
                console.warn('[Driver Portal] Error checking pending uploads:', error);
            }
        }
        
        // Clean up interval when page unloads
        window.addEventListener('beforeunload', () => {
            if (window.uploadStatusCheckInterval) {
                clearInterval(window.uploadStatusCheckInterval);
            }
        });

        // Check if app is running as PWA and prompt installation if not
        function checkPWAInstallation() {
            // Only show for mobile and tablets, not desktops
            const userAgent = window.navigator.userAgent || window.navigator.vendor || window.opera;
            const isMobileOrTablet = /iPhone|iPod|iPad|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            if (!isMobileOrTablet) {
                // Desktop - don't show prompt
                return;
            }

            // Detect if running as PWA
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isIOSStandalone = window.navigator.standalone === true;
            const isPWAMode = isStandalone || isIOSStandalone;

            if (isPWAMode) {
                // Already running as PWA, no need to prompt
                return;
            }

            // Detect OS
            let os = 'desktop';
            let installInstructions = '';

            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                os = 'ios';
                installInstructions = `
                    <div class="space-y-4">
                        <p class="text-gray-300">To install SOTO Routes on your iPhone:</p>
                        <ol class="list-decimal list-inside space-y-2 text-gray-300 text-sm">
                            <li>Tap the <strong class="text-white">Share button</strong> <span class="material-symbols-outlined inline text-base">ios_share</span> at the bottom of your screen</li>
                            <li>Scroll down and tap <strong class="text-white">"Add to Home Screen"</strong></li>
                            <li>Tap <strong class="text-white">"Add"</strong> in the top right</li>
                        </ol>
                        <p class="text-gray-400 text-xs mt-4">Once installed, open SOTO Routes from your home screen for the best experience.</p>
                    </div>
                `;
            } else if (/android/i.test(userAgent)) {
                os = 'android';
                installInstructions = `
                    <div class="space-y-4">
                        <p class="text-gray-300">To install SOTO Routes on your Android device:</p>
                        <ol class="list-decimal list-inside space-y-2 text-gray-300 text-sm">
                            <li>Tap the <strong class="text-white">menu button</strong> <span class="material-symbols-outlined inline text-base">more_vert</span> in your browser</li>
                            <li>Tap <strong class="text-white">"Install app"</strong> or <strong class="text-white">"Add to Home screen"</strong></li>
                            <li>Tap <strong class="text-white">"Install"</strong> to confirm</li>
                        </ol>
                        <p class="text-gray-400 text-xs mt-4">Once installed, open SOTO Routes from your home screen for the best experience.</p>
                    </div>
                `;
            } else {
                os = 'desktop';
                installInstructions = `
                    <div class="space-y-4">
                        <p class="text-gray-300">To install SOTO Routes on your device:</p>
                        <ul class="list-disc list-inside space-y-2 text-gray-300 text-sm">
                            <li><strong class="text-white">Chrome/Edge:</strong> Click the install icon in the address bar, or use the menu → "Install SOTO Routes"</li>
                            <li><strong class="text-white">Safari:</strong> Use File → "Add to Dock" (Mac) or Share → "Add to Home Screen" (iOS)</li>
                        </ul>
                        <p class="text-gray-400 text-xs mt-4">Installing the app ensures you have all features and works offline.</p>
                    </div>
                `;
            }

            // Show installation prompt modal
            showPWAInstallPrompt(installInstructions);
        }

        // Show PWA installation prompt
        function showPWAInstallPrompt(instructions) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-75 z-[9999] flex items-center justify-center p-4';
            overlay.id = 'pwa-install-overlay';
            
            overlay.innerHTML = `
                <div class="bg-[#1a1f24] rounded-2xl w-full max-w-md border border-[#283039] shadow-2xl">
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-white text-2xl">warning</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Install SOTO Routes</h3>
                                <p class="text-sm text-gray-400">For full features and offline access</p>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-orange-400 font-semibold mb-3">⚠️ You're not running SOTO Routes correctly. You may have limited features.</p>
                            ${instructions}
                        </div>
                        
                        <div class="flex justify-end">
                            <button onclick="closePWAInstallPrompt()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-semibold">
                                I'll Install Later
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Close on overlay click (outside modal)
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closePWAInstallPrompt();
                }
            });
        }

        // Close PWA install prompt
        function closePWAInstallPrompt() {
            const overlay = document.getElementById('pwa-install-overlay');
            if (overlay) {
                overlay.remove();
            }
            // Always show again next time - prompt will appear every time driver portal opens
        }

        // Expose function to window for inline onclick handlers
        window.closePWAInstallPrompt = closePWAInstallPrompt;

        // Show Availability Coming Soon modal
        function showAvailabilityComingSoon() {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-75 z-[9999] flex items-center justify-center p-4';
            overlay.id = 'availability-coming-soon-overlay';
            
            overlay.innerHTML = `
                <div class="bg-[#1a1f24] rounded-2xl w-full max-w-md border-2 border-red-500 shadow-[0_0_20px_rgba(239,68,68,0.5)]">
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-white text-2xl">info</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Feature Coming Soon</h3>
                                <p class="text-sm text-gray-400">Availability Management</p>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-gray-300 text-base leading-relaxed">
                                This feature is still in development and will be rolled out soon.
                            </p>
                        </div>
                        
                        <div class="flex justify-end">
                            <button onclick="closeAvailabilityComingSoon()" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors font-semibold">
                                Got It
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Close on overlay click (outside modal)
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeAvailabilityComingSoon();
                }
            });
        }

        // Close Availability Coming Soon modal
        function closeAvailabilityComingSoon() {
            const overlay = document.getElementById('availability-coming-soon-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Expose function to window for inline onclick handlers
        window.closeAvailabilityComingSoon = closeAvailabilityComingSoon;

        // Toggle between portal and account view
        function toggleAccountView() {
            const mainContainer = document.querySelector('.min-h-screen');
            const portalButtons = document.querySelector('.portal-buttons');
            const accountButtons = document.querySelector('.account-buttons');
            const accountButton = document.querySelector('.account-button');
            const homeButton = document.querySelector('.home-button');

            if (mainContainer.classList.contains('account-view')) {
                // Switch to portal view
                mainContainer.classList.remove('account-view');
                mainContainer.classList.add('portal-view');
                if (portalButtons) portalButtons.style.display = 'grid';
                if (accountButtons) accountButtons.style.display = 'none';
                if (accountButton) accountButton.style.display = 'block';
                if (homeButton) homeButton.style.display = 'none';
            } else {
                // Switch to account view
                mainContainer.classList.remove('portal-view');
                mainContainer.classList.add('account-view');
                if (portalButtons) portalButtons.style.display = 'none';
                if (accountButtons) accountButtons.style.display = 'block';
                if (accountButton) accountButton.style.display = 'none';
                if (homeButton) homeButton.style.display = 'block';
            }
        }

        // Expose toggle function
        window.toggleAccountView = toggleAccountView;

        // Change Password functions
        function showChangePassword() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.classList.remove('hidden');
                const currentPasswordInput = document.getElementById('currentPassword');
                if (currentPasswordInput) {
                    setTimeout(() => currentPasswordInput.focus(), 100);
                }
            }
        }

        function hideChangePassword() {
            const modal = document.getElementById('changePasswordModal');
            const form = document.getElementById('changePasswordForm');
            if (modal) modal.classList.add('hidden');
            if (form) form.reset();
        }

        async function handleChangePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                notifyWarning('New passwords do not match.', 'Password Mismatch');
                return;
            }
            
            if (newPassword.length < 6) {
                notifyWarning('New password must be at least 6 characters long.', 'Weak Password');
                return;
            }
            
            const btn = document.getElementById('changePasswordBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Changing...';
            
            try {
                const user = window.auth.currentUser;
                if (!user || !user.email) {
                    notifyError('No user is currently signed in.', 'Authentication Required');
                    return;
                }
                
                // Re-authenticate user with current password
                const credential = window.EmailAuthProvider.credential(user.email, currentPassword);
                await window.reauthenticateWithCredential(user, credential);
                
                // Update password
                await window.updatePassword(user, newPassword);
                
                notifySuccess('Password changed successfully!', 'Password Updated');
                hideChangePassword();
                
            } catch (error) {
                console.error('Error changing password:', error);
                
                if (error.code === 'auth/wrong-password') {
                    notifyError('Current password is incorrect.', 'Incorrect Password');
                } else if (error.code === 'auth/weak-password') {
                    notifyWarning('New password is too weak. Please choose a stronger password.', 'Weak Password');
                } else if (error.code === 'auth/requires-recent-login') {
                    notifyWarning('Please log out and log back in, then try changing your password again.', 'Re-authentication Required');
                } else {
                    notifyError('Failed to change password. Please try again.', 'Error');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Expose functions to window
        window.showChangePassword = showChangePassword;
        window.hideChangePassword = hideChangePassword;
        window.handleChangePassword = handleChangePassword;

        // Logout function
        async function logout() {
            const confirmed = await showConfirmation({
                title: 'Logout',
                message: 'Are you sure you want to logout?',
                confirmText: 'Logout',
                cancelText: 'Cancel',
                tone: 'warning'
            });
            if (!confirmed) {
                return;
            }

            try {
                await window.signOut(window.auth);
            } catch (error) {
                console.warn('Firebase sign out failed:', error);
            } finally {
                window.sotoSession?.clearSession();
                window.location.href = '/pages/soto-routes-login.html';
            }
        }
    </script>
</body>
</html>
