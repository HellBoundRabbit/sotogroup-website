<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Options Demo - SOTO Routes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCkXzYFC1jQcA6yw6qY1Ao3luEYU4Rd0yA",
            authDomain: "soto-routes.firebaseapp.com",
            projectId: "soto-routes",
            storageBucket: "soto-routes.firebasestorage.app",
            messagingSenderId: "440989695549",
            appId: "1:440989695549:web:0bce8b92a46f7f79953454",
            measurementId: "G-4E3G40QQ9L"
        };
        
        const app = initializeApp(firebaseConfig);
        const functions = getFunctions(app);
        
        window.functions = functions;
        window.httpsCallable = httpsCallable;
        
        console.log('Firebase initialized successfully!');
    </script>
    <style>
        .route-card {
            transition: all 0.3s ease;
        }
        .route-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-[#0f1419] text-white min-h-screen" style='font-family: Inter, "Noto Sans", sans-serif;'>
    <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">üöï Travel Options Demo</h1>
            <p class="text-gray-400">Test the new taxi vs public transport routing system</p>
        </div>

        <!-- Test Input Section -->
        <div class="bg-[#1a1f24] rounded-lg p-6 mb-8 border border-[#283039]">
            <h2 class="text-xl font-bold mb-4">Test Travel Options</h2>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Driver Home Postcode</label>
                    <input 
                        type="text" 
                        id="driverHome" 
                        value="B77 5JA"
                        class="w-full px-3 py-2 bg-[#283039] border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., B77 5JA"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Collection A (First Job)</label>
                    <input 
                        type="text" 
                        id="collection" 
                        value="M1 4AN"
                        class="w-full px-3 py-2 bg-[#283039] border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., M1 4AN"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Delivery X (Last Job)</label>
                    <input 
                        type="text" 
                        id="delivery" 
                        value="LS1 4DY"
                        class="w-full px-3 py-2 bg-[#283039] border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., LS1 4DY"
                    >
                </div>
            </div>
            <button 
                onclick="testTravelOptions()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors"
            >
                Calculate Travel Options
            </button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <div class="grid grid-cols-2 gap-6 mb-8">
                <!-- Travel To Work -->
                <div class="bg-[#1a1f24] rounded-lg p-6 border border-[#283039]">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-symbols-outlined text-green-400">arrow_forward</span>
                        <h3 class="text-lg font-bold">To First Job</h3>
                    </div>
                    <div id="toWorkDetails" class="space-y-3"></div>
                </div>

                <!-- Travel From Work -->
                <div class="bg-[#1a1f24] rounded-lg p-6 border border-[#283039]">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-symbols-outlined text-blue-400">arrow_back</span>
                        <h3 class="text-lg font-bold">From Last Job</h3>
                    </div>
                    <div id="fromWorkDetails" class="space-y-3"></div>
                </div>
            </div>

            <!-- Route Score -->
            <div class="bg-[#1a1f24] rounded-lg p-6 border border-[#283039]">
                <h3 class="text-xl font-bold mb-4">Route Score & Summary</h3>
                <div id="scoreDetails" class="space-y-4"></div>
            </div>
        </div>

        <!-- Example Routes Demo -->
        <div class="mt-12">
            <h2 class="text-2xl font-bold mb-4">Example Route Cards</h2>
            <p class="text-gray-400 mb-6">Click "Generate Example Routes" to see how different travel options look</p>
            <button 
                onclick="generateExampleRoutes()"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-md transition-colors mb-6"
            >
                Generate Example Routes
            </button>
            <div id="exampleRoutes" class="grid grid-cols-3 gap-4"></div>
        </div>
    </div>

    <script>
        // Calculate travel score based on time and mode
        function calculateTravelScore(toWork, fromWork) {
            const totalMinutes = toWork.duration + fromWork.duration;
            const bothTaxi = toWork.mode === 'taxi' && fromWork.mode === 'taxi';
            const oneTaxi = (toWork.mode === 'taxi') !== (fromWork.mode === 'taxi');
            
            if (bothTaxi) return { score: 10, color: 'bg-green-600', label: 'Excellent' };
            if (oneTaxi && totalMinutes <= 45) return { score: 9, color: 'bg-green-500', label: 'Great' };
            if (oneTaxi && totalMinutes <= 60) return { score: 8, color: 'bg-green-400', label: 'Very Good' };
            if (totalMinutes <= 60) return { score: 7, color: 'bg-yellow-500', label: 'Good' };
            if (totalMinutes <= 90) return { score: 6, color: 'bg-yellow-600', label: 'Fair' };
            if (totalMinutes <= 120) return { score: 5, color: 'bg-orange-500', label: 'Acceptable' };
            if (totalMinutes <= 150) return { score: 4, color: 'bg-orange-600', label: 'Long' };
            if (totalMinutes <= 180) return { score: 3, color: 'bg-red-500', label: 'Very Long' };
            if (totalMinutes <= 210) return { score: 2, color: 'bg-red-600', label: 'Extreme' };
            return { score: 1, color: 'bg-red-700', label: 'Impractical' };
        }

        // Format travel option for display
        function formatTravelOption(option) {
            if (!option) {
                return '<div class="text-red-400">Error: No data received</div>';
            }
            
            if (option.mode === 'taxi') {
                return `
                    <div class="flex items-start gap-3 p-4 bg-[#283039] rounded-lg">
                        <span class="material-symbols-outlined text-yellow-400 text-3xl">local_taxi</span>
                        <div class="flex-1">
                            <div class="font-bold text-lg mb-1">üöï Taxi</div>
                            <div class="text-gray-300">${option.duration} minutes</div>
                            <div class="text-sm text-gray-400">${option.distance} miles</div>
                            ${option.warning ? `<div class="text-xs text-orange-400 mt-2">‚ö†Ô∏è ${option.warning}</div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                const transitStepsHTML = (option.transitSteps || []).map(step => `
                    <div class="flex items-center gap-2 text-sm">
                        <span class="material-symbols-outlined text-blue-400 text-sm">
                            ${step.mode === 'BUS' ? 'directions_bus' : 'train'}
                        </span>
                        <span class="text-gray-300">${step.line}</span>
                        <span class="text-gray-500">‚Ä¢</span>
                        <span class="text-gray-400">${step.duration}</span>
                    </div>
                `).join('');
                
                return `
                    <div class="flex items-start gap-3 p-4 bg-[#283039] rounded-lg">
                        <span class="material-symbols-outlined text-blue-400 text-3xl">directions_transit</span>
                        <div class="flex-1">
                            <div class="font-bold text-lg mb-1">üöå Public Transport</div>
                            <div class="text-gray-300 mb-2">${option.duration} minutes total</div>
                            <div class="space-y-1 mb-2">
                                ${transitStepsHTML}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${option.numTransfers || 0} transfer${option.numTransfers !== 1 ? 's' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Test travel options
        async function testTravelOptions() {
            const driverHome = document.getElementById('driverHome').value;
            const collection = document.getElementById('collection').value;
            const delivery = document.getElementById('delivery').value;
            
            if (!driverHome || !collection || !delivery) {
                alert('Please enter driver home, collection, and delivery addresses');
                return;
            }

            try {
                // Show loading
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('toWorkDetails').innerHTML = '<div class="text-gray-400">Calculating...</div>';
                document.getElementById('fromWorkDetails').innerHTML = '<div class="text-gray-400">Calculating...</div>';
                document.getElementById('scoreDetails').innerHTML = '<div class="text-gray-400">Calculating score...</div>';
                
                // Calculate travel to work (Driver Home ‚Üí Collection A)
                const calculateTravelOptions = window.httpsCallable(window.functions, 'calculateTravelOptions');
                const toWorkResult = await calculateTravelOptions({ origin: driverHome, destination: collection });
                const toWork = toWorkResult.data;
                
                console.log('To first job (Home ‚Üí Collection):', toWork);
                
                // Calculate travel from work (Delivery X ‚Üí Driver Home)
                const fromWorkResult = await calculateTravelOptions({ origin: delivery, destination: driverHome });
                const fromWork = fromWorkResult.data;
                
                console.log('From last job (Delivery ‚Üí Home):', fromWork);
                
                // Check if we got valid data
                if (!toWork || !toWork.success) {
                    throw new Error('Failed to get travel options for outbound journey: ' + (toWork?.error || 'Unknown error'));
                }
                if (!fromWork || !fromWork.success) {
                    throw new Error('Failed to get travel options for return journey: ' + (fromWork?.error || 'Unknown error'));
                }
                
                // Display results
                document.getElementById('toWorkDetails').innerHTML = formatTravelOption(toWork);
                document.getElementById('fromWorkDetails').innerHTML = formatTravelOption(fromWork);
                
                // Calculate and display score
                const scoreResult = calculateTravelScore(toWork, fromWork);
                document.getElementById('scoreDetails').innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="${scoreResult.color} text-white text-4xl font-bold rounded-lg w-20 h-20 flex items-center justify-center">
                            ${scoreResult.score}
                        </div>
                        <div class="flex-1">
                            <div class="text-2xl font-bold mb-1">${scoreResult.label}</div>
                            <div class="text-gray-400">
                                Total travel time: ${toWork.duration + fromWork.duration} minutes
                            </div>
                            <div class="text-sm text-gray-500 mt-2">
                                ${toWork.mode === 'taxi' ? 'üöï Taxi' : 'üöå Public transport'} to work, 
                                ${fromWork.mode === 'taxi' ? 'üöï Taxi' : 'üöå Public transport'} from work
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error calculating travel options:', error);
                document.getElementById('toWorkDetails').innerHTML = `<div class="text-red-400">Error: ${error.message}</div>`;
                document.getElementById('fromWorkDetails').innerHTML = `<div class="text-red-400">Check console for details</div>`;
                document.getElementById('scoreDetails').innerHTML = `<div class="text-red-400">Unable to calculate score</div>`;
            }
        }

        // Generate example routes
        function generateExampleRoutes() {
            const examples = [
                {
                    driver: 'John Smith',
                    location: 'B77 5JA',
                    route: 'Route 1',
                    jobs: 3,
                    toWork: { mode: 'taxi', duration: 12, distance: 8.5 },
                    fromWork: { mode: 'taxi', duration: 10, distance: 7.2 }
                },
                {
                    driver: 'Emma Wilson',
                    location: 'M1 4AN',
                    route: 'Route 2',
                    jobs: 5,
                    toWork: { mode: 'taxi', duration: 14, distance: 9.8 },
                    fromWork: { 
                        mode: 'transit', 
                        duration: 35, 
                        transitSteps: [
                            { mode: 'BUS', line: '47', duration: '15 mins' },
                            { mode: 'TRAIN', line: 'West Midlands', duration: '20 mins' }
                        ],
                        numTransfers: 1
                    }
                },
                {
                    driver: 'David Brown',
                    location: 'LS1 4DY',
                    route: 'Route 3',
                    jobs: 4,
                    toWork: { 
                        mode: 'transit', 
                        duration: 65,
                        transitSteps: [
                            { mode: 'BUS', line: '12A', duration: '25 mins' },
                            { mode: 'TRAIN', line: 'Northern', duration: '30 mins' },
                            { mode: 'BUS', line: '8', duration: '10 mins' }
                        ],
                        numTransfers: 2
                    },
                    fromWork: { 
                        mode: 'transit', 
                        duration: 58,
                        transitSteps: [
                            { mode: 'TRAIN', line: 'Northern', duration: '35 mins' },
                            { mode: 'BUS', line: '12A', duration: '23 mins' }
                        ],
                        numTransfers: 1
                    }
                }
            ];

            const routesHTML = examples.map(example => {
                const score = calculateTravelScore(example.toWork, example.fromWork);
                return `
                    <div class="route-card bg-[#1a1f24] rounded-lg p-3 border border-[#283039] relative">
                        <!-- Score Badge (same as before) -->
                        <div class="absolute top-2 right-2 ${score.color} text-white font-bold px-2 py-1 rounded text-xs">
                            ${score.score}
                        </div>

                        <!-- Route Header (same as before) -->
                        <div class="mb-3">
                            <h3 class="text-sm font-bold mb-1">${example.route}</h3>
                            <div class="text-xs text-gray-400">${example.jobs} jobs</div>
                        </div>

                        <!-- Driver Info (same as before) -->
                        <div class="flex gap-3 mb-3">
                            <div class="flex flex-col gap-1.5">
                                <label class="text-gray-400 font-medium text-xs">Driver</label>
                                <p class="text-white font-semibold text-xs">${example.driver}</p>
                            </div>
                            <div class="flex flex-col gap-1.5">
                                <label class="text-gray-400 font-medium text-xs">Driver's Location</label>
                                <p class="text-white font-semibold text-xs">${example.location}</p>
                            </div>
                        </div>

                        <!-- TO WORK: Replace Distance Bar -->
                        <div class="mt-3">
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-gray-400 font-medium text-xs">To First Job</label>
                            </div>
                            ${example.toWork.mode === 'taxi' ? `
                                <div class="bg-[#283039] rounded-lg px-3 py-2">
                                    <div class="flex items-center gap-2">
                                        <span class="material-symbols-outlined text-yellow-400" style="font-size: 16px;">local_taxi</span>
                                        <span class="text-white font-semibold text-sm">${example.toWork.duration} min</span>
                                        <span class="text-gray-400 text-xs">(${example.toWork.distance} mi)</span>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-[#283039] rounded-lg px-3 py-2 space-y-1">
                                    <div class="flex items-center gap-2">
                                        <span class="material-symbols-outlined text-blue-400" style="font-size: 16px;">directions_transit</span>
                                        <span class="text-white font-semibold text-sm">${example.toWork.duration} min</span>
                                    </div>
                                    ${example.toWork.transitSteps.map(step => `
                                        <div class="flex items-center gap-1.5 text-xs text-gray-400 ml-6">
                                            <span class="material-symbols-outlined" style="font-size: 12px;">
                                                ${step.mode === 'BUS' ? 'directions_bus' : 'train'}
                                            </span>
                                            <span>${step.line}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>

                        <!-- FROM WORK: Replace Distance Bar -->
                        <div class="mt-2">
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-gray-400 font-medium text-xs">From Last Job</label>
                            </div>
                            ${example.fromWork.mode === 'taxi' ? `
                                <div class="bg-[#283039] rounded-lg px-3 py-2">
                                    <div class="flex items-center gap-2">
                                        <span class="material-symbols-outlined text-yellow-400" style="font-size: 16px;">local_taxi</span>
                                        <span class="text-white font-semibold text-sm">${example.fromWork.duration} min</span>
                                        <span class="text-gray-400 text-xs">(${example.fromWork.distance} mi)</span>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-[#283039] rounded-lg px-3 py-2 space-y-1">
                                    <div class="flex items-center gap-2">
                                        <span class="material-symbols-outlined text-blue-400" style="font-size: 16px;">directions_transit</span>
                                        <span class="text-white font-semibold text-sm">${example.fromWork.duration} min</span>
                                    </div>
                                    ${example.fromWork.transitSteps.map(step => `
                                        <div class="flex items-center gap-1.5 text-xs text-gray-400 ml-6">
                                            <span class="material-symbols-outlined" style="font-size: 12px;">
                                                ${step.mode === 'BUS' ? 'directions_bus' : 'train'}
                                            </span>
                                            <span>${step.line}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('exampleRoutes').innerHTML = routesHTML;
        }

        // Make functions global
        window.testTravelOptions = testTravelOptions;
        window.generateExampleRoutes = generateExampleRoutes;
    </script>
</body>
</html>
