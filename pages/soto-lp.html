<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<title>SOTO Routes - Logistics Planner</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCkXzYFC1jQcA6yw6qY1Ao31uEYU4Rd0yA",
        authDomain: "soto-routes.firebaseapp.com",
        projectId: "soto-routes",
        storageBucket: "soto-routes.firebasestorage.app",
        messagingSenderId: "440989695549",
        appId: "1:440989695549:web:0bce8b92a46f7f79953454",
        measurementId: "G-4E3G40QQ9L"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Make Firebase available globally
    window.firebaseApp = app;
    window.firestore = db;
    window.firebaseCollection = collection;
    window.firebaseAddDoc = addDoc;
    window.firebaseGetDocs = getDocs;
    window.firebaseQuery = query;
    window.firebaseOrderBy = orderBy;
    window.firebaseLimit = limit;
    window.firebaseWhere = where;
    
    console.log('Firebase initialized successfully!');
</script>
<script>
// Wait for window to fully load before initializing Firebase
window.onload = async function() {
    console.log('Window loaded, checking Firebase...');
    
    // Check authentication first
    async function checkAuthentication() {
        try {
            // Check if user identity is stored in localStorage
            const storedUser = localStorage.getItem('soto_user_identity');
            if (!storedUser) {
                console.log('No user identity found, redirecting to login');
                window.location.href = '/pages/login.html';
                return false;
            }

            // Parse stored user identity
            const userIdentity = JSON.parse(storedUser);
            console.log('Found stored user identity:', userIdentity);
            
            console.log('Routes system initialized successfully');
            return true;
            
        } catch (error) {
            console.error('Authentication check failed:', error);
            window.location.href = '/pages/login.html';
            return false;
        }
    }

    // Wait for Firebase to be ready
    function waitForFirebaseReady() {
        const maxAttempts = 10;
        let attempts = 0;
        
        while (attempts < maxAttempts) {
            try {
                if (window.firestore && window.firebaseCollection) {
                    console.log('Firebase is ready!');
                    return true;
                }
            } catch (error) {
                console.log(`Firebase not ready yet, attempt ${attempts + 1}/${maxAttempts}`);
            }
            
            // Small synchronous delay
            const start = Date.now();
            while (Date.now() - start < 100) {
                // Busy wait for 100ms
            }
            attempts++;
        }
        
        console.error('Firebase failed to initialize after maximum attempts');
        return false;
    }

    // Initialize authentication
    const authSuccess = await checkAuthentication();
    if (!authSuccess) {
        return;
    }

    // Wait for Firebase to be ready
    const firebaseReady = waitForFirebaseReady();
    if (!firebaseReady) {
        console.error('Firebase is not available after window load');
        return;
    }

    console.log('Firebase initialization complete');
    
    // Initialize first route after Firebase is ready
    createNewRoute(1);
};
</script>
<style type="text/tailwindcss">
      :root {
        --primary-color: #0d7ff2;
        --success-color: #22c55e;
      }
      .glow {
        box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4);
      }
    </style>
</head>
<body class="bg-[#111418] text-white" style='font-family: Inter, "Noto Sans", sans-serif;'>
<div class="relative flex h-auto min-h-screen w-full flex-col dark group/design-root overflow-x-hidden">
<div class="flex h-full grow flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#283039] px-6 py-3">
<div class="flex items-center gap-4">
<div class="size-8 text-[var(--primary-color)]">
<svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M13.8261 17.4264C16.7203 18.1174 20.2244 18.5217 24 18.5217C27.7756 18.5217 31.2797 18.1174 34.1739 17.4264C36.9144 16.7722 39.9967 15.2331 41.3563 14.1648L24.8486 40.6391C24.4571 41.267 23.5429 41.267 23.1514 40.6391L6.64374 14.1648C8.00331 15.2331 11.0856 16.7722 13.8261 17.4264Z" fill="currentColor"></path>
<path clip-rule="evenodd" d="M39.998 12.236C39.9944 12.2537 39.9875 12.2845 39.9748 12.3294C39.9436 12.4399 39.8949 12.5741 39.8346 12.7175C39.8168 12.7597 39.7989 12.8007 39.7813 12.8398C38.5103 13.7113 35.9788 14.9393 33.7095 15.4811C30.9875 16.131 27.6413 16.5217 24 16.5217C20.3587 16.5217 17.0125 16.131 14.2905 15.4811C12.0012 14.9346 9.44505 13.6897 8.18538 12.8168C8.17384 12.7925 8.16216 12.767 8.15052 12.7408C8.09919 12.6249 8.05721 12.5114 8.02977 12.411C8.00356 12.3152 8.00039 12.2667 8.00004 12.2612C8.00004 12.261 8 12.2607 8.00004 12.2612C8.00004 12.2359 8.0104 11.9233 8.68485 11.3686C9.34546 10.8254 10.4222 10.2469 11.9291 9.72276C14.9242 8.68098 19.1919 8 24 8C28.8081 8 33.0758 8.68098 36.0709 9.72276C37.5778 10.2469 38.6545 10.8254 39.3151 11.3686C39.9006 11.8501 39.9857 12.1489 39.998 12.236ZM4.95178 15.2312L21.4543 41.6973C22.6288 43.5809 25.3712 43.5809 26.5457 41.6973L43.0534 15.223C43.0709 15.1948 43.0878 15.1662 43.104 15.1371L41.3563 14.1648C43.104 15.1371 43.1038 15.1374 43.104 15.1371L43.1051 15.135L43.1065 15.1325L43.1101 15.1261L43.1199 15.1082C43.1276 15.094 43.1377 15.0754 43.1497 15.0527C43.1738 15.0075 43.2062 14.9455 43.244 14.8701C43.319 14.7208 43.4196 14.511 43.5217 14.2683C43.6901 13.8679 44 13.0689 44 12.2609C44 10.5573 43.003 9.22254 41.8558 8.2791C40.6947 7.32427 39.1354 6.55361 37.385 5.94477C33.8654 4.72057 29.133 4 24 4C18.867 4 14.1346 4.72057 10.615 5.94478C8.86463 6.55361 7.30529 7.32428 6.14419 8.27911C4.99695 9.22255 3.99999 10.5573 3.99999 12.2609C3.99999 13.1275 4.29264 13.9078 4.49321 14.3607C4.60375 14.6102 4.71348 14.8196 4.79687 14.9689C4.83898 15.0444 4.87547 15.1065 4.9035 15.1529C4.91754 15.1762 4.92954 15.1957 4.93916 15.2111L4.94662 15.223L4.95178 15.2312ZM35.9868 18.996L24 38.22L12.0131 18.996C12.4661 19.1391 12.9179 19.2658 13.3617 19.3718C16.4281 20.1039 20.0901 20.5217 24 20.5217C27.9099 20.5217 31.5719 20.1039 34.6383 19.3718C35.082 19.2658 35.5339 19.1391 35.9868 18.996Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-xl font-bold">SOTO Routes</h2>
</div>
<nav class="flex flex-1 justify-center gap-2">
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="#" onclick="showDashboard()">Dashboard</a>
<a class="bg-[#283039] text-white text-sm font-medium rounded-md px-4 py-2" href="#">Routes</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="/pages/optimisation.html">Optimisation</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="#" onclick="showDrivers()">Drivers</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="#" onclick="showJobs()">Jobs</a>
<a class="text-sm font-medium rounded-md px-4 py-2 hover:bg-[#283039] transition-colors" href="#" onclick="showReports()">Reports</a>
</nav>
<div class="flex items-center gap-4">
<button class="flex items-center justify-center rounded-full h-10 w-10 bg-[#283039] hover:bg-[#3a444e] transition-colors" onclick="showNotifications()">
<span class="material-symbols-outlined text-xl">notifications</span>
</button>
<button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm" onclick="logout()">
Logout
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDevd-HNK-hCI6uo8erI-DVQkF2BKhqZ0ZAY0qf-E49wK_Eme1itzAv3OZQ8llueRr0JfYlmS9s0zJ1iZkEMovNFenOgEFVnmtKIQ6-Yty0sPAlp7F42lZf97BCZlS-X4oSH12C0DnPEaXrmNnX8gPV32TDFrCAQkoT-5vsSla2tL5Mu5BMnF37vCjaPVARHrMwp3QnHVpRCB_wtsJfmGdvPMIs27V2QfjKIZviBup9poMqsRtRRaTcW8FHMcFHXknCA_jokfbE9Ko");'></div>
</div>
</header>
<main class="flex-1 px-6 py-4">
<div class="max-w-6xl mx-auto">
<div class="flex justify-between items-center mb-4">
<h1 class="text-2xl font-bold tracking-tight">Create New Route</h1>
<button id="save-route-btn" class="flex items-center justify-center gap-2 min-w-[100px] h-8 px-4 rounded-md bg-[var(--primary-color)] text-white text-sm font-bold hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" onclick="saveRoute()">
<span class="material-symbols-outlined text-sm">save</span>
<span>Save Routes</span>
</button>
</div>
<!-- Routes Container -->
<div id="routes-container" class="space-y-4 pb-20">
    <!-- Routes will be dynamically created here -->
</div>
<!-- Job Details Input - Fixed to Bottom -->
<div class="fixed bottom-0 left-0 right-0 bg-[#1a1f24] border-t border-[#283039] p-4 z-50">
<div class="max-w-6xl mx-auto">
<div class="relative flex items-center gap-4">
<textarea class="form-input w-full rounded-md bg-[#283039] border border-[#3a444e] focus:ring-2 focus:ring-[var(--success-color)] focus:border-[var(--success-color)] h-8 placeholder:text-[#6b7f99] px-3 py-2 text-sm resize-none" id="job-details" placeholder="Paste job details here..."></textarea>
<button class="flex items-center justify-center gap-2 min-w-[80px] h-8 px-4 rounded-md bg-[var(--success-color)] text-white text-sm font-bold hover:opacity-90 transition-opacity" onclick="enterJobDetails()">
<span class="material-symbols-outlined text-sm">arrow_upward</span>
<span>Enter</span>
</button>
</div>
</div>
</div>
</div>
</main>
</div>
</div>

<script>
// Global variables accessible to all functions (declare first)
let activeJob = null;
let processingQueue = [];
let isProcessing = false;
let currentRouteId = 1;
let routes = {}; // Store route data
let minimizedRoutes = []; // Store minimized routes

// CloudKit will be initialized in window.onload event in the head section

// Navigation functions (placeholder for now)
function showDashboard() {
    alert('Dashboard feature coming soon!');
}

function showDrivers() {
    alert('Drivers feature coming soon!');
}

function showJobs() {
    alert('Jobs feature coming soon!');
}

function showReports() {
    alert('Reports feature coming soon!');
}

function showNotifications() {
    alert('Notifications feature coming soon!');
}

// Job selection functionality
function selectJob(jobNumber) {
    // Remove active state from all jobs first
    for (let i = 1; i <= 4; i++) {
        const jobElement = document.getElementById(`job-${i}`);
        const titleElement = jobElement.querySelector('h3');
        
        // Remove all active styling
        jobElement.classList.remove('glow');
        jobElement.style.borderColor = '';
        jobElement.style.border = '2px solid transparent';
        titleElement.textContent = `Job ${i}`;
        titleElement.className = 'text-sm font-bold';
        titleElement.style.color = '';
    }
    
    // Now set the selected job as active
    const selectedJobElement = document.getElementById(`job-${jobNumber}`);
    const selectedTitleElement = selectedJobElement.querySelector('h3');
    
    // Add active styling
    selectedJobElement.style.border = '2px solid #22c55e';
    selectedJobElement.classList.add('glow');
    selectedTitleElement.textContent = `Job ${jobNumber} (Active)`;
    selectedTitleElement.className = 'text-sm font-bold';
    selectedTitleElement.style.color = '#22c55e';
    
    activeJob = jobNumber;
}

// Enter job details
async function enterJobDetails() {
    const jobText = document.getElementById('job-details').value.trim();
    
    if (!jobText) {
        alert('Please enter job details before proceeding.');
        return;
    }

    if (!activeJob) {
        alert('Please click on a job panel first to select it');
        return;
    }

    // Immediately clear the input and show pending state
    document.getElementById('job-details').value = '';
    
    // Show pending in the active job panel
    const collectionElement = document.getElementById(`job-${activeJob.routeId}-${activeJob.jobNumber}-collection`);
    const deliveryElement = document.getElementById(`job-${activeJob.routeId}-${activeJob.jobNumber}-delivery`);
    const priceElement = document.getElementById(`job-${activeJob.routeId}-${activeJob.jobNumber}-price`);
    
    collectionElement.textContent = 'Pending...';
    deliveryElement.textContent = 'Pending...';
    priceElement.textContent = 'Pending...';

    // Add to processing queue
    processingQueue.push({
        routeId: activeJob.routeId,
        jobNumber: activeJob.jobNumber,
        jobText: jobText
    });

    // Start processing if not already running
    if (!isProcessing) {
        processQueue();
    }

    // Update save button state
    updateSaveButtonState();
}

// Process the queue
async function processQueue() {
    if (isProcessing || processingQueue.length === 0) {
        return;
    }

    isProcessing = true;
    updateSaveButtonState();

    while (processingQueue.length > 0) {
        const job = processingQueue.shift();
        
        try {
            // Show processing state
            const collectionElement = document.getElementById(`job-${job.routeId}-${job.jobNumber}-collection`);
            const deliveryElement = document.getElementById(`job-${job.routeId}-${job.jobNumber}-delivery`);
            const priceElement = document.getElementById(`job-${job.routeId}-${job.jobNumber}-price`);
            
            collectionElement.textContent = 'Processing...';
            deliveryElement.textContent = 'Processing...';
            priceElement.textContent = 'Processing...';

            // Call AI API to parse the job text
            const response = await fetch('/api/soto-lp/add-job', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    day_number: 1,
                    job_number: job.jobNumber,
                    raw_text: job.jobText
                })
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            const result = await response.json();
            console.log('Full API response:', result);
            
            if (result.success) {
                // Debug: Log the parsed data to see if confidence scores are included
                console.log('Parsed data received:', result.parsed_data);
                
                // Update the job display with parsed data
                updateJobDisplay(job.routeId, job.jobNumber, result.parsed_data);
            } else {
                // Show error state
                collectionElement.textContent = 'Error processing';
                deliveryElement.textContent = 'Error processing';
                priceElement.textContent = 'Error processing';
            }
        } catch (error) {
            console.error('Error processing job:', error);
            console.error('Error details:', {
                message: error.message,
                stack: error.stack,
                jobNumber: job.jobNumber,
                jobText: job.jobText
            });
            
            // Show error state
            const collectionElement = document.getElementById(`job-${job.routeId}-${job.jobNumber}-collection`);
            const deliveryElement = document.getElementById(`job-${job.routeId}-${job.jobNumber}-delivery`);
            const priceElement = document.getElementById(`job-${job.routeId}-${job.jobNumber}-price`);
            
            collectionElement.textContent = 'Error processing';
            deliveryElement.textContent = 'Error processing';
            priceElement.textContent = 'Error processing';
        }
    }

    isProcessing = false;
    updateSaveButtonState();
}

// Update save button state
function updateSaveButtonState() {
    const saveButton = document.querySelector('button[onclick="saveRoute()"]');
    if (isProcessing || processingQueue.length > 0) {
        saveButton.disabled = true;
        saveButton.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        saveButton.disabled = false;
        saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

function updateJobDisplay(routeId, jobNumber, parsedData) {
    console.log(`Updating job ${routeId}-${jobNumber} display with data:`, parsedData);
    
    const collectionElement = document.getElementById(`job-${routeId}-${jobNumber}-collection`);
    const deliveryElement = document.getElementById(`job-${routeId}-${jobNumber}-delivery`);
    const priceElement = document.getElementById(`job-${routeId}-${jobNumber}-price`);
    
    // Check if elements exist (route might be minimized)
    if (collectionElement && deliveryElement && priceElement) {
        // Update content
        collectionElement.textContent = parsedData.collection_address || 'Not found';
        deliveryElement.textContent = parsedData.delivery_address || 'Not found';
        
        // Format and color-code the price
        const price = parsedData.price || 0;
        priceElement.textContent = `£${price.toFixed(2)}`;
        
        // Apply color coding based on price
        priceElement.className = 'font-semibold text-sm';
        if (price <= 90) {
            priceElement.classList.add('text-red-400');
        } else if (price <= 130) {
            priceElement.classList.add('text-orange-400');
        } else {
            priceElement.classList.add('text-green-400');
        }
        
        // Add confidence indicators if available
        console.log('Checking for confidence data:', {
            hasConfidenceScores: !!parsedData.confidence_scores,
            hasAccuracyRating: !!parsedData.accuracy_rating,
            confidenceScores: parsedData.confidence_scores,
            accuracyRating: parsedData.accuracy_rating
        });
        
        if (parsedData.confidence_scores || parsedData.accuracy_rating) {
            console.log('Adding confidence indicators for job', routeId, jobNumber);
            addConfidenceIndicators(routeId, jobNumber, parsedData);
        } else {
            console.log('No confidence data found for job', routeId, jobNumber);
        }
    } else {
        console.log(`Job elements not found for ${routeId}-${jobNumber}, route may be minimized`);
    }
    
    // Always update minimized route if it exists (this handles the case where route is minimized)
    updateMinimizedRoute(routeId, jobNumber, parsedData);
}

function updateMinimizedRoute(routeId, jobNumber, parsedData) {
    // Check if this route is minimized
    const minimizedBar = document.querySelector(`.minimized-route[data-route-id="${routeId}"]`);
    if (!minimizedBar) {
        return; // Route is not minimized
    }
    
    // Find the route data in minimizedRoutes array
    const routeData = minimizedRoutes.find(r => r.id === routeId);
    if (!routeData) {
        return;
    }
    
    // If we have parsed data, update the specific job in the stored data
    if (parsedData && jobNumber) {
        const jobIndex = routeData.jobs.findIndex(job => job.jobNumber === jobNumber);
        if (jobIndex !== -1) {
            // Update the existing job with parsed data
            routeData.jobs[jobIndex] = {
                jobNumber,
                collection: parsedData.collection_address || 'Not found',
                delivery: parsedData.delivery_address || 'Not found',
                price: `£${(parsedData.price || 0).toFixed(2)}`
            };
        } else {
            // Add new job if it doesn't exist
            routeData.jobs.push({
                jobNumber,
                collection: parsedData.collection_address || 'Not found',
                delivery: parsedData.delivery_address || 'Not found',
                price: `£${(parsedData.price || 0).toFixed(2)}`
            });
        }
    } else {
        // Fallback: get current job data from DOM (if route is still active)
        const activeRouteContainer = document.querySelector(`[data-route-id="${routeId}"]`);
        if (activeRouteContainer) {
            const currentJobs = [];
            const jobPanels = activeRouteContainer.querySelectorAll('.job-panel');
            jobPanels.forEach((panel, index) => {
                const jobNum = index + 1;
                const collection = panel.querySelector(`#job-${routeId}-${jobNum}-collection`)?.textContent || '';
                const delivery = panel.querySelector(`#job-${routeId}-${jobNum}-delivery`)?.textContent || '';
                const price = panel.querySelector(`#job-${routeId}-${jobNum}-price`)?.textContent || '';
                
                // Add jobs that have meaningful data OR are currently processing
                const hasData = collection && 
                               delivery && 
                               price && 
                               collection !== 'Waiting for details...' && 
                               delivery !== 'Waiting for details...' && 
                               price !== '-';
                
                const isProcessing = collection === 'Processing...' || 
                                    delivery === 'Processing...' || 
                                    price === 'Processing...';
                
                if (hasData || isProcessing) {
                    currentJobs.push({
                        jobNumber: jobNum,
                        collection,
                        delivery,
                        price
                    });
                }
            });
            routeData.jobs = currentJobs;
        }
    }
    
    // Recreate the job route display
    const jobRoutes = routeData.jobs.map(job => {
        // Handle processing states
        if (job.collection === 'Processing...' || job.delivery === 'Processing...') {
            return `
                <div class="flex items-center justify-center gap-2 text-sm">
                    <span class="text-[#9cabba]">Processing...</span>
                    <span class="material-symbols-outlined text-[var(--success-color)] text-sm">arrow_forward</span>
                    <span class="text-[#9cabba]">Processing...</span>
                </div>
            `;
        }
        
        // Extract postcodes from addresses (assuming they're at the start)
        const collectionPostcode = job.collection.split(',')[0].trim();
        const deliveryPostcode = job.delivery.split(',')[0].trim();
        
        return `
            <div class="flex items-center justify-center gap-2 text-sm">
                <span class="text-[#9cabba]">${collectionPostcode}</span>
                <span class="material-symbols-outlined text-[var(--success-color)] text-sm">arrow_forward</span>
                <span class="text-[#9cabba]">${deliveryPostcode}</span>
            </div>
        `;
    }).join('');
    
    // Update the minimized bar content
    minimizedBar.innerHTML = `
        <div class="flex items-center justify-between gap-4">
            <span class="text-base font-bold">Route ${routeId}</span>
            <div class="flex flex-col gap-0.5">
                ${jobRoutes}
            </div>
        </div>
    `;
}

function addConfidenceIndicators(routeId, jobNumber, parsedData) {
    console.log(`Adding confidence indicators for job ${routeId}-${jobNumber}:`, parsedData);
    
    const jobElement = document.getElementById(`job-${routeId}-${jobNumber}`);
    if (!jobElement) {
        console.error(`Job element not found for job ${routeId}-${jobNumber}`);
        return;
    }
    
    // Remove existing confidence indicators
    const existingConfidence = jobElement.querySelector('.confidence-indicator');
    if (existingConfidence) {
        console.log('Removing existing confidence indicators');
        existingConfidence.remove();
    }
    
    // Overall accuracy rating
    const accuracyRating = parsedData.accuracy_rating || 'unknown';
    
    let accuracyColor = 'text-gray-400';
    let accuracyIcon = '❓';
    
    switch (accuracyRating) {
        case 'excellent':
            accuracyColor = 'text-green-400';
            accuracyIcon = '✅';
            break;
        case 'good':
            accuracyColor = 'text-blue-400';
            accuracyIcon = '👍';
            break;
        case 'fair':
            accuracyColor = 'text-yellow-400';
            accuracyIcon = '⚠️';
            break;
        case 'poor':
            accuracyColor = 'text-red-400';
            accuracyIcon = '❌';
            break;
    }
    
    // Create confidence indicator for top right corner
    const confidenceIndicator = document.createElement('div');
    confidenceIndicator.className = 'confidence-indicator absolute top-2 right-2 text-lg';
    confidenceIndicator.innerHTML = `<span class="${accuracyColor}">${accuracyIcon}</span>`;
    confidenceIndicator.title = `AI Accuracy: ${accuracyRating.toUpperCase()}`;
    
    // Make sure the job element has relative positioning
    jobElement.classList.add('relative');
    
    // Add to job element
    jobElement.appendChild(confidenceIndicator);
    console.log('Confidence indicator added to top right corner for job', routeId, jobNumber);
}

async function saveRoute() {
    // Don't allow saving while processing
    if (isProcessing || processingQueue.length > 0) {
        alert('Please wait for all jobs to finish processing before saving.');
        return;
    }

    // Show loading state on save button
    const saveButton = document.querySelector('button[onclick="saveRoute()"]');
    const originalText = saveButton ? saveButton.innerHTML : '';
    if (saveButton) {
        saveButton.innerHTML = '<span class="animate-spin">⟳</span> Saving...';
        saveButton.disabled = true;
    }

    try {
        // Check if Firebase is available
        if (!window.firestore || !window.firebaseCollection) {
            throw new Error('Firebase is not initialized. Please refresh the page and try again.');
        }

        // Get all processed jobs from the UI
        const jobs = [];
        for (let i = 1; i <= 4; i++) {
            const collectionElement = document.getElementById(`job-${i}-collection`);
            const deliveryElement = document.getElementById(`job-${i}-delivery`);
            const priceElement = document.getElementById(`job-${i}-price`);
            
            // Only include jobs that have been processed (not "Waiting for details...")
            if (collectionElement && collectionElement.textContent !== 'Waiting for details...' && 
                deliveryElement && deliveryElement.textContent !== 'Waiting for details...') {
                
                // Extract postcodes from addresses (simple extraction)
                const collectionAddress = collectionElement.textContent;
                const deliveryAddress = deliveryElement.textContent;
                const price = parseFloat(priceElement.textContent.replace('£', '').replace(',', '')) || 0;
                
                // Extract postcodes using regex
                const postcodeRegex = /\b[A-Z]{1,2}[0-9R][0-9A-Z]? [0-9][A-Z]{2}\b/g;
                const collectionPostcodes = collectionAddress.match(postcodeRegex) || [];
                const deliveryPostcodes = deliveryAddress.match(postcodeRegex) || [];
                
                jobs.push({
                    jobNumber: i,
                    collectionAddress: collectionAddress,
                    deliveryAddress: deliveryAddress,
                    collectionPostcode: collectionPostcodes[0] || '',
                    deliveryPostcode: deliveryPostcodes[0] || '',
                    price: price,
                    distance: 0, // Will be calculated later
                    duration: 0, // Will be calculated later
                    notes: '',
                    isCompleted: false
                });
            }
        }
        
        if (jobs.length === 0) {
            alert('No jobs to save. Please process some jobs first.');
            return;
        }
        
        // Save route to Firebase
        const routeId = `route_${Date.now()}`;
        const createdAt = new Date();
        
        console.log('Saving route to Firebase:', jobs);
        
        // Create route data for Firebase
        const routeData = {
            routeId: routeId,
            userId: 'default_user',
            routeName: jobs[0].deliveryAddress,
            driverName: 'Auto-Assigned',
            driverLocation: 'TBD',
            totalJobs: jobs.length,
            totalDistance: 0,
            estimatedDuration: 0,
            status: 'pending',
            createdAt: createdAt,
            updatedAt: createdAt
        };
        
        // Save route to Firebase
        const routeRef = await window.firebaseAddDoc(
            window.firebaseCollection(window.firestore, 'routes'), 
            routeData
        );
        
        console.log('Route saved with ID:', routeRef.id);
        
        // Save each job to Firebase
        for (const job of jobs) {
            const jobData = {
                routeId: routeId,
                jobNumber: job.jobNumber,
                collectionAddress: job.collectionAddress,
                deliveryAddress: job.deliveryAddress,
                collectionPostcode: job.collectionPostcode,
                deliveryPostcode: job.deliveryPostcode,
                price: job.price,
                distance: job.distance,
                duration: job.duration,
                notes: job.notes,
                isCompleted: job.isCompleted,
                createdAt: createdAt
            };
            
            await window.firebaseAddDoc(
                window.firebaseCollection(window.firestore, 'jobs'), 
                jobData
            );
        }
        
        console.log('All jobs saved to Firebase');
        
        // Clear the input
        document.getElementById('job-details').value = '';
        
        // Reset all job displays
        for (let i = 1; i <= 4; i++) {
            resetJobDisplay(1, i);
        }
        
        // Reset to no job selected
        activeJob = null;
        
        // Clear the queue
        processingQueue = [];
        isProcessing = false;
        updateSaveButtonState();
        
        alert('Route saved successfully to Firebase!');
        
    } catch (error) {
        console.error('Error saving route:', error);
        alert('Error saving route: ' + error.message + '\n\nCheck browser console for more details.');
    } finally {
        // Restore save button state
        if (saveButton) {
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        }
    }
}

function resetJobDisplay(routeId, jobNumber) {
    const collectionElement = document.getElementById(`job-${routeId}-${jobNumber}-collection`);
    const deliveryElement = document.getElementById(`job-${routeId}-${jobNumber}-delivery`);
    const priceElement = document.getElementById(`job-${routeId}-${jobNumber}-price`);
    
    // Reset content
    collectionElement.textContent = 'Waiting for details...';
    deliveryElement.textContent = 'Waiting for details...';
    priceElement.textContent = '-';
    
    // Reset styling
    priceElement.className = 'font-semibold text-sm';
    if (jobNumber > 2) {
        priceElement.classList.add('text-[var(--primary-color)]/50');
    }
}

// Add keyboard shortcut for Enter key
document.getElementById('job-details').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        enterJobDetails();
    }
});

// Logout function
async function logout() {
    try {
        // Clear stored user identity
        localStorage.removeItem('soto_user_identity');
        
        console.log('User logged out successfully');
        
        // Redirect to login page
        window.location.href = '/pages/login.html';
        
    } catch (error) {
        console.error('Logout error:', error);
        // Even if logout fails, clear localStorage and redirect
        localStorage.removeItem('soto_user_identity');
        window.location.href = '/pages/login.html';
    }
}

// New workflow functions
function createJobPanel(routeId, jobNumber, isActive = false) {
    const jobPanel = document.createElement('div');
    jobPanel.className = `job-panel bg-[#1a1f24] rounded-lg p-2 flex flex-col gap-1 cursor-pointer border-2 transition-all duration-300 relative`;
    
    if (isActive) {
        jobPanel.classList.add('border-[var(--success-color)]', 'glow');
    } else {
        jobPanel.classList.add('border-transparent', 'hover:border-[#3a444e]');
    }
    
    jobPanel.id = `job-${routeId}-${jobNumber}`;
    jobPanel.onclick = () => selectJob(routeId, jobNumber);
    
    jobPanel.innerHTML = `
        <h3 class="text-xs font-bold ${isActive ? 'text-[var(--success-color)]' : ''}">Job ${jobNumber}</h3>
        <div class="bg-[#283039] rounded-lg p-1">
            <h4 class="text-xs font-medium text-[#9cabba] mb-0">Collection Address</h4>
            <p class="font-semibold text-white text-xs" id="job-${routeId}-${jobNumber}-collection">Waiting for details...</p>
        </div>
        <div class="bg-[#283039] rounded-lg p-1">
            <h4 class="text-xs font-medium text-[#9cabba] mb-0">Delivery Address</h4>
            <p class="font-semibold text-white text-xs" id="job-${routeId}-${jobNumber}-delivery">Waiting for details...</p>
        </div>
        <div class="bg-[#283039] rounded-lg p-1">
            <h4 class="text-xs font-medium text-[#9cabba] mb-0">Job Price</h4>
            <p class="font-semibold text-xs" id="job-${routeId}-${jobNumber}-price">-</p>
        </div>
    `;
    
    return jobPanel;
}

function addJobPanel(routeId) {
    const jobPanelsContainer = document.getElementById(`job-panels-${routeId}`);
    const addJobBtn = document.getElementById(`add-job-btn-${routeId}`);
    const job3Panel = document.getElementById(`job-${routeId}-3`);
    
    if (!jobPanelsContainer) return;
    
    if (job3Panel && job3Panel.classList.contains('hidden')) {
        // Show the third job panel
        job3Panel.classList.remove('hidden');
        jobPanelsContainer.classList.remove('grid-cols-2');
        jobPanelsContainer.classList.add('grid-cols-3');
        addJobBtn.classList.add('hidden');
    }
}

function selectJob(routeId, jobNumber) {
    // Remove active state from all job panels in this route
    const jobPanelsContainer = document.getElementById(`job-panels-${routeId}`);
    if (jobPanelsContainer) {
        jobPanelsContainer.querySelectorAll('.job-panel').forEach(panel => {
            panel.classList.remove('border-[var(--success-color)]', 'glow');
            panel.classList.add('border-transparent', 'hover:border-[#3a444e]');
            panel.querySelector('h3').classList.remove('text-[var(--success-color)]');
        });
    }
    
    // Add active state to selected job
    const selectedJob = document.getElementById(`job-${routeId}-${jobNumber}`);
    if (selectedJob) {
        selectedJob.classList.add('border-[var(--success-color)]', 'glow');
        selectedJob.classList.remove('border-transparent', 'hover:border-[#3a444e]');
        selectedJob.querySelector('h3').classList.add('text-[var(--success-color)]');
        activeJob = { routeId, jobNumber };
    }
}

function nextRoute() {
    // Minimize current route
    minimizeRoute(currentRouteId);
    
    // Create new route
    currentRouteId++;
    createNewRoute(currentRouteId);
}

function minimizeRoute(routeId) {
    const routeContainer = document.querySelector(`[data-route-id="${routeId}"]`);
    if (!routeContainer) return;
    
    // Store route data
    const routeData = {
        id: routeId,
        jobs: [],
        minimized: true
    };
    
    // Collect job data
    const jobPanels = routeContainer.querySelectorAll('.job-panel');
    jobPanels.forEach((panel, index) => {
        const jobNumber = index + 1;
        const collection = panel.querySelector(`#job-${routeId}-${jobNumber}-collection`)?.textContent || '';
        const delivery = panel.querySelector(`#job-${routeId}-${jobNumber}-delivery`)?.textContent || '';
        const price = panel.querySelector(`#job-${routeId}-${jobNumber}-price`)?.textContent || '';
        
        // Add jobs that have meaningful data OR are currently processing
        const hasData = collection && 
                       delivery && 
                       price && 
                       collection !== 'Waiting for details...' && 
                       delivery !== 'Waiting for details...' && 
                       price !== '-';
        
        const isProcessing = collection === 'Processing...' || 
                            delivery === 'Processing...' || 
                            price === 'Processing...';
        
        if (hasData || isProcessing) {
            routeData.jobs.push({
                jobNumber,
                collection,
                delivery,
                price
            });
        }
    });
    
    // Create minimized route bar
    const minimizedBar = document.createElement('div');
    minimizedBar.className = 'minimized-route bg-[#1a1f24] rounded-lg p-2 border border-[#283039] cursor-pointer hover:bg-[#283039] transition-colors';
    minimizedBar.setAttribute('data-route-id', routeId);
    
    // Create job route display (collection → delivery)
    const jobRoutes = routeData.jobs.map(job => {
        // Handle processing states
        if (job.collection === 'Processing...' || job.delivery === 'Processing...') {
            return `
                <div class="flex items-center justify-center gap-2 text-sm">
                    <span class="text-[#9cabba]">Processing...</span>
                    <span class="material-symbols-outlined text-[var(--success-color)] text-sm">arrow_forward</span>
                    <span class="text-[#9cabba]">Processing...</span>
                </div>
            `;
        }
        
        // Extract postcodes from addresses (assuming they're at the start)
        const collectionPostcode = job.collection.split(',')[0].trim();
        const deliveryPostcode = job.delivery.split(',')[0].trim();
        
        return `
            <div class="flex items-center justify-center gap-2 text-sm">
                <span class="text-[#9cabba]">${collectionPostcode}</span>
                <span class="material-symbols-outlined text-[var(--success-color)] text-sm">arrow_forward</span>
                <span class="text-[#9cabba]">${deliveryPostcode}</span>
            </div>
        `;
    }).join('');
    
    minimizedBar.innerHTML = `
        <div class="flex items-center justify-between gap-4">
            <span class="text-base font-bold">Route ${routeId}</span>
            <div class="flex flex-col gap-0.5">
                ${jobRoutes}
            </div>
        </div>
    `;
    
    minimizedBar.onclick = () => expandRoute(routeId);
    
    // Replace route container with minimized bar
    routeContainer.parentNode.insertBefore(minimizedBar, routeContainer);
    routeContainer.remove();
    
    // Store minimized route data
    minimizedRoutes.push(routeData);
}

function expandRoute(routeId) {
    // Find minimized route data
    const routeData = minimizedRoutes.find(r => r.id === routeId);
    if (!routeData) return;
    
    // Remove minimized bar
    const minimizedBar = document.querySelector(`.minimized-route`);
    if (minimizedBar) {
        minimizedBar.remove();
    }
    
    // Create expanded route
    createNewRoute(routeId, routeData);
    
    // Remove from minimized routes
    minimizedRoutes = minimizedRoutes.filter(r => r.id !== routeId);
}

function createNewRoute(routeId, existingData = null) {
    const routesContainer = document.getElementById('routes-container');
    
    const routeContainer = document.createElement('div');
    routeContainer.className = 'route-container';
    routeContainer.setAttribute('data-route-id', routeId);
    
    const jobPanelsContainer = document.createElement('div');
    jobPanelsContainer.className = 'flex-grow grid grid-cols-2 gap-4 transition-all duration-300';
    jobPanelsContainer.id = `job-panels-${routeId}`;
    
    // Create job panels
    const job1Panel = createJobPanel(routeId, 1, true); // First job is active by default
    const job2Panel = createJobPanel(routeId, 2);
    const job3Panel = createJobPanel(routeId, 3);
    job3Panel.classList.add('hidden');
    
    jobPanelsContainer.appendChild(job1Panel);
    jobPanelsContainer.appendChild(job2Panel);
    jobPanelsContainer.appendChild(job3Panel);
    
    const addJobBtn = document.createElement('button');
    addJobBtn.className = 'flex-shrink-0 flex items-center justify-center w-12 h-12 rounded-full bg-[#283039] hover:bg-[#3a444e] transition-colors mt-auto mb-auto';
    addJobBtn.id = `add-job-btn-${routeId}`;
    addJobBtn.onclick = () => addJobPanel(routeId);
    addJobBtn.innerHTML = '<span class="material-symbols-outlined text-2xl">arrow_forward_ios</span>';
    
    const routeRow = document.createElement('div');
    routeRow.className = 'flex items-start gap-4';
    routeRow.id = `route-container-${routeId}`;
    routeRow.appendChild(jobPanelsContainer);
    routeRow.appendChild(addJobBtn);
    
    const nextRouteBtn = document.createElement('button');
    nextRouteBtn.className = 'w-full h-8 px-4 rounded-md bg-[#283039] text-white text-sm font-bold hover:bg-[#3a444e] transition-colors';
    nextRouteBtn.onclick = nextRoute;
    nextRouteBtn.textContent = 'Next Route';
    
    const nextRouteContainer = document.createElement('div');
    nextRouteContainer.className = 'mt-4';
    nextRouteContainer.appendChild(nextRouteBtn);
    
    routeContainer.appendChild(routeRow);
    routeContainer.appendChild(nextRouteContainer);
    
    routesContainer.appendChild(routeContainer);
    
    // Set active job and update current route ID
    activeJob = { routeId, jobNumber: 1 };
    currentRouteId = routeId;
    
    // Restore existing data if provided
    if (existingData) {
        existingData.jobs.forEach(job => {
            const collectionEl = document.getElementById(`job-${routeId}-${job.jobNumber}-collection`);
            const deliveryEl = document.getElementById(`job-${routeId}-${job.jobNumber}-delivery`);
            const priceEl = document.getElementById(`job-${routeId}-${job.jobNumber}-price`);
            
            if (collectionEl) collectionEl.textContent = job.collection;
            if (deliveryEl) deliveryEl.textContent = job.delivery;
            if (priceEl) priceEl.textContent = job.price;
        });
    }
}

// Route initialization is now handled in window.onload after Firebase is ready

// Make functions globally available
window.updateJobDisplay = updateJobDisplay;
window.addConfidenceIndicators = addConfidenceIndicators;
window.addJobPanel = addJobPanel;
window.selectJob = selectJob;
window.nextRoute = nextRoute;
</script>
</body>
</html>